<!DOCTYPE html>
<html>
<head>
Â  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
Â  <style>
Â  Â  body { margin: 0; padding: 0; background: #111; font-family: Arial, sans-serif; color: white; }
Â  Â  .swiper { width: 100vw; height: 100vh; }
Â  Â  .swiper-slide { display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
Â  Â  .swiper-slide img { max-width: 100%; max-height: 100%; object-fit: contain; }
Â  Â  #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; text-align: center; z-index: 10; }
Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  Â  #loader .spinner { display: inline-block; animation: spin 1.5s linear infinite; }
Â  </style>
</head>

<body>
Â  <div class="swiper"><div class="swiper-wrapper"></div></div>
Â  <div id="loader"><span class="spinner">â³</span></div>

Â  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
Â  <script>
Â  Â  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
Â  Â  let anunciosData = [];
Â  Â  let swiperInstance = null;
Â  Â  let contadorTotalAnterior = -1; // Se inicializa en -1 para la primera carga
Â  Â  let contadorAcumulado = 0;
Â  Â  const loader = document.getElementById('loader');

Â  Â  // ğŸ”¹ NUEVAS VARIABLES Y FUNCIÃ“N PARA COMENTARIOS
Â  Â  let contadorComentariosAnterior = -1; // Nuevo contador para los comentarios
Â  Â  const SCRIPT_URL_COMENTARIOS = SCRIPT_URL; // Reutilizamos la misma URL para ambos contadores

Â  Â  async function actualizarContadorComentarios() {
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${SCRIPT_URL_COMENTARIOS}?accion=obtenerContadorComentarios`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const totalActualComentarios = data.contadorComentarios || 0;

Â  Â  Â  Â  // Si es la primera vez, solo guardamos el valor
Â  Â  Â  Â  if (contadorComentariosAnterior === -1) {
Â  Â  Â  Â  Â  contadorComentariosAnterior = totalActualComentarios;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Si el nÃºmero de comentarios cambiÃ³, recargamos las imÃ¡genes
Â  Â  Â  Â  Â  if (totalActualComentarios !== contadorComentariosAnterior) {
Â  Â  Â  Â  Â  Â  console.log("ğŸ”„ Cambio de comentarios detectado: recargando anuncios para obtener los comentarios mÃ¡s recientes...");
Â  Â  Â  Â  Â  Â  contadorComentariosAnterior = totalActualComentarios;
Â  Â  Â  Â  Â  Â  await cargarImagenes();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al obtener contador de comentarios:", e);
Â  Â  Â  }
Â  Â  }

Â  Â  // ğŸ”¹ FunciÃ³n para actualizar el contador y refrescar si cambiÃ³
Â  Â  async function actualizarContador() {
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${SCRIPT_URL}?accion=obtenerContador`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const totalActual = data.contador || 0;

Â  Â  Â  Â  // Si es la primera vez, solo guardamos el valor
Â  Â  Â  Â  if (contadorTotalAnterior === -1) {
Â  Â  Â  Â  Â  contadorTotalAnterior = totalActual;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Si el nÃºmero de anuncios cambiÃ³, recargamos imÃ¡genes
Â  Â  Â  Â  Â  if (totalActual !== contadorTotalAnterior) {
Â  Â  Â  Â  Â  Â  console.log("ğŸ”„ Cambio detectado: recargando anuncios...");
Â  Â  Â  Â  Â  Â  contadorTotalAnterior = totalActual;
Â  Â  Â  Â  Â  Â  await cargarImagenes();
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Si no cambiÃ³, mantenemos el acumulado
Â  Â  Â  Â  Â  Â  let diferencia = totalActual - contadorTotalAnterior;
Â  Â  Â  Â  Â  Â  if (diferencia > 0) {
Â  Â  Â  Â  Â  Â  Â  contadorAcumulado += diferencia;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  contadorTotalAnterior = totalActual;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al obtener contador:", e);
Â  Â  Â  }
Â  Â  }


Â  Â  // ğŸ”¹ FunciÃ³n para cargar las imÃ¡genes (sin afectar el contador acumulado)
Â  Â  async function cargarImagenes() {
Â  Â  Â  loader.style.display = 'block';
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${SCRIPT_URL}?accion=listarAnuncios`);
Â  Â  Â  Â  if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const newAnunciosData = [];

Â  Â  Â  Â  if(data.url && data.url.length > 0) {
Â  Â  Â  Â  Â  data.url.forEach((url, index) => {
Â  Â  Â  Â  Â  Â  newAnunciosData.push({
Â  Â  Â  Â  Â  Â  Â  titulo: data.titulo[index] || "",
Â  Â  Â  Â  Â  Â  Â  descripcion: data.descripcion[index] || "",
Â  Â  Â  Â  Â  Â  Â  comentarios: data.comentarios[index] || [],
Â  Â  Â  Â  Â  Â  Â  url: url,
Â  Â  Â  Â  Â  Â  Â  deleteurl: data.deleteurl[index] || "",
Â  Â  Â  Â  Â  Â  Â  autor: data.autor[index] || "",
Â  Â  Â  Â  Â  Â  Â  correo: data.correo[index] || "",
Â  Â  Â  Â  Â  Â  Â  fecha: data.fecha[index] || "",
Â  Â  Â  Â  Â  Â  Â  id: data.id[index] || ""
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const swiperWrapper = document.querySelector('.swiper-wrapper');
Â  Â  Â  Â  const currentIndex = swiperInstance ? swiperInstance.realIndex : 0;

Â  Â  Â  Â  if(JSON.stringify(anunciosData) === JSON.stringify(newAnunciosData)){
Â  Â  Â  Â  Â  loader.style.display='none';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  anunciosData = newAnunciosData;
Â  Â  Â  Â  swiperWrapper.innerHTML = '';

Â  Â  Â  Â  anunciosData.forEach(anuncio => {
Â  Â  Â  Â  Â  const slide = document.createElement('div');
Â  Â  Â  Â  Â  slide.classList.add('swiper-slide');
Â  Â  Â  Â  Â  const zoomContainer = document.createElement('div');
Â  Â  Â  Â  Â  zoomContainer.classList.add('swiper-zoom-container');
Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  img.src = anuncio.url;
Â  Â  Â  Â  Â  img.alt = anuncio.titulo;
Â  Â  Â  Â  Â  zoomContainer.appendChild(img);
Â  Â  Â  Â  Â  slide.appendChild(zoomContainer);
Â  Â  Â  Â  Â  swiperWrapper.appendChild(slide);
Â  Â  Â  Â  });

Â  Â  Â  Â  const newIndex = (currentIndex >= anunciosData.length) ? anunciosData.length - 1 : currentIndex;
Â  Â  Â  Â  initSwiper(newIndex < 0 ? 0 : newIndex);
Â  Â  Â  } catch(error) {
Â  Â  Â  Â  console.error("Error al cargar las imÃ¡genes:", error);
Â  Â  Â  } finally {
Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  }
Â  Â  }

Â  Â  function initSwiper(initialIndex = 0) {
Â  Â  Â  if(swiperInstance) swiperInstance.destroy(true,true);
Â  Â  Â  swiperInstance = new Swiper('.swiper', {
Â  Â  Â  Â  loop:true,Â 
Â  Â  Â  Â  direction:'vertical',Â  // â¬…ï¸ CAMBIO AQUÃ: vertical en vez de horizontal
Â  Â  Â  Â  slidesPerView:1,Â 
Â  Â  Â  Â  spaceBetween:10,
Â  Â  Â  Â  zoom:{ maxRatio:3, minRatio:1 }
Â  Â  Â  });

Â  Â  Â  swiperInstance.on('slideChange', () => {
Â  Â  Â  Â  if(window.AppInventor && anunciosData.length > 0) {
Â  Â  Â  Â  Â  const realIndex = swiperInstance.realIndex;
Â  Â  Â  Â  Â  const anuncioActual = anunciosData[realIndex];
Â  Â  Â  Â  Â  const listaTitulos = anunciosData.map(a => a.titulo);
Â  Â  Â  Â  Â  const payload = { ...anuncioActual, titulos: listaTitulos, contador: contadorAcumulado };
Â  Â  Â  Â  Â  window.AppInventor.setWebViewString(JSON.stringify(payload));
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  if(anunciosData.length > 0) {
Â  Â  Â  Â  const initialSlideIndex = Math.min(initialIndex, anunciosData.length - 1);
Â  Â  Â  Â  swiperInstance.slideToLoop(initialSlideIndex, 0);
Â  Â  Â  Â  if(window.AppInventor){
Â  Â  Â  Â  Â  const anuncioInicial = anunciosData[initialSlideIndex];
Â  Â  Â  Â  Â  const listaTitulos = anunciosData.map(a => a.titulo);
Â  Â  Â  Â  Â  const payload = { ...anuncioInicial, titulos: listaTitulos, contador: contadorAcumulado };
Â  Â  Â  Â  Â  window.AppInventor.setWebViewString(JSON.stringify(payload));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  // Actualizar los contadores cada 5 segundos de forma independiente
Â  Â  setInterval(actualizarContador, 5000);
Â  Â  setInterval(actualizarContadorComentarios, 5000); // ğŸ”¹ NUEVA LLAMADA

Â  Â  // Cargar imÃ¡genes al inicio para mostrar el contenido
Â  Â  cargarImagenes();

Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  if(window.AppInventor) {
Â  Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  const comando = window.AppInventor.getWebViewString?.();
Â  Â  Â  Â  Â  if(comando) {
Â  Â  Â  Â  Â  Â  if(comando === "https://artisticaipucbochicasur-code.github.io/Slider-de-fotos/slider.html") {
Â  Â  Â  Â  Â  Â  Â  console.log("Reiniciando contador y cargando anuncios.");
Â  Â  Â  Â  Â  Â  Â  contadorAcumulado = 0;
Â  Â  Â  Â  Â  Â  Â  contadorTotalAnterior = -1;Â 
Â  Â  Â  Â  Â  Â  Â  cargarImagenes();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(comando.startsWith("irATitulo:")) {
Â  Â  Â  Â  Â  Â  Â  const tituloBuscado = comando.replace("irATitulo:", "").trim();
Â  Â  Â  Â  Â  Â  Â  const normalizar = txt => (txt || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
Â  Â  Â  Â  Â  Â  Â  const tituloNormalizado = normalizar(tituloBuscado);
Â  Â  Â  Â  Â  Â  Â  const index = anunciosData.findIndex(a => normalizar(a.titulo) === tituloNormalizado);
Â  Â  Â  Â  Â  Â  Â  if(index >= 0 && swiperInstance) swiperInstance.slideToLoop(index, 0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(comando.startsWith("irAIndice:")) {
Â  Â  Â  Â  Â  Â  Â  const indice = parseInt(comando.replace("irAIndice:", "").trim(), 10);
Â  Â  Â  Â  Â  Â  Â  if(!isNaN(indice) && indice >= 0 && indice < anunciosData.length && swiperInstance) swiperInstance.slideToLoop(indice, 0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 500);
Â  Â  Â  }
Â  Â  });

Â  Â  // ğŸ”¹ NUEVA FUNCIÃ“N AGREGADA: recargar datos externamente
Â  Â  function recargarDatos() {
Â  Â  Â  // Llama a la funciÃ³n existente que carga y actualiza las imÃ¡genes
Â  Â  Â  cargarImagenes();
Â  Â  Â  console.log("Datos recargados por solicitud externa.");
Â  Â  }
Â  </script>
</body>
</html>
