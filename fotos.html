<!DOCTYPE html>
<html>
<head>
Â  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
Â  <style>
Â  Â  body {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  background: #111;
Â  Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  }
Â  Â  .swiper { width: 100vw; height: 100vh; }
Â  Â  .swiper-slide { display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
Â  Â  .swiper-slide img { max-width: 100%; max-height: 100%; object-fit: contain; }
Â  Â  #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; text-align: center; z-index: 10; }
Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  Â  #loader .spinner { display: inline-block; animation: spin 1.5s linear infinite; }

Â  Â  #lblContador {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 10px;
Â  Â  Â  right: 10px;
Â  Â  Â  background: rgba(255, 0, 0, 0.8);
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  z-index: 9999;
Â  Â  Â  display: none;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  #customAlertOverlay {
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  z-index: 10000;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  .custom-alert {
Â  Â  Â  Â  background-color: #2c3e50;
Â  Â  Â  Â  color: #ecf0f1;
Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  max-width: 80%;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  border: 2px solid #3498db;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â Â 
Â  Â  .custom-alert.confirm-delete {
Â  Â  Â  width: 300px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â Â 
Â  Â  .custom-alert.confirm-delete .btn-group {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin-top: 15px;
Â  Â  }

Â  Â  .custom-alert h2 {
Â  Â  Â  Â  color: #3498db;
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  }

Â  Â  .custom-alert p {
Â  Â  Â  Â  margin: 0 0 20px;
Â  Â  Â  Â  white-space: pre-wrap;
Â  Â  }

Â  Â  .custom-alert button {
Â  Â  Â  Â  background-color: #34495e;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  }
Â  Â Â 
Â  Â  .custom-alert button:hover {
Â  Â  Â  Â  background-color: #5d6d7e;
Â  Â  }

Â  Â  .titles-list {
Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  margin: 0 0 20px;
Â  Â  Â  Â  max-height: 200px;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  .titles-list li {
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  background-color: #34495e;
Â  Â  Â  Â  border-bottom: 1px solid #2c3e50;
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  .titles-list li:hover {
Â  Â  Â  Â  background-color: #5d6d7e;
Â  Â  }

Â  Â  /* Estilos para el overlay de tÃ­tulo y descripciÃ³n */
Â  Â  .content-overlay {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  max-width: 80%;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  transition: opacity 0.3s ease, visibility 0.3s ease;
Â  Â  }

Â  Â  .content-overlay h3 {
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
Â  Â  }

Â  Â  .content-overlay p {
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  line-height: 1.2;
Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
Â  Â  }

Â  Â  /* Contenedor de comentarios (reducido por defecto) */
Â  Â  .comments-overlay-container {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 60px;
Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  width: calc(80% - 20px);
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  color: #eee;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  z-index: 998;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  transition: bottom 0.3s ease, opacity 0.3s ease, visibility 0.3s ease, max-height 0.3s ease;
Â  Â  Â  Â  max-height: 4em;
Â  Â  }

Â  Â  /* Estado expandido del contenedor de comentarios */
Â  Â  .comments-overlay-container.expanded {
Â  Â  Â  max-height: 25vh;
Â  Â  }

Â  Â  /* Estilos para la lista de comentarios */
Â  Â  .comments-overlay-container ul {
Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  margin: 0;
Â  Â  }

Â  Â  /* Estilos para cada comentario individual */
Â  Â  .comments-overlay-container li {
Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  line-height: 1.2;
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  padding-bottom: 8px;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  .comments-overlay-container li:last-child {
Â  Â  Â  border-bottom: none;
Â  Â  }
Â  Â Â 
Â  Â  /* Estilo para los comentarios que se pueden borrar */
Â  Â  .comments-overlay-container li.deletable {
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â Â 
Â  Â  /* Contenedor del botÃ³n de borrado */
Â  Â  .delete-btn-container {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  width: 100px;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  background-color: #e74c3c;
Â  Â  Â  Â  transform: translateX(-100%);
Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  Â  z-index: 0;Â 
Â  Â  }
Â  Â Â 
Â  Â  /* BotÃ³n de borrado en sÃ­ mismo */
Â  Â  .delete-btn {
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  user-select: none;
Â  Â  }
Â  Â Â 
Â  Â  /* El comentario se desliza */
Â  Â  .comment-content {
Â  Â  Â  width: 100%;
Â  Â  Â  padding-left: 10px;
Â  Â  Â  padding-right: 10px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  position: relative;
Â  Â  Â  z-index: 1;
Â  Â  }
Â  Â Â 
Â  Â  .comment-content.swiped {
Â  Â  Â  transform: translateX(100px);
Â  Â  }
Â  Â Â 
Â  Â  .delete-btn-container.visible {
Â  Â  Â  Â  transform: translateX(0);
Â  Â  }
Â  Â Â 
Â  Â  /* Clase para ocultar los overlays */
Â  Â  .hidden-overlay {
Â  Â  Â  opacity: 0;
Â  Â  Â  visibility: hidden;
Â  Â  Â  transform: translateY(100%);
Â  Â  }

Â  Â  /* Estilos del nuevo contador de comentarios */
Â  Â  .comments-counter {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 60px;
Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 2px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: bottom 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
Â  Â  }
Â  Â Â 
Â  Â  .comments-counter .icon {
Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  line-height: 1;
Â  Â  }
Â  Â Â 
Â  Â  .comments-counter .count {
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  }

Â  Â  /* Nuevo: Estilos para la barra de entrada de comentarios */
Â  Â  .comment-input-container {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  background: #1a1a1a;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  transition: bottom 0.3s ease;
Â  Â  }

Â  Â  .comment-input-container input {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  background: #333;
Â  Â  Â  Â  border: 1px solid #555;
Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  outline: none;
Â  Â  }

Â  Â  .comment-input-container .send-comment-btn {
Â  Â  Â  Â  background: #3498db;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  }
Â  Â Â 
Â  Â  .comment-input-container .send-comment-btn:hover {
Â  Â  Â  Â  background: #2980b9;
Â  Â  }
Â  </style>
</head>

<body>
Â  <div class="swiper"><div class="swiper-wrapper"></div></div>
Â  <div id="loader"><span class="spinner">â³</span></div>
Â  <div id="lblContador"></div>
Â  <div id="customAlertOverlay">
Â  Â  Â  <div class="custom-alert">
Â  Â  Â  Â  Â  <h2 id="alertTitle"></h2>
Â  Â  Â  Â  Â  <div class="titles-list" id="alertMessage"></div>
Â  Â  Â  </div>
Â  </div>
Â  <div class="content-overlay" id="contentOverlay">
Â  Â  <h3 id="currentTitle"></h3>
Â  Â  <p id="currentDescription"></p>
Â  </div>
Â  <div class="comments-overlay-container" id="commentsOverlay">
Â  Â  <ul id="commentsList"></ul>
Â  </div>
Â  <div class="comments-counter" id="commentsCounter">
Â  Â  Â  <span class="icon">ğŸ’¬</span>
Â  Â  Â  <span class="count" id="commentCountValue">0</span>
Â  </div>
Â Â 
Â  <div class="comment-input-container">
Â  Â  Â  <input type="text" id="commentInput" placeholder="Escribe un comentario...">
Â  Â  Â  <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
Â  </div>
Â Â 
Â  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
Â  <script>
Â  Â  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
Â  Â  let anunciosData = [];
Â  Â  let swiperInstance = null;
Â  Â  let contadorTotalAnterior = -1;
Â  Â  let contadorAcumulado = 0;
Â  Â  let nuevosTitulos = [];Â 
Â  Â  const loader = document.getElementById('loader');
Â  Â  const lblContador = document.getElementById("lblContador");

Â  Â  const contentOverlay = document.getElementById('contentOverlay');
Â  Â  const commentsOverlay = document.getElementById('commentsOverlay');
Â  Â  const commentsCounter = document.getElementById('commentsCounter');
Â  Â  const commentCountValue = document.getElementById('commentCountValue');
Â  Â  const commentsList = document.getElementById('commentsList');
Â  Â  const currentTitle = document.getElementById('currentTitle');
Â  Â  const currentDescription = document.getElementById('currentDescription');
Â  Â  const commentInputContainer = document.querySelector('.comment-input-container');
Â  Â  const commentInput = document.getElementById('commentInput');
Â  Â  const sendCommentBtn = document.querySelector('.send-comment-btn');

Â  Â  let contadorComentariosAnterior = -1;
Â  Â  let comentariosPorAnuncio = {};
Â  Â  let lastTapTime = 0;
Â  Â Â 
Â  Â  // Corregido: Inicializamos las variables sin un valor fijo
Â  Â  let currentAuthorEmail = "";
Â  Â  let currentAuthorName = "";
Â  Â Â 
Â  Â  // Variables para el swipe
Â  Â  let startX = 0;
Â  Â  let activeComment = null;
Â  Â  let isSwiping = false;

Â  Â  function normalizeText(text) {
Â  Â  Â  Â  if (!text) return "";
Â  Â  Â  Â  return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
Â  Â  }

Â  Â  // Toggle para ocultar/mostrar overlays al tocar la imagen
Â  Â  document.querySelector('.swiper').addEventListener('click', () => {
Â  Â  Â  Â  const currentTime = new Date().getTime();
Â  Â  Â  Â  if (currentTime - lastTapTime > 300) {
Â  Â  Â  Â  Â  Â  contentOverlay.classList.toggle('hidden-overlay');
Â  Â  Â  Â  Â  Â  commentsOverlay.classList.toggle('hidden-overlay');
Â  Â  Â  Â  Â  Â  commentsCounter.classList.toggle('hidden-overlay');
Â  Â  Â  Â  Â  Â  commentInputContainer.classList.toggle('hidden-overlay');
Â  Â  Â  Â  }
Â  Â  Â  Â  lastTapTime = currentTime;
Â  Â  });

Â  Â  // Toggle para expandir/colapsar el contenedor de comentarios con un toque
Â  Â  commentsOverlay.addEventListener('click', (e) => {
Â  Â  Â  Â  if (!isSwiping) {
Â  Â  Â  Â  Â  Â  commentsOverlay.classList.toggle('expanded');
Â  Â  Â  Â  }
Â  Â  Â  Â  isSwiping = false;Â 
Â  Â  });

Â  Â  // LÃ³gica para el swipe
Â  Â  commentsList.addEventListener('touchstart', (e) => {
Â  Â  Â  const commentElement = e.target.closest('li');
Â  Â  Â  if (!commentElement) return;

Â  Â  Â  const commentData = commentElement.dataset;
Â  Â  Â  const autorCorreo = commentData.correo;

Â  Â  Â  if (normalizeText(autorCorreo) === normalizeText(currentAuthorEmail)) {
Â  Â  Â  Â  Â  startX = e.touches[0].clientX;
Â  Â  Â  Â  Â  activeComment = commentElement;
Â  Â  Â  Â  Â  activeComment.querySelector('.comment-content').style.transition = 'none';
Â  Â  Â  Â  Â  isSwiping = false;Â 
Â  Â  Â  }
Â  Â  });

Â  Â  commentsList.addEventListener('touchmove', (e) => {
Â  Â  Â  if (!activeComment) return;

Â  Â  Â  const currentX = e.touches[0].clientX;
Â  Â  Â  const diffX = currentX - startX;
Â  Â  Â Â 
Â  Â  Â  if (Math.abs(diffX) > 10) {Â 
Â  Â  Â  Â  isSwiping = true;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (diffX > 0) {Â 
Â  Â  Â  Â  activeComment.querySelector('.comment-content').style.transform = `translateX(${diffX}px)`;
Â  Â  Â  Â  let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
Â  Â  Â  Â  if (deleteBtnContainer) {
Â  Â  Â  Â  Â  Â  deleteBtnContainer.style.transform = `translateX(0)`;
Â  Â  Â  Â  }
Â  Â  Â  } else {Â 
Â  Â  Â  Â  activeComment.querySelector('.comment-content').style.transform = `translateX(0)`;Â 
Â  Â  Â  Â  let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
Â  Â  Â  Â  if (deleteBtnContainer) {
Â  Â  Â  Â  Â  Â  deleteBtnContainer.style.transform = `translateX(-100%)`;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  commentsList.addEventListener('touchend', (e) => {
Â  Â  Â  if (!activeComment) return;
Â  Â  Â Â 
Â  Â  Â  const swipeThreshold = 50;
Â  Â  Â  const diffX = e.changedTouches[0].clientX - startX;
Â  Â  Â Â 
Â  Â  Â  const commentContent = activeComment.querySelector('.comment-content');
Â  Â  Â  let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');

Â  Â  Â  commentContent.style.transition = 'transform 0.3s ease';

Â  Â  Â  if (diffX > swipeThreshold) {
Â  Â  Â  Â  commentContent.style.transform = `translateX(100px)`;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!deleteBtnContainer) {
Â  Â  Â  Â  Â  Â  deleteBtnContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  deleteBtnContainer.className = 'delete-btn-container';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let deleteBtn = document.createElement('div');
Â  Â  Â  Â  Â  Â  deleteBtn.className = 'delete-btn';
Â  Â  Â  Â  Â  Â  deleteBtn.textContent = 'Borrar';
Â  Â  Â  Â  Â  Â  deleteBtnContainer.appendChild(deleteBtn);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  activeComment.insertBefore(deleteBtnContainer, commentContent);
Â  Â  Â  Â  Â  Â  deleteBtnContainer.style.transform = `translateX(0)`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  deleteBtn.addEventListener('click', (ev) => {
Â  Â  Â  Â  Â  Â  Â  Â  ev.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  Â  Â  const commentData = activeComment.dataset;
Â  Â  Â  Â  Â  Â  Â  Â  const comentario = commentData.texto;
Â  Â  Â  Â  Â  Â  Â  Â  const autorCorreo = commentData.correo;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationDialog("Â¿EstÃ¡s seguro de que quieres borrar este comentario?", () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const activeIndex = swiperInstance.realIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentAnuncio = anunciosData[activeIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentAnuncio) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminarComentario(currentAnuncio.id, comentario, autorCorreo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  deleteBtnContainer.style.transform = `translateX(0)`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  } else {
Â  Â  Â  Â  commentContent.style.transform = `translateX(0)`;
Â  Â  Â  Â  if (deleteBtnContainer) {
Â  Â  Â  Â  Â  Â  deleteBtnContainer.style.transform = `translateX(-100%)`;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  activeComment = null;
Â  Â  Â  startX = 0;
Â  Â  });

Â  Â  async function eliminarComentario(anuncioId, comentarioTexto, autorCorreo) {
Â  Â  Â  Â  loader.style.display = 'block';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('accion', 'eliminarComentario');
Â  Â  Â  Â  Â  Â  formData.append('idAnuncio', anuncioId);
Â  Â  Â  Â  Â  Â  formData.append('textoComentario', comentarioTexto);
Â  Â  Â  Â  Â  Â  formData.append('correoAutor', autorCorreo);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  if (result.status === "âœ… success") {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Comentario eliminado con Ã©xito.");
Â  Â  Â  Â  Â  Â  Â  Â  await verificarComentarios();Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al eliminar el comentario:", result.message);
Â  Â  Â  Â  Â  Â  Â  Â  showInfoDialog("Error", `No se pudo eliminar el comentario. ${result.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error de red al eliminar el comentario:", error);
Â  Â  Â  Â  Â  Â  showInfoDialog("Error", "OcurriÃ³ un error al intentar eliminar el comentario.");
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function enviarComentario() {
Â  Â  Â  Â  const comentarioTexto = commentInput.value.trim();
Â  Â  Â  Â  const activeIndex = swiperInstance.realIndex;
Â  Â  Â  Â  const currentAnuncio = anunciosData[activeIndex];

Â  Â  Â  Â  if (!comentarioTexto || !currentAnuncio) {
Â  Â  Â  Â  Â  Â  showInfoDialog("Error", "No puedes enviar un comentario vacÃ­o.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  loader.style.display = 'block';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('accion', 'agregarComentario');
Â  Â  Â  Â  Â  Â  formData.append('anuncioId', currentAnuncio.id);
Â  Â  Â  Â  Â  Â  formData.append('comentario', comentarioTexto);
Â  Â  Â  Â  Â  Â  formData.append('autor', currentAuthorName);
Â  Â  Â  Â  Â  Â  formData.append('correo', currentAuthorEmail);

Â  Â  Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  if (result.status === "ğŸ—£ï¸ success") {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Comentario agregado con Ã©xito.");
Â  Â  Â  Â  Â  Â  Â  Â  commentInput.value = ''; // Limpiar el campo
Â  Â  Â  Â  Â  Â  Â  Â  await verificarComentarios();Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al agregar el comentario:", result.message);
Â  Â  Â  Â  Â  Â  Â  Â  showInfoDialog("Error", `No se pudo agregar el comentario. ${result.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error de red al agregar el comentario:", error);
Â  Â  Â  Â  Â  Â  showInfoDialog("Error", "OcurriÃ³ un error al intentar agregar el comentario.");
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  sendCommentBtn.addEventListener('click', enviarComentario);
Â  Â  commentInput.addEventListener('keydown', (e) => {
Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  enviarComentario();
Â  Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  // LÃ³gica para subir la barra de comentarios
Â  Â  commentInput.addEventListener('focus', () => {
Â  Â  Â  Â  // No movemos nada, el teclado virtual de Android lo hace
Â  Â  });

Â  Â  commentInput.addEventListener('blur', () => {
Â  Â  Â  Â  // No movemos nada
Â  Â  });

Â  Â  function normalizeCommentData(commentData) {
Â  Â  Â  if (!commentData || typeof commentData !== 'object') {
Â  Â  Â  Â  return { autor: "", fecha: "", comentario: "", correo: "" };
Â  Â  Â  }
Â  Â  Â  return {
Â  Â  Â  Â  autor: commentData.autor || "",
Â  Â  Â  Â  fecha: commentData.fecha || "",
Â  Â  Â  Â  comentario: commentData.comentario || "",
Â  Â  Â  Â  correo: commentData.correo || ""
Â  Â  Â  };
Â  Â  }

Â  Â  function normalizarComentarios(lista) {
Â  Â  Â  if (!Array.isArray(lista)) return [];
Â  Â  Â  return [...lista]
Â  Â  Â  Â  .reverse()
Â  Â  Â  Â  .map(c => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const data = (typeof c === "string") ? JSON.parse(c) : c;
Â  Â  Â  Â  Â  Â  const normalizedData = normalizeCommentData(data);
Â  Â  Â  Â  Â  Â  if (normalizedData.autor || normalizedData.fecha || normalizedData.comentario) {
Â  Â  Â  Â  Â  Â  Â  return {Â 
Â  Â  Â  Â  Â  Â  Â  Â  texto: `${normalizedData.autor} (${normalizedData.fecha}) - ${normalizedData.comentario}`,
Â  Â  Â  Â  Â  Â  Â  Â  autorCorreo: normalizedData.correo,
Â  Â  Â  Â  Â  Â  Â  Â  textoPuro: normalizedData.comentario,
Â  Â  Â  Â  Â  Â  Â  Â  autor: normalizedData.autor,
Â  Â  Â  Â  Â  Â  Â  Â  id: normalizedData.idÂ 
Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error("Error parsing comment:", e);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  })
Â  Â  Â  Â  .filter(Boolean);
Â  Â  }

Â  Â  const INTERVALO_VERIFICACION = 5000;

Â  Â  async function actualizarContador() {
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${SCRIPT_URL}?accion=obtenerContador`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const totalActual = data.contador || 0;

Â  Â  Â  Â  if (contadorTotalAnterior === -1) {
Â  Â  Â  Â  Â  contadorTotalAnterior = totalActual;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (totalActual !== contadorTotalAnterior) {
Â  Â  Â  Â  Â  Â  const diferencia = totalActual - contadorTotalAnterior;
Â  Â  Â  Â  Â  Â  if (diferencia > 0) {
Â  Â  Â  Â  Â  Â  Â  contadorAcumulado += diferencia;
Â  Â  Â  Â  Â  Â  } else if (diferencia < 0) {
Â  Â  Â  Â  Â  Â  Â  contadorAcumulado = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (lblContador) {
Â  Â  Â  Â  Â  Â  Â  if (contadorAcumulado > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lblContador.textContent = `ğŸ”” ${contadorAcumulado}`;
Â  Â  Â  Â  Â  Â  Â  Â  lblContador.style.display = "block";
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  lblContador.textContent = "";
Â  Â  Â  Â  Â  Â  Â  Â  lblContador.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  contadorTotalAnterior = totalActual;
Â  Â  Â  Â  Â  Â  console.log("ğŸ”„ Cambio detectado: recargando anuncios...");
Â  Â  Â  Â  Â  Â  await cargarImagenes();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("âŒ Error al obtener contador:", e);
Â  Â  Â  }
Â  Â  }
Â  Â  setInterval(actualizarContador, INTERVALO_VERIFICACION);

Â  Â  async function verificarComentarios() {
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${SCRIPT_URL}?accion=obtenerContadorComentarios`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const totalComentariosActual = data.contadorComentarios || 0;

Â  Â  Â  Â  if (data.comentarios) {
Â  Â  Â  Â  Â  comentariosPorAnuncio = data.comentarios;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (contadorComentariosAnterior === -1) {
Â  Â  Â  Â  Â  contadorComentariosAnterior = totalComentariosActual;
Â  Â  Â  Â  } else if (totalComentariosActual !== contadorComentariosAnterior) {
Â  Â  Â  Â  Â  console.log("ğŸ’¬ Cambio detectado en comentarios, recargando...");
Â  Â  Â  Â  Â  contadorComentariosAnterior = totalComentariosActual;
Â  Â  Â  Â  Â  recargarComentariosDelAnuncioActual();
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al verificar comentarios:", e);
Â  Â  Â  }
Â  Â  }

Â  Â  function recargarComentariosDelAnuncioActual() {
Â  Â  Â  if (!swiperInstance || anunciosData.length === 0) return;
Â  Â  Â  const activeIndex = swiperInstance.realIndex;
Â  Â  Â  const anuncioActual = anunciosData[activeIndex];
Â  Â  Â Â 
Â  Â  Â  if (anuncioActual) {
Â  Â  Â  Â  const comentarios = comentariosPorAnuncio[anuncioActual.id] || [];
Â  Â  Â  Â  anuncioActual.comentarios = normalizarComentarios(comentarios);
Â  Â  Â  Â  updateContentOverlay(activeIndex);
Â  Â  Â  Â Â 
Â  Â  Â  Â  console.log(`ğŸ“Œ Comentarios actualizados para el anuncio: ${anuncioActual.titulo}`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (window.AppInventor) {
Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  ...anuncioActual,
Â  Â  Â  Â  Â  Â  titulos: anunciosData.map(a => a.titulo),
Â  Â  Â  Â  Â  Â  contador: contadorAcumulado
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  window.AppInventor.setWebViewString(JSON.stringify(payload));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  async function cargarImagenes() {
Â  Â  Â  loader.style.display = 'block';
Â  Â  Â  const currentIndex = swiperInstance ? swiperInstance.realIndex : 0;
Â  Â  Â  const currentId = swiperInstance && anunciosData.length > 0 ? anunciosData[swiperInstance.realIndex].id : null;

Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${SCRIPT_URL}?accion=listarAnuncios`);
Â  Â  Â  Â  if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  let newAnunciosData = [];

Â  Â  Â  Â  if(data.url && data.url.length > 0) {
Â  Â  Â  Â  Â  data.url.forEach((url, index) => {
Â  Â  Â  Â  Â  Â  const idAnuncio = data.id[index];
Â  Â  Â  Â  Â  Â  const comentarios = comentariosPorAnuncio[idAnuncio] || [];
Â  Â  Â  Â  Â  Â  const comentariosFormateados = normalizarComentarios(comentarios);
Â  Â  Â  Â  Â  Â  newAnunciosData.push({
Â  Â  Â  Â  Â  Â  Â  titulo: data.titulo[index] || "",
Â  Â  Â  Â  Â  Â  Â  descripcion: data.descripcion[index] || "",
Â  Â  Â  Â  Â  Â  Â  comentarios: comentariosFormateados,
Â  Â  Â  Â  Â  Â  Â  url: url,
Â  Â  Â  Â  Â  Â  Â  deleteurl: data.deleteurl[index] || "",
Â  Â  Â  Â  Â  Â  Â  autor: data.autor[index] || "",
Â  Â  Â  Â  Â  Â  Â  correo: data.correo[index] || "",
Â  Â  Â  Â  Â  Â  Â  fecha: data.fecha[index] || "",
Â  Â  Â  Â  Â  Â  Â  id: idAnuncio || ""
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  newAnunciosData.reverse();

Â  Â  Â  Â  if (JSON.stringify(anunciosData) === JSON.stringify(newAnunciosData)) {
Â  Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const oldAnunciosDataLength = anunciosData.length;
Â  Â  Â  Â  const newAnunciosDataLength = newAnunciosData.length;
Â  Â  Â  Â  const isInitialLoad = oldAnunciosDataLength === 0;

Â  Â  Â  Â  if (!isInitialLoad && newAnunciosDataLength > oldAnunciosDataLength) {
Â  Â  Â  Â  Â  Â  const nuevosAnuncios = newAnunciosData.slice(0, newAnunciosDataLength - oldAnunciosDataLength);
Â  Â  Â  Â  Â  Â  nuevosTitulos.unshift(...nuevosAnuncios.map(a => a.titulo));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  nuevosTitulos = [];
Â  Â  Â  Â  Â  Â  contadorAcumulado = 0;
Â  Â  Â  Â  Â  Â  lblContador.style.display = "none";
Â  Â  Â  Â  }

Â  Â  Â  Â  anunciosData = newAnunciosData;
Â  Â  Â  Â  const swiperWrapper = document.querySelector('.swiper-wrapper');
Â  Â  Â  Â  swiperWrapper.innerHTML = '';

Â  Â  Â  Â  anunciosData.forEach(anuncio => {
Â  Â  Â  Â  Â  const slide = document.createElement('div');
Â  Â  Â  Â  Â  slide.classList.add('swiper-slide');
Â  Â  Â  Â  Â  slide.dataset.id = anuncio.id;
Â  Â  Â  Â  Â  const zoomContainer = document.createElement('div');
Â  Â  Â  Â  Â  zoomContainer.classList.add('swiper-zoom-container');
Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  img.src = anuncio.url;
Â  Â  Â  Â  Â  img.alt = anuncio.titulo;
Â  Â  Â  Â  Â  zoomContainer.appendChild(img);
Â  Â  Â  Â  Â  slide.appendChild(zoomContainer);

Â  Â  Â  Â  Â  swiperWrapper.appendChild(slide);
Â  Â  Â  Â  });

Â  Â  Â  Â  const newIndex = currentId ? anunciosData.findIndex(a => a.id === currentId) : 0;
Â  Â  Â  Â  const finalIndex = newIndex >= 0 ? newIndex : 0;Â 

Â  Â  Â  Â  if(!swiperInstance) {
Â  Â  Â  Â  Â  initSwiper(finalIndex);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  swiperInstance.update();
Â  Â  Â  Â  Â  swiperInstance.slideTo(finalIndex, 0, false);
Â  Â  Â  Â  }

Â  Â  Â  Â  updateContentOverlay(finalIndex);

Â  Â  Â  } catch(error) {
Â  Â  Â  Â  console.error("Error al cargar las imÃ¡genes:", error);
Â  Â  Â  } finally {
Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  }
Â  Â  }

Â  Â  function updateContentOverlay(index) {
Â  Â  Â  Â  if (anunciosData.length > index) {
Â  Â  Â  Â  Â  Â  const anuncio = anunciosData[index];
Â  Â  Â  Â  Â  Â  currentTitle.textContent = anuncio.titulo;
Â  Â  Â  Â  Â  Â  currentDescription.textContent = anuncio.descripcion;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  commentsList.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  commentsOverlay.classList.remove('expanded');Â 

Â  Â  Â  Â  Â  Â  if (anuncio.comentarios && anuncio.comentarios.length > 0) {
Â  Â  Â  Â  Â  Â  Â  anuncio.comentarios.forEach(comentario => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const esAutor = normalizeText(comentario.autorCorreo) === normalizeText(currentAuthorEmail);
Â  Â  Â  Â  Â  Â  Â  Â  if (esAutor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  li.classList.add('deletable');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const commentContent = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  commentContent.classList.add('comment-content');
Â  Â  Â  Â  Â  Â  Â  Â  commentContent.textContent = comentario.texto;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (esAutor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtnContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtnContainer.className = 'delete-btn-container';
Â  Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtn = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.className = 'delete-btn';
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.textContent = 'Borrar';
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtnContainer.appendChild(deleteBtn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  li.appendChild(deleteBtnContainer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.addEventListener('click', (ev) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ev.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmationDialog("Â¿EstÃ¡s seguro de que quieres borrar este comentario?", () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminarComentario(anuncio.id, comentario.textoPuro, comentario.autorCorreo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  li.appendChild(commentContent);
Â  Â  Â  Â  Â  Â  Â  Â  li.dataset.correo = comentario.autorCorreo;
Â  Â  Â  Â  Â  Â  Â  Â  li.dataset.texto = comentario.textoPuro;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  commentsList.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  commentCountValue.textContent = anuncio.comentarios.length;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  li.textContent = "No hay comentarios aÃºn.";
Â  Â  Â  Â  Â  Â  Â  commentsList.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  commentCountValue.textContent = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function initSwiper(initialIndex = 0) {
Â  Â  Â  if(swiperInstance) swiperInstance.destroy(true, true);
Â  Â  Â  swiperInstance = new Swiper('.swiper', {
Â  Â  Â  Â  loop: true,
Â  Â  Â  Â  direction: 'vertical',
Â  Â  Â  Â  slidesPerView: 1,
Â  Â  Â  Â  spaceBetween: 10,
Â  Â  Â  Â  zoom: { maxRatio: 3, minRatio: 1 }
Â  Â  Â  });

Â  Â  Â  swiperInstance.on('slideChange', () => {
Â  Â  Â  Â  const activeIndex = swiperInstance.realIndex;
Â  Â  Â  Â  updateContentOverlay(activeIndex);

Â  Â  Â  Â  if(window.AppInventor && anunciosData.length > 0) {
Â  Â  Â  Â  Â  const anuncioActual = anunciosData[activeIndex];
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (!anuncioActual) return;

Â  Â  Â  Â  Â  const id = anuncioActual.id;
Â  Â  Â  Â  Â  const hayServidor = Array.isArray(comentariosPorAnuncio[id]) && comentariosPorAnuncio[id].length > 0;
Â  Â  Â  Â  Â  if (hayServidor) {
Â  Â  Â  Â  Â  Â  anuncioActual.comentarios = normalizarComentarios(comentariosPorAnuncio[id]);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const listaTitulos = anunciosData.map(a => a.titulo);
Â  Â  Â  Â  Â  const payload = { ...anuncioActual, titulos: listaTitulos, contador: contadorAcumulado };
Â  Â  Â  Â  Â  window.AppInventor.setWebViewString(JSON.stringify(payload));
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  if(anunciosData.length > 0) {
Â  Â  Â  Â  const initialSlideIndex = Math.min(initialIndex, anunciosData.length - 1);
Â  Â  Â  Â  swiperInstance.slideToLoop(initialSlideIndex, 0, false);
Â  Â  Â  Â  updateContentOverlay(initialSlideIndex);
Â  Â  Â  Â  if(window.AppInventor){
Â  Â  Â  Â  Â  const anuncioInicial = anunciosData[initialSlideIndex];
Â  Â  Â  Â  Â  const id = anuncioInicial.id;
Â  Â  Â  Â  Â  const hayServidor = Array.isArray(comentariosPorAnuncio[id]) && comentariosPorAnuncio[id].length > 0;
Â  Â  Â  Â  Â  if (hayServidor) {
Â  Â  Â  Â  Â  Â  anuncioInicial.comentarios = normalizarComentarios(comentariosPorAnuncio[id]);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const listaTitulos = anunciosData.map(a => a.titulo);
Â  Â  Â  Â  Â  const payload = { ...anuncioInicial, titulos: listaTitulos, contador: contadorAcumulado };
Â  Â  Â  Â  Â  window.AppInventor.setWebViewString(JSON.stringify(payload));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  // CORRECCIÃ“N: Agregamos esta nueva funciÃ³n para que App Inventor pueda enviar el nombre y correo
Â  Â  // App Inventor debe llamar a esta funciÃ³n cuando el usuario ha iniciado sesiÃ³n
Â  Â  function setAuthorInfo(name, email) {
Â  Â  Â  currentAuthorName = name;
Â  Â  Â  currentAuthorEmail = email;
Â  Â  Â  console.log(`Autor actualizado a: ${currentAuthorName} (${currentAuthorEmail})`);
Â  Â  }
Â  Â  window.setAuthorInfo = setAuthorInfo;

Â  Â  function showCustomAlert(title, titlesList) {
Â  Â  Â  Â  const overlay = document.getElementById('customAlertOverlay');
Â  Â  Â  Â  const alertDiv = overlay.querySelector('.custom-alert');
Â  Â  Â  Â  const alertTitle = document.getElementById('alertTitle');
Â  Â  Â  Â  const alertMessage = document.getElementById('alertMessage');
Â  Â  Â  Â Â 
Â  Â  Â  Â  alertDiv.className = 'custom-alert';
Â  Â  Â  Â  alertMessage.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  alertTitle.textContent = title;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (titlesList.length > 0) {
Â  Â  Â  Â  Â  Â  const list = document.createElement('ul');
Â  Â  Â  Â  Â  Â  list.className = 'titles-list';
Â  Â  Â  Â  Â  Â  titlesList.forEach((titulo, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = `${index + 1}. ${titulo}`;
Â  Â  Â  Â  Â  Â  Â  Â  li.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  swiperInstance.slideToLoop(anunciosData.findIndex(a => a.titulo === titulo), 0, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  overlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  alertMessage.appendChild(list);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  Â  Â  p.textContent = "No hay anuncios nuevos.";
Â  Â  Â  Â  Â  Â  alertMessage.appendChild(p);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  overlay.style.display = 'flex';
Â  Â  }

Â  Â  function showConfirmationDialog(message, onConfirm) {
Â  Â  Â  const overlay = document.getElementById('customAlertOverlay');
Â  Â  Â  const alertDiv = overlay.querySelector('.custom-alert');
Â  Â  Â  const alertTitle = document.getElementById('alertTitle');
Â  Â  Â  const alertMessage = document.getElementById('alertMessage');
Â  Â  Â Â 
Â  Â  Â  alertDiv.className = 'custom-alert confirm-delete';
Â  Â  Â  alertTitle.textContent = "Confirmar";
Â  Â  Â  alertMessage.innerHTML = `<p>${message}</p><div class="btn-group"><button id="confirmYesBtn">SÃ­</button><button id="confirmNoBtn">No</button></div>`;
Â  Â  Â  overlay.style.display = 'flex';

Â  Â  Â  document.getElementById('confirmYesBtn').onclick = () => {
Â  Â  Â  Â  overlay.style.display = 'none';
Â  Â  Â  Â  if (onConfirm) onConfirm();
Â  Â  Â  };
Â  Â  Â  document.getElementById('confirmNoBtn').onclick = () => {
Â  Â  Â  Â  overlay.style.display = 'none';
Â  Â  Â  Â  recargarComentariosDelAnuncioActual();
Â  Â  Â  };
Â  Â  }

Â  Â  function showInfoDialog(title, message) {
Â  Â  Â  const overlay = document.getElementById('customAlertOverlay');
Â  Â  Â  const alertDiv = overlay.querySelector('.custom-alert');
Â  Â  Â  const alertTitle = document.getElementById('alertTitle');
Â  Â  Â  const alertMessage = document.getElementById('alertMessage');

Â  Â  Â  alertDiv.className = 'custom-alert';
Â  Â  Â  alertTitle.textContent = title;
Â  Â  Â  alertMessage.innerHTML = `<p>${message}</p><button onclick="document.getElementById('customAlertOverlay').style.display='none';">Aceptar</button>`;
Â  Â  Â  overlay.style.display = 'flex';
Â  Â  }

Â  Â  window.onload = () => {
Â  Â  Â  cargarImagenes();
Â  Â  Â  verificarComentarios();
Â  Â  };
Â  </script>
</body>
</html>
