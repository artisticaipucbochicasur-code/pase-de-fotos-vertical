<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <style>
    body { margin: 0; padding: 0; background: #111; font-family: Arial, sans-serif; color: white; }
    .swiper { width: 100vw; height: 100vh; }
    .swiper-slide { display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
    .swiper-slide img { max-width: 100%; max-height: 100%; object-fit: contain; }
    #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; text-align: center; z-index: 10; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loader .spinner { display: inline-block; animation: spin 1.5s linear infinite; }

    #lblContador {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 0, 0, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
      display: none;
      cursor: pointer;
    }

    #customAlertOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .custom-alert {
        background-color: #2c3e50;
        color: #ecf0f1;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 80%;
        text-align: center;
        border: 2px solid #3498db;
        display: flex;
        flex-direction: column;
    }

    .custom-alert h2 {
        color: #3498db;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }

    .custom-alert p {
        margin: 0 0 20px;
        white-space: pre-wrap;
    }

    .custom-alert button {
        background-color: #34495e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
    }
    
    .custom-alert button:hover {
        background-color: #5d6d7e;
    }

    .titles-list {
        list-style: none;
        padding: 0;
        margin: 0 0 20px;
        max-height: 200px;
        overflow-y: auto;
        text-align: left;
    }

    .titles-list li {
        padding: 8px;
        background-color: #34495e;
        border-bottom: 1px solid #2c3e50;
        cursor: pointer;
    }
    .titles-list li:hover {
        background-color: #5d6d7e;
    }
  </style>
</head>

<body>
  <div class="swiper"><div class="swiper-wrapper"></div></div>
  <div id="loader"><span class="spinner">‚è≥</span></div>
  <div id="lblContador"></div>
  <div id="customAlertOverlay">
      <div class="custom-alert">
          <h2 id="alertTitle"></h2>
          <ul class="titles-list" id="alertMessage"></ul>
          <button id="closeAlertButton">Cerrar</button>
      </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
    let anunciosData = [];
    let swiperInstance = null;
    let contadorTotalAnterior = -1;
    let contadorAcumulado = 0;
    let nuevosTitulos = []; 
    const loader = document.getElementById('loader');
    const lblContador = document.getElementById("lblContador");

    let contadorComentariosAnterior = -1;
    let comentariosPorAnuncio = {};

    function normalizarComentarios(lista) {
      if (!Array.isArray(lista)) return [];
      return [...lista]
        .reverse()
        .map(c => {
          try { if (typeof c === "string") c = JSON.parse(c); } catch(e) {}
          const autor = c?.autor ?? "";
          const fecha = c?.fecha ?? "";
          const comentario = c?.comentario ?? "";
          if (autor || fecha || comentario) {
            return `${autor} (${fecha}) - ${comentario}`;
          }
          return "";
        })
        .filter(Boolean);
    }

    const INTERVALO_VERIFICACION = 5000;

    async function actualizarContador() {
      try {
        const response = await fetch(`${SCRIPT_URL}?accion=obtenerContador`);
        const data = await response.json();
        const totalActual = data.contador || 0;

        if (contadorTotalAnterior === -1) {
          contadorTotalAnterior = totalActual;
        } else {
          if (totalActual !== contadorTotalAnterior) {
            const diferencia = totalActual - contadorTotalAnterior;
            if (diferencia > 0) {
              contadorAcumulado += diferencia;
            } else if (diferencia < 0) {
              contadorAcumulado = 0;
            }
            if (lblContador) {
              if (contadorAcumulado > 0) {
                lblContador.textContent = `üîî ${contadorAcumulado}`;
                lblContador.style.display = "block";
              } else {
                lblContador.textContent = "";
                lblContador.style.display = "none";
              }
            }
            contadorTotalAnterior = totalActual;
            console.log("üîÑ Cambio detectado: recargando anuncios...");
            await cargarImagenes();
          }
        }
      } catch (e) {
        console.error("‚ùå Error al obtener contador:", e);
      }
    }
    setInterval(actualizarContador, INTERVALO_VERIFICACION);

    async function verificarComentarios() {
      try {
        const response = await fetch(`${SCRIPT_URL}?accion=obtenerContadorComentarios`);
        const data = await response.json();
        const totalComentariosActual = data.contadorComentarios || 0;

        if (data.comentarios) {
          comentariosPorAnuncio = data.comentarios;
        }

        if (contadorComentariosAnterior === -1) {
          contadorComentariosAnterior = totalComentariosActual;
        } else if (totalComentariosActual !== contadorComentariosAnterior) {
          console.log("üí¨ Cambio detectado en comentarios, recargando...");
          contadorComentariosAnterior = totalComentariosActual;
          recargarComentariosDelAnuncioActual();
        }
      } catch (e) {
        console.error("Error al verificar comentarios:", e);
      }
    }

    function recargarComentariosDelAnuncioActual() {
      if (!swiperInstance || anunciosData.length === 0) return;
      const activeSlideEl = swiperInstance.slides[swiperInstance.activeIndex];
      const anuncioId = activeSlideEl.dataset.id;
      const anuncioActual = anunciosData.find(a => a.id === anuncioId);
      
      if (anuncioActual) {
        anuncioActual.comentarios = normalizarComentarios(comentariosPorAnuncio[anuncioActual.id]);
        
        console.log(`üìå Comentarios actualizados para el anuncio: ${anuncioActual.titulo}`);
        
        if (window.AppInventor) {
          const payload = {
            ...anuncioActual,
            titulos: anunciosData.map(a => a.titulo),
            contador: contadorAcumulado
          };
          window.AppInventor.setWebViewString(JSON.stringify(payload));
        }
      }
    }

    async function cargarImagenes() {
      loader.style.display = 'block';
      const currentIndex = swiperInstance ? swiperInstance.realIndex : 0;
      const currentId = swiperInstance && anunciosData.length > 0 ? anunciosData[swiperInstance.realIndex].id : null;

      try {
        const response = await fetch(`${SCRIPT_URL}?accion=listarAnuncios`);
        if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        let newAnunciosData = [];

        if(data.url && data.url.length > 0) {
          data.url.forEach((url, index) => {
            const comentariosFormateados = normalizarComentarios(data.comentarios?.[index] || []);
            newAnunciosData.push({
              titulo: data.titulo[index] || "",
              descripcion: data.descripcion[index] || "",
              comentarios: comentariosFormateados,
              url: url,
              deleteurl: data.deleteurl[index] || "",
              autor: data.autor[index] || "",
              correo: data.correo[index] || "",
              fecha: data.fecha[index] || "",
              id: data.id[index] || ""
            });
          });
        }

        newAnunciosData.reverse();

        if (JSON.stringify(anunciosData) === JSON.stringify(newAnunciosData)) {
          loader.style.display = 'none';
          return;
        }

        const oldAnunciosDataLength = anunciosData.length;
        const newAnunciosDataLength = newAnunciosData.length;
        const isInitialLoad = oldAnunciosDataLength === 0;

        // Limpia la lista de nuevos t√≠tulos y el contador en cualquier cambio que no sea una simple adici√≥n
        if (newAnunciosDataLength <= oldAnunciosDataLength && !isInitialLoad) {
            nuevosTitulos = [];
            contadorAcumulado = 0;
            lblContador.style.display = "none";
        }

        // Si hay nuevos elementos y no es la carga inicial, los agrega a la lista de t√≠tulos nuevos
        if (newAnunciosDataLength > oldAnunciosDataLength) {
            const nuevosAnuncios = newAnunciosData.slice(0, newAnunciosDataLength - oldAnunciosDataLength);
            nuevosTitulos.unshift(...nuevosAnuncios.map(a => a.titulo));
        }

        // üîÑ Siempre actualiza la data principal y reconstruye el slider
        anunciosData = newAnunciosData;
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        swiperWrapper.innerHTML = '';

        anunciosData.forEach(anuncio => {
          const slide = document.createElement('div');
          slide.classList.add('swiper-slide');
          slide.dataset.id = anuncio.id;
          const zoomContainer = document.createElement('div');
          zoomContainer.classList.add('swiper-zoom-container');
          const img = document.createElement('img');
          img.src = anuncio.url;
          img.alt = anuncio.titulo;
          zoomContainer.appendChild(img);
          slide.appendChild(zoomContainer);
          swiperWrapper.appendChild(slide);
        });

        const newIndex = currentId ? anunciosData.findIndex(a => a.id === currentId) : 0;
        const finalIndex = newIndex >= 0 ? newIndex : 0; 

        if(!swiperInstance) {
          initSwiper(finalIndex);
        } else {
          swiperInstance.update();
          swiperInstance.slideTo(finalIndex, 0, false);
        }

      } catch(error) {
        console.error("Error al cargar las im√°genes:", error);
      } finally {
        loader.style.display = 'none';
      }
    }

    function initSwiper(initialIndex = 0) {
      if(swiperInstance) swiperInstance.destroy(true, true);
      swiperInstance = new Swiper('.swiper', {
        loop: true,
        direction: 'vertical',
        slidesPerView: 1,
        spaceBetween: 10,
        zoom: { maxRatio: 3, minRatio: 1 }
      });

      swiperInstance.on('slideChange', () => {
        if(window.AppInventor && swiperInstance.slides.length > 0) {
          const activeSlideEl = swiperInstance.slides[swiperInstance.activeIndex];
          const anuncioId = activeSlideEl.dataset.id;
          const anuncioActual = anunciosData.find(a => a.id === anuncioId);
          
          if (!anuncioActual) return;

          const id = anuncioActual.id;
          const hayServidor = Array.isArray(comentariosPorAnuncio[id]) && comentariosPorAnuncio[id].length > 0;
          if (hayServidor) {
            anuncioActual.comentarios = normalizarComentarios(comentariosPorAnuncio[id]);
          }
          const listaTitulos = anunciosData.map(a => a.titulo);
          const payload = { ...anuncioActual, titulos: listaTitulos, contador: contadorAcumulado };
          window.AppInventor.setWebViewString(JSON.stringify(payload));
        }
      });

      if(anunciosData.length > 0) {
        const initialSlideIndex = Math.min(initialIndex, anunciosData.length - 1);
        swiperInstance.slideToLoop(initialSlideIndex, 0, false);
        if(window.AppInventor){
          const anuncioInicial = anunciosData[initialSlideIndex];
          const id = anuncioInicial.id;
          const hayServidor = Array.isArray(comentariosPorAnuncio[id]) && comentariosPorAnuncio[id].length > 0;
          if (hayServidor) {
            anuncioInicial.comentarios = normalizarComentarios(comentariosPorAnuncio[id]);
          }
          const listaTitulos = anunciosData.map(a => a.titulo);
          const payload = { ...anuncioInicial, titulos: listaTitulos, contador: contadorAcumulado };
          window.AppInventor.setWebViewString(JSON.stringify(payload));
        }
      }
    }

    function showCustomAlert(title, titlesList) {
        const overlay = document.getElementById('customAlertOverlay');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        
        alertTitle.textContent = title;
        alertMessage.innerHTML = '';
        
        if (titlesList.length > 0) {
            titlesList.forEach((titulo, index) => {
                const li = document.createElement('li');
                li.textContent = titulo;
                li.dataset.index = index;
                li.addEventListener('click', () => {
                    const selectedIndex = anunciosData.findIndex(a => a.titulo === titulo);
                    if (selectedIndex !== -1) {
                        swiperInstance.slideToLoop(selectedIndex, 500);
                        nuevosTitulos.splice(nuevosTitulos.indexOf(titulo), 1);
                        contadorAcumulado = nuevosTitulos.length;
                        if (contadorAcumulado > 0) {
                            lblContador.textContent = `üîî ${contadorAcumulado}`;
                        } else {
                            lblContador.style.display = 'none';
                        }
                        document.getElementById('customAlertOverlay').style.display = 'none';
                    }
                });
                alertMessage.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = "No hay anuncios nuevos.";
            alertMessage.appendChild(li);
        }

        overlay.style.display = 'flex';
    }

    document.getElementById('closeAlertButton').addEventListener('click', () => {
        document.getElementById('customAlertOverlay').style.display = 'none';
    });

    setInterval(actualizarContador, 5000);
    setInterval(verificarComentarios, 5000);

    cargarImagenes();
    verificarComentarios();

    if (lblContador) {
        lblContador.addEventListener('click', () => {
            showCustomAlert("DECOM BOCHICA SUR", nuevosTitulos);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      if(window.AppInventor) {
        setInterval(() => {
          const comando = window.AppInventor.getWebViewString?.();
          if(comando) {
            if(comando === "https://artisticaipucbochicasur-code.github.io/Slider-de-fotos/slider.html") {
              console.log("Reiniciando contador y cargando anuncios.");
              contadorAcumulado = 0;
              contadorTotalAnterior = -1;
              cargarImagenes();
            }
            if(comando.startsWith("irATitulo:")) {
              const tituloBuscado = comando.replace("irATitulo:", "").trim();
              const normalizar = txt => (txt || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
              const tituloNormalizado = normalizar(tituloBuscado);
              const index = anunciosData.findIndex(a => normalizar(a.titulo) === tituloNormalizado);
              if(index >= 0 && swiperInstance) swiperInstance.slideToLoop(index, 0, false);
            }
            if(comando.startsWith("irAIndice:")) {
              const indice = parseInt(comando.replace("irAIndice:", "").trim(), 10);
              if(!isNaN(indice) && indice >= 0 && indice < anunciosData.length && swiperInstance) swiperInstance.slideToLoop(indice, 0, false);
            }
          }
        }, 500);
      }
    });

    function recargarDatos() {
      cargarImagenes();
      console.log("Datos recargados por solicitud externa.");
    }
  </script>
</body>
</html>
