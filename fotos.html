<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
        margin: 0;
        padding: 0;
        background: #111;
        font-family: Arial, sans-serif;
        color: white;
        transition: transform 0.3s ease;
    }
    .swiper { width: 100vw; height: 100vh; }
    .swiper-slide { display: flex; justify-content: center; align-items: center; position: relative; background: #000; }
    .swiper-slide img { max-width: 100%; max-height: 100%; object-fit: contain; }
    #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; text-align: center; z-index: 10; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loader .spinner { display: inline-block; animation: spin 1.5s linear infinite; }

    #lblContador {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 0, 0, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 9999;
      display: none;
      cursor: pointer;
    }

    /* üîπ Bot√≥n eliminar fijo */
    #deleteBtn {
      position: fixed;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      color: white; /* Blanco por defecto */
      font-size: 1.8rem;
      cursor: pointer;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out, color 0.3s ease-in-out;
    }

    /* üîπ Aparece suavemente */
    #deleteBtn.visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* üîπ Cambia a rojo al pasar el mouse */
    #deleteBtn:hover {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <div class="swiper"><div class="swiper-wrapper"></div></div>
  <div id="loader"><span class="spinner">‚è≥2</span></div>
  <div id="lblContador"></div>
  <div id="customAlertOverlay">
      <div class="custom-alert">
          <h2 id="alertTitle"></h2>
          <div class="titles-list" id="alertMessage"></div>
      </div>
  </div>
  <div class="content-overlay" id="contentOverlay">
    <h3 id="currentTitle"></h3>
    <p id="currentDescription"></p>
  </div>
  <div class="comments-overlay-container" id="commentsOverlay">
    <ul id="commentsList"></ul>
  </div>
  <div class="comments-counter" id="commentsCounter">
      <span class="icon">üí¨</span>
      <span class="count" id="commentCountValue">0</span>
  </div>
  
  <div class="comment-input-container">
      <input type="text" id="commentInput" placeholder="Escribe un comentario...">
      <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
  </div>

  <!-- üîπ Bot√≥n fijo para eliminar anuncios -->
  <button id="deleteBtn" title="Eliminar anuncio">
    <i class="fa-solid fa-trash"></i>
  </button>
  
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
    let anunciosData = [];
    let swiperInstance = null;
    let nuevosTitulos = []; 
    const loader = document.getElementById('loader');
    const deleteBtn = document.getElementById('deleteBtn');
    let currentAuthorEmail = "deimer.herrera91@gmail.com";

    function normalizeText(text) {
      return (text || "").toString().trim().toLowerCase();
    }

    // üîπ Mostrar u ocultar bot√≥n eliminar seg√∫n el anuncio
    function actualizarBotonEliminar() {
      if (!swiperInstance || anunciosData.length === 0) return;
      const anuncioActual = anunciosData[swiperInstance.realIndex];
      if (normalizeText(anuncioActual.correo) === normalizeText(currentAuthorEmail)) {
        deleteBtn.classList.add('visible');
      } else {
        deleteBtn.classList.remove('visible');
      }
    }

    // üîπ Evento click del bot√≥n eliminar
    deleteBtn.addEventListener('click', () => {
      if (!swiperInstance || anunciosData.length === 0) return;
      const anuncioActual = anunciosData[swiperInstance.realIndex];
      showConfirmationDialog(
        "¬øEst√°s seguro de que quieres eliminar este anuncio?",
        () => eliminarAnuncio(anuncioActual.id, anuncioActual.deleteurl)
      );
    });

    // üîπ Llamar a actualizar bot√≥n cuando cambie el slide
    function initSwiper(initialIndex = 0) {
      if (swiperInstance) swiperInstance.destroy(true, true);
      swiperInstance = new Swiper('.swiper', {
        loop: true,
        direction: 'vertical',
        slidesPerView: 1,
        spaceBetween: 10,
        zoom: { maxRatio: 3, minRatio: 1 }
      });

      swiperInstance.on('slideChange', () => {
        updateContentOverlay(swiperInstance.realIndex);
        actualizarBotonEliminar();
      });
    }

    async function cargarImagenes() {
      loader.style.display = 'block';
      try {
        const response = await fetch(`${SCRIPT_URL}?accion=listarAnuncios`);
        const data = await response.json();
        let newAnunciosData = [];

        if (data.url && data.url.length > 0) {
          data.url.forEach((url, index) => {
            newAnunciosData.push({
              titulo: data.titulo[index] || "",
              descripcion: data.descripcion[index] || "",
              comentarios: [],
              url: url,
              deleteurl: data.deleteurl[index] || "",
              autor: data.autor[index] || "",
              correo: data.correo[index] || "",
              fecha: data.fecha[index] || "",
              id: data.id[index] || ""
            });
          });
        }

        newAnunciosData.reverse();
        anunciosData = newAnunciosData;

        const swiperWrapper = document.querySelector('.swiper-wrapper');
        swiperWrapper.innerHTML = '';

        anunciosData.forEach(anuncio => {
          const slide = document.createElement('div');
          slide.classList.add('swiper-slide');
          const zoomContainer = document.createElement('div');
          zoomContainer.classList.add('swiper-zoom-container');
          const img = document.createElement('img');
          img.src = anuncio.url;
          img.alt = anuncio.titulo;
          zoomContainer.appendChild(img);
          slide.appendChild(zoomContainer);
          swiperWrapper.appendChild(slide);
        });

        if (!swiperInstance) {
          initSwiper(0);
        } else {
          swiperInstance.update();
        }
        actualizarBotonEliminar();
      } catch (error) {
        console.error("Error al cargar las im√°genes:", error);
      } finally {
        loader.style.display = 'none';
      }
    }

    async function eliminarAnuncio(anuncioId, deleteUrl) {
      loader.style.display = 'block';
      try {
        const formData = new FormData();
        formData.append('accion', 'eliminarAnuncio');
        formData.append('id', anuncioId);
        formData.append('correo', currentAuthorEmail);
        formData.append('deleteurl', deleteUrl);

        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const result = await response.json();

        if (result.status === "‚úÖ success") {
          alert("Anuncio eliminado correctamente.");
          await cargarImagenes();
        } else {
          alert("No se pudo eliminar el anuncio.");
        }
      } catch (error) {
        console.error("Error eliminando anuncio:", error);
      } finally {
        loader.style.display = 'none';
      }
    }

    cargarImagenes();
  </script>
</body>
</html>
