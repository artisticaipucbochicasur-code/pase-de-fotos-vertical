<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DECOM</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- PWA y Iconos para Android e iOS -->
<link rel="manifest" href="manifest.json">

<!-- Iconos para Android (Chrome) -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<!-- Meta tags para iOS (Safari) -->
<link rel="apple-touch-icon" href="apple-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DECOM">

<!-- Meta para color de barra de estado en Android/iOS -->
<meta name="theme-color" content="#111111">
<meta name="mobile-web-app-capable" content="yes">


  <style>
    html, body { height: 100%; margin: 0; background:#000; overflow:hidden; font-family: Arial, sans-serif; }
    #socialHeader {
      position: fixed; top: 0; left: 0; width: 100%;
      background: linear-gradient(135deg,
        rgba(10,10,20,.98) 0%,
        rgba(20,10,35,.92) 50%,
        rgba(5,15,25,.95) 100%);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      z-index: 999999;
      padding: 8px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,.4);
    }
    .header-content{
      display:flex; justify-content:space-between; align-items:center;
      max-width:1200px; margin:0 auto; padding:0 12px;
    }
    .header-content h1{ color:#fff; font-size:1.4rem; margin:0; letter-spacing:1px; }

    .header-buttons{ display:flex; gap:10px; align-items:center; }

    .header-btn{
      background: rgba(255,255,255,.1);
      color:#fff; border:none; border-radius:50%;
      width:36px; height:36px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.1rem;
      transition: background .2s, transform .15s, box-shadow .2s;
      cursor:pointer;
    }
    .header-btn:hover{ background: rgba(255,255,255,.2); transform: scale(1.06); box-shadow:0 0 8px rgba(255,255,255,.2); }
    .header-btn.selected{
      background:#fff; color:#111;
      box-shadow:0 0 6px rgba(255,255,255,.5);
    }

    /* Avatar en header */
    .feed-user-btn{
      background:#0077cc;color:white;width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;cursor:pointer;user-select:none;
      overflow:hidden;
    }
    .feed-user-btn img{
      width:40px;height:40px;border-radius:50%;
      object-fit:cover;border:2px solid #0077cc;
      display:block;
    }

    #content {
      position: fixed;
      top: 54px;
      left: 0; right: 0; bottom: 0;
      background:#000;
    }

    .viewframe{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
      background:#000;
    }
    .hidden{ display:none; }


    .custom-mostrarAviso {
    background-color: #1e1e1e !important; /* Fondo oscuro */
    color: #fff !important; /* Texto blanco */
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
    max-width: 80%;
    text-align: center;
    border: 1px solid #333; /* Borde gris oscuro */
    display: flex;
    flex-direction: column;
}
    
    .custom-mostrarAviso.confirm-delete {
      width: 300px;
      text-align: center;
    }
    
    .custom-mostrarAviso.confirm-delete .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .custom-mostrarAviso h2 {
    color: #fff !important; /* Blanco para t√≠tulos */
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.5rem;
}

    .custom-mostrarAviso p {
        margin: 0 0 20px;
        white-space: pre-wrap;
    }

   .custom-mostrarAviso button {
    background-color: #2a2a2a !important; /* Gris oscuro */
    color: #fff !important;
    border: 1px solid #444;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease, transform 0.2s ease;
}
    
    .custom-mostrarAviso button:hover {
    background-color: #444 !important; /* Gris un poco m√°s claro */
    transform: scale(1.05);
}


  </style>
</head>

<body>
  <header id="socialHeader">
    <div class="header-content">
      <h1 id="feedTitle">DECOM</h1>

      <div class="header-buttons">
        <!-- Tabs -->
        <button id="tabFotos" class="header-btn selected" title="Im√°genes">
          <i class="fas fa-image"></i>
        </button>

        <button id="tabVideos" class="header-btn" title="Videos">
          <i class="fas fa-video"></i>
        </button>

        <button id="btnEnablePush" class="header-btn" title="Activar notificaciones">
  <i class="fas fa-bell"></i>
</button>


        <!-- Acciones FOTOS -->
        <div id="actionsFotos" style="display:flex; gap:10px; align-items:center;">
          <button id="feedPublishBtnFotos" class="header-btn" title="Publicar">
            <i class="fas fa-plus-circle"></i>
          </button>

          <button id="feedBuscarBtnFotos" class="header-btn" title="Buscar">
            <i class="fas fa-search"></i>
          </button>

          <div id="feedUserBtnFotos" class="feed-user-btn" title="Usuario">U</div>
        </div>

        <!-- Acciones VIDEOS -->
        <div id="actionsVideos" style="display:none; gap:10px; align-items:center;">
          <button id="feedPublishBtnVideos" class="header-btn" title="Publicar">
            <i class="fas fa-plus-circle"></i>
          </button>

          <button id="feedBuscarBtnVideos" class="header-btn" title="Buscar">
            <i class="fas fa-search"></i>
          </button>

          <div id="feedUserBtnVideos" class="feed-user-btn" title="Usuario">U</div>
        </div>
      </div>
    </div>
  </header>

  <div id="content">
    <!-- IMPORTANTE: embed=1 para ocultar headers internos -->
    <iframe id="frameFotos" class="viewframe" src="./fotos.html?embed=1"></iframe>
    <iframe id="frameVideos" class="viewframe hidden" src="./videosSesion2.html?embed=1"></iframe>
  </div>

  <script>


// === üí¨ Aviso elegante, centrado y adaptable a m√≥viles ===
function mostrarAviso(mensaje, tipo = "info") {
  let mostrarAvisoBox = document.getElementById("mostrarAvisoBox");

  if (!mostrarAvisoBox) {
    mostrarAvisoBox = document.createElement("div");
    mostrarAvisoBox.id = "mostrarAvisoBox";
    document.body.appendChild(mostrarAvisoBox);

    Object.assign(mostrarAvisoBox.style, {
      display: "none",
      position: "fixed",
      top: "50%",
      left: "50%",
      transform: "translate(-50%, -50%) scale(0.9)",
      background: "rgba(30, 30, 30, 0.9)",
      color: "#fff",
      padding: "14px 24px",
      borderRadius: "14px",
      boxShadow: "0 8px 25px rgba(0,0,0,0.4)",
      fontWeight: "500",
      fontSize: "15px",
      fontFamily: "Poppins, sans-serif",
      zIndex: "100000",
      opacity: "0",
      transition: "all 0.4s ease",
      textAlign: "center",
      whiteSpace: "nowrap", // ‚úÖ evita salto de l√≠nea
      overflow: "hidden",
      textOverflow: "ellipsis",
      maxWidth: "90vw", // ‚úÖ limita al ancho de pantalla
      letterSpacing: "0.3px",
      backdropFilter: "blur(10px)",
      border: "1px solid rgba(255,255,255,0.1)",
    });
  }

  // üé® Colores neutros seg√∫n tipo
  let bgColor = "rgba(30, 30, 30, 0.9)";
  if (tipo === "error") bgColor = "rgba(50, 50, 50, 0.95)";
  if (tipo === "success") bgColor = "rgba(45, 45, 45, 0.95)";
  if (tipo === "warning") bgColor = "rgba(70, 70, 70, 0.95)";
  if (tipo === "info") bgColor = "rgba(35, 35, 35, 0.9)";

  mostrarAvisoBox.style.background = bgColor;
  mostrarAvisoBox.textContent = mensaje;
  mostrarAvisoBox.style.display = "block";

  // ‚ú® Animaci√≥n elegante
  setTimeout(() => {
    mostrarAvisoBox.style.opacity = "1";
    mostrarAvisoBox.style.transform = "translate(-50%, -50%) scale(1)";
  }, 50);

  // ‚è≥ Desaparici√≥n autom√°tica
  setTimeout(() => {
    mostrarAvisoBox.style.opacity = "0";
    mostrarAvisoBox.style.transform = "translate(-50%, -50%) scale(0.95)";
    setTimeout(() => {
      mostrarAvisoBox.style.display = "none";
    }, 400);
  }, 3000);
}



    // ===== refs =====
    const tabFotos = document.getElementById('tabFotos');
    const tabVideos = document.getElementById('tabVideos');
    const frameFotos = document.getElementById('frameFotos');
    const frameVideos = document.getElementById('frameVideos');

    const actionsFotos  = document.getElementById('actionsFotos');
    const actionsVideos = document.getElementById('actionsVideos');
    const feedTitle = document.getElementById('feedTitle');

    // ===== helpers =====
    function clickInsideFrame(frameEl, selectors) {
      try {
        const doc = frameEl.contentWindow.document;
        for (const sel of selectors) {
          const el = doc.querySelector(sel);
          if (el) { el.click(); return true; }
        }
      } catch (e) {}
      return false;
    }

    // ===== user badge (foto o iniciales) =====
    function getUserDataFromStorage() {
      try { return JSON.parse(localStorage.getItem("usuario") || "{}"); }
      catch { return {}; }
    }

    function getProfilePhotoSrc() {
      const u = getUserDataFromStorage();
      let src = (localStorage.getItem("fotoPerfil") || "").trim();
      if (!src) src = (u.fotoPerfil || u.foto || u.fotoUrl || u.avatar || "").toString().trim();
      if (!src || src === "null" || src === "undefined") return "";
      return src;
    }

    function getInitials() {
      const u = getUserDataFromStorage();
      const name = (u.nombre || u.name || localStorage.getItem("autor") || "Usuario").trim();
      const ini = name.split(" ").filter(Boolean).map(w => w[0]).join("").slice(0,2).toUpperCase();
      return ini || "U";
    }

    function renderUserBadge(el) {
      if (!el) return;
      const src = getProfilePhotoSrc();
      if (src) el.innerHTML = `<img src="${src}" alt="Perfil">`;
      else { el.textContent = getInitials(); el.innerHTML = ""; el.textContent = getInitials(); }
    }

    function syncUserBadge() {
      renderUserBadge(document.getElementById("feedUserBtnFotos"));
      renderUserBadge(document.getElementById("feedUserBtnVideos"));
    }

    // ===== view switching =====
function show(which){
  const isFotos = which === 'fotos';

  frameFotos.classList.toggle('hidden', !isFotos);
  frameVideos.classList.toggle('hidden', isFotos);

  tabFotos.classList.toggle('selected', isFotos);
  tabVideos.classList.toggle('selected', !isFotos);

  actionsFotos.style.display  = isFotos ? 'flex' : 'none';
  actionsVideos.style.display = isFotos ? 'none' : 'flex';

  feedTitle.textContent = 'DECOM';
  localStorage.setItem('decom_tab', which);

  // ‚úÖ Pausar / reanudar videos cuando cambias de pesta√±a
  try {
    if (isFotos) {
      frameVideos.contentWindow.postMessage({ type: "DECOM_HIDE_VIDEOS" }, "*");
    } else {
      frameVideos.contentWindow.postMessage({ type: "DECOM_SHOW_VIDEOS" }, "*");
    }
  } catch (e) {}
}



    // ===== Buttons: publicar/buscar delegan al iframe =====
    document.getElementById('feedPublishBtnFotos').addEventListener('click', (e) => {
      e.preventDefault();
      clickInsideFrame(frameFotos, ['#publishBtn', '[id="publishBtn"]', '.publish-btn', 'button[title*="Public"]']);
    });

    document.getElementById('feedBuscarBtnFotos').addEventListener('click', (e) => {
      e.preventDefault();
      clickInsideFrame(frameFotos, ['#btnBuscar', '[id="btnBuscar"]', '.search-btn', 'button[title*="Buscar"]']);
    });

    document.getElementById('feedPublishBtnVideos').addEventListener('click', (e) => {
      e.preventDefault();
      clickInsideFrame(frameVideos, ['#publishBtn', '[id="publishBtn"]', '.publish-btn', 'button[title*="Public"]']);
    });

    document.getElementById('feedBuscarBtnVideos').addEventListener('click', (e) => {
      e.preventDefault();
      clickInsideFrame(frameVideos, ['#btnBuscar', '[id="btnBuscar"]', '.search-btn', 'button[title*="Buscar"]']);
    });

    // ===== Avatar: abre modal perfil dentro del iframe (NO header, porque est√° oculto) =====
    function openProfileModalInIframe(frameEl) {
      try { frameEl.contentWindow.postMessage({ type: "DECOM_OPEN_PROFILE_MODAL" }, "*"); } catch(e){}
    }

    document.getElementById('feedUserBtnFotos').addEventListener('click', (e) => {
      e.preventDefault();
      try { frameFotos.contentWindow.postMessage({ type: "DECOM_OPEN_USER_MENU" }, "*"); } catch(e){}
    });

document.getElementById('feedUserBtnVideos').addEventListener('click', (e) => {
  e.preventDefault();
  try { frameVideos.contentWindow.postMessage({ type: "DECOM_OPEN_USER_MENU" }, "*"); } catch(e){}
});


    // ===== Tabs =====
    tabFotos.addEventListener('click', () => show('fotos'));
    tabVideos.addEventListener('click', () => show('videos'));

    // ===== init =====
    syncUserBadge();
    setInterval(syncUserBadge, 1500);

 // ===== init (SIEMPRE ejecutar show) =====
const saved = localStorage.getItem('decom_tab');
show(saved === 'videos' ? 'videos' : 'fotos');

    // ‚úÖ Evita audio al inicio: cuando el iframe de videos termine de cargar,
// si est√°s en fotos, forzamos el pause (por si el primer postMessage se perdi√≥).
frameVideos.addEventListener('load', () => {
  try {
    const isFotosNow = !frameFotos.classList.contains('hidden');
    if (isFotosNow) {
      frameVideos.contentWindow.postMessage({ type: "DECOM_HIDE_VIDEOS" }, "*");
    }
  } catch (e) {}
});

    
  // ===========================
  // üîî PUSH: registrar SW + suscribir + guardar en Supabase
  // ===========================

  // 1) Datos de tu Supabase
  const SUPABASE_URL = "https://ipqfccltdzoipcnnppxf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwcWZjY2x0ZHpvaXBjbm5wcHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjY4NTUsImV4cCI6MjA4NDYwMjg1NX0.TSHAiW7OtTLZGbNcDPdcMkjmH5AOjog1Yii5wEjJDKc"; // <-- Settings > API > anon public

  // 2) Tu VAPID PUBLIC KEY (la que te sali√≥: "your application server key is: ...")
  //    Esta ES la PUBLICA (BM_qYc-....)
  const VAPID_PUBLIC_KEY = "BIoRShgewLfWSDCo4EZ4ML7XmlyuvS-kLtxUZSjfvV06FXX3LSbiy8EwLBelf95PS2-AjTuwyXUbFGnl18IHHJ0";

  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

async function registerSW() {
  if (!("serviceWorker" in navigator)) throw new Error("No soporta Service Worker");

  // 1) Registrar (misma ruta que ya usas)
  let reg;
try {
  reg = await navigator.serviceWorker.register("/sw.js");
} catch (e) {
  reg = await navigator.serviceWorker.register("./sw.js");
}

  // 2) Esperar a que quede listo y controlando la p√°gina
  await navigator.serviceWorker.ready;

  // 3) Forzar update suave (no rompe nada)
  try { await reg.update(); } catch(e) {}

  return reg;
}


  async function askPermission() {
    if (!("Notification" in window)) throw new Error("No soporta Notification API");
    const perm = await Notification.requestPermission();
    if (perm !== "granted") throw new Error("Permiso denegado");
    return perm;
  }

async function subscribePush(reg) {
  if (!("PushManager" in window)) throw new Error("No soporta Push API");

  // ‚úÖ Si hay suscripci√≥n vieja (VAPID vieja), la eliminamos
  const existing = await reg.pushManager.getSubscription();
  if (existing) {
    try { await existing.unsubscribe(); } catch (e) {}
  }

  // ‚úÖ Crear una nueva con la VAPID actual
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
  });

  return sub;
}



  function getUserEmailForPush() {
    // En tu app ya guardas cosas en localStorage como "correo" (lo vi en tu l√≥gica)
    // Si no existe, igual guardamos "anon"
    return (localStorage.getItem("correo") || localStorage.getItem("email") || "anon").trim();
  }

  async function saveSubscriptionToSupabase(sub) {
    const json = sub.toJSON();

    const payload = {
      endpoint: json.endpoint,
      p256dh: json.keys?.p256dh || "",
      auth: json.keys?.auth || "",
      user_email: getUserEmailForPush(),
      user_agent: navigator.userAgent,
      updated_at: new Date().toISOString(),
    };

    // UPSERT por endpoint (si ya existe, lo actualiza)
    const url = `${SUPABASE_URL}/rest/v1/push_subscriptions?on_conflict=endpoint`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json",
        "Prefer": "resolution=merge-duplicates,return=representation",
      },
      body: JSON.stringify(payload),
    });

    const text = await res.text();
    if (!res.ok) throw new Error(`Supabase REST error ${res.status}: ${text}`);
    return text;
  }

  async function enablePushFlow() {
    const btn = document.getElementById("btnEnablePush");
    if (btn) btn.disabled = true;

    try {
      const reg = await registerSW();
      await askPermission();
      const sub = await subscribePush(reg);
      await saveSubscriptionToSupabase(sub);

      mostrarAviso("‚úÖ Notificaciones activadas. Ya guard√© tu suscripci√≥n.");
      console.log("‚úÖ Push subscription guardada");
    } catch (e) {
      console.error(e);
      mostrarAviso("‚ùå No se pudo activar push: " + (e?.message || e));
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  // Hook del bot√≥n
  const btnEnablePush = document.getElementById("btnEnablePush");
  if (btnEnablePush) {
    btnEnablePush.addEventListener("click", (e) => {
      e.preventDefault();
      enablePushFlow();
    });
  }


  function applyDeepLinkFromUrl(u) {
  try {
    const url = new URL(u, location.origin);
    const tab = url.searchParams.get("tab");
    if (tab === "videos" || tab === "fotos") show(tab);
  } catch {}
}

// Si llega un mensaje desde el Service Worker al tocar una notificaci√≥n
if (navigator.serviceWorker) {
  navigator.serviceWorker.addEventListener("message", (event) => {
    if (event.data?.type === "DECOM_PUSH_OPEN" && event.data?.url) {
      applyDeepLinkFromUrl(event.data.url);
    }
  });
}

// Si la app se abri√≥ desde cero con ?tab=...
applyDeepLinkFromUrl(location.href);


  </script>
</body>
</html>
