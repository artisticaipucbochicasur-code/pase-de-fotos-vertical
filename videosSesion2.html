
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PWA y Iconos para Android e iOS -->
    <link rel="manifest" href="manifest.json">

    <!-- Iconos para Android (Chrome) -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- Meta tags para iOS (Safari) -->
    <link rel="apple-touch-icon" href="apple-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DECOM">

    <!-- Meta para color de barra de estado en Android/iOS -->
    <meta name="theme-color" content="#111111">

    <meta name="mobile-web-app-capable" content="yes">

    <title>DECOM - Videos</title> <!-- T√≠tulo espec√≠fico para evitar que la URL se use como t√≠tulo impl√≠cito -->

   
</head>
    <style>

        :root {
            --bg1: #000;
            --bg2: #000;
            --text: #fff;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            font-family: "Segoe UI", Arial, sans-serif;
            color: var(--text);
            overflow: hidden;
        }

   /* Botones flotantes */
.floating-buttons {
    position: fixed;
    bottom: 400px;
    right: 18px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 2000;
}
.fab {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
    color: white;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}
.fab.danger {}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}
.modal-actions button {
    flex: 1;
}

/* Modal */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
}
.modal.hidden { display: none; }
.modal-content {
    background: #111;
    padding: 20px;
    border-radius: 10px;
    width: 300px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    color: #fff;
}
.modal-content input { padding: 6px; }

/* Progreso flotante */
.progress-toast {
    position: fixed;
    top: 15px;
    right: 15px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 10px 14px;
    border-radius: 6px;
    z-index: 4000;
    width: 200px;
}
.progress-toast.hidden { display: none; }
.progress-toast .bar {
    height: 4px;
    background: #28a745;
    width: 0%;
    margin-bottom: 6px;
    transition: width 0.3s ease;
}

.swiper {
    width: 100vw;
    height: 100vh;
    position: relative;
}

.swiper-slide {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: stretch;
    position: relative;
    background: #000;
}

.player-card {
    position: relative;
    width: 100%;
    height: 100vh;
    background: #000;
    overflow: hidden;
    box-shadow: var(--card-shadow);
    border-radius: 10px;
}

.poster {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #111;
    background-size: cover;
    background-position: center center;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
}

.play-btn {
    display: grid;
    place-items: center;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(2px);
    font-size: 28px;
    line-height: 1;
    border: 2px solid #fff;
}

.player-iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
    background: #000;
}

/* Truncamiento para el contenedor del t√≠tulo y la descripci√≥n */
#video-title-fixed .text-container {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2; /* Truncar a 2 l√≠neas por defecto */
    transition: -webkit-line-clamp 0.3s ease;
    cursor: pointer;
    position: relative;
    max-height: 4em;
    line-height: 1.2;
}

#video-title-fixed .text-container.expanded {
    -webkit-line-clamp: unset;
    cursor: pointer;
    overflow-y: auto;
    max-height: 60vh;
    padding-right: 15px;
}

#video-title-fixed .toggle-text {
    color: #ccc;
    font-size: 12px;
    font-weight: bold;
    user-select: none;
    display: inline-block;
    margin-left: 6px;
    cursor: pointer;
    background: none !important; /* üëà sin fondo */
    padding: 0;
}


#video-title-fixed {
    position: absolute;
    top: 60px; /* Bajado para estar debajo del encabezado */
    left: 0; /* alineado a la izquierda */
    width: 100%; /* ocupa todo el ancho */
    max-width: 100%; /* no limitar */
    z-index: 1000;
    background: rgba(0,0,0,0.3);
    transition: opacity 0.18s ease;
    opacity: 1;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 6px 10px;
    margin: 0;
    border-bottom-left-radius: 6px; /* üëå opcional */
    border-bottom-right-radius: 6px; /* üëå opcional */
}




#video-title-fixed .video-title {
    font-size: 18px;
    font-weight: 600;
    text-align: left;
    color: #f1f1f1;
}

#video-title-fixed .video-desc {
    font-size: 14px;
    opacity: 0.85;
    text-align: left;
    color: #ddd;
}

/* üîî Notificaciones */
#notification-wrapper {
    position: fixed;
    right: 20px;
    bottom: 195px;
    z-index: 5000;
}

#notification-btn {
    position: relative;
    background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

#notification-count {
    display: none;
    position: absolute;
    top: -5px;
    right: -5px;
    background: red;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 50%;
}

#notification-list {
    position: absolute;
    top: 55px;
    right: 0;
    background: #222;
    border: 1px solid #444;
    border-radius: 10px;
    width: 260px;
    max-height: 320px;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
}
#notification-list.hidden { display: none; }
#notification-list div {
    padding: 10px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    color: #ddd;
}
#notification-list div:hover {
    background: #333;
}

#loader {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    z-index: 10;
    color: #fff;
    text-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
#loader .spinner {
    display: inline-block;
    animation: spin 1.1s linear infinite;
}

.touch-blocker {
    position: absolute;
    inset: 0;
    z-index: 1;
    display: none;
}

.controls-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 5;
    transition: opacity 0.3s ease;
    opacity: 0;
}

.player-card:hover .controls-bar {
    opacity: 1;
}

.center-play-pause-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: grid;
    place-items: center;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.55);
    border: 2px solid #fff;
    color: #fff;
    font-size: 28px;
    cursor: pointer;
    z-index: 6;
    transition: opacity 0.3s ease;
    opacity: 0;
}

.player-card:hover .center-play-pause-btn {
    opacity: 1;
}

.play-pause-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
}

.progress-bar {
    flex-grow: 1;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    cursor: pointer;
}
.progress {
    height: 100%;
    width: 0%;
    background: #ff0000;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 5px;
}
.volume-control input[type="range"] {
    width: 60px;
    -webkit-appearance: none;
    background: transparent;
}
.volume-control input[type="range"]::-webkit-slider-runnable-track {
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 1.5px;
}
.volume-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 12px;
    width: 12px;
    border-radius: 50%;
    background: #fff;
    margin-top: -4.5px;
}
.volume-icon {
    font-size: 20px;
}

.time {
    font-size: 12px;
    color: #fff;
}

/* Contenedor de comentarios */
.comments-overlay-container {
  position: fixed;
  bottom: 90px; /* üëà ahora justo arriba de la barra de escribir */
  left: 10px;
  width: calc(80% - 20px);
  background: rgba(0, 0, 0, 0.2); /* m√°s transparente */
  color: #eee;
  padding: 8px;
  border-radius: 5px;
  box-sizing: border-box;
  z-index: 998;
  overflow-y: auto;
  transition: opacity 0.3s ease, visibility 0.3s ease, max-height 0.3s ease;
  max-height: 4em;
  white-space: normal;
  word-wrap: break-word;
  overflow-wrap: break-word;
}


  /* expandido */
.comments-overlay-container.expanded {
  max-height: 70vh;
}
    /* Estilos para la lista de comentarios */
    .comments-overlay-container ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    /* Estilos para cada comentario individual */
    .comments-overlay-container li {
        font-size: 0.8rem;
        line-height: 1.2;
        margin-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 8px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
    }

    .comments-overlay-container li:last-child {
      border-bottom: none;
    }
    
    /* Estilo para los comentarios que se pueden borrar */
    .comments-overlay-container li.deletable {
        cursor: pointer;
    }
    
    /* Contenedor del bot√≥n de borrado */
    .delete-btn-container {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e74c3c;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 0; 
    }
    
    /* Bot√≥n de borrado en s√≠ mismo */
    .delete-btn {
        color: white;
        font-weight: bold;
        padding: 10px;
        cursor: pointer;
        user-select: none;
    }
    
    /* El comentario se desliza */
    .comment-content {
      width: 100%;
      padding-left: 10px;
      padding-right: 10px;
      box-sizing: border-box;
      transition: transform 0.3s ease;
      position: relative;
      z-index: 1;
    }
    
    .comment-content.swiped {
      transform: translateX(100px);
    }
    
    .delete-btn-container.visible {
        transform: translateX(0);
    }
    
    /* Clase para ocultar los overlays */
.hidden-overlay {
  opacity: 0 !important;
  pointer-events: none !important;
  transition: opacity 0.3s;
}



    /* Estilos del nuevo contador de comentarios */
.comments-counter {
  position: fixed;
  bottom: 140px;
  right: 20px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  z-index: 999;
}

.comments-counter .icon {
  font-size: 24px;
  line-height: 1;
}

.comments-counter span#commentCountValue {
  display: none;
  position: absolute;
  bottom: -10px; /* Posiciona el n√∫mero debajo del c√≠rculo */
  left: -10px; /* Posiciona el n√∫mero a la izquierda */
  background: rgba(255, 255, 255, 0.1); /* Mismo fondo desenfocado que el c√≠rculo principal */
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  font-size: 12px;
  font-weight: bold;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ‚ù§Ô∏è Contador de Me gusta (mismo estilo que comentarios) */
.likes-counter {
  position: fixed;
  bottom: 350px;
  right: 20px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  z-index: 999;
}

.likes-counter .icon {
  font-size: 24px;
  line-height: 1;
}

.likes-counter span#likeCountValue {
  display: none;
  position: absolute;
  bottom: -10px;
  left: -10px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  font-size: 12px;
  font-weight: bold;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
    
    .comments-counter .count {
        font-size: 0.9rem;
    }

/* Barra de entrada de comentarios */
.comment-input-container {
  position: fixed;
  bottom: 39px;
  left: 0;
  width: 100%;
  background: transparent;
  padding: 8px 12px;
  box-sizing: border-box;
  z-index: 1000;
}



    
    .comment-input-container .send-comment-btn:hover {
        background: transparent;
    }

/* ‚úÖ Nuevo dise√±o: √≥valo transl√∫cido */
.comment-input-wrapper {
  display: flex;
  align-items: center;
  background: rgba(255, 255, 255, 0.1); /* üëà blanco transparente */
  border: 1.5px solid rgba(255, 255, 255, 0.4); /* üëà borde transl√∫cido */
  border-radius: 25px;   /* ovalado completo */
  width: 95%;            /* üëà ancho controlado */
  margin: 0 auto;        /* üëà centrado */
  padding: 4px 8px;      /* üëà menos alto */
  backdrop-filter: blur(3px); /* üëà efecto vidrio esmerilado */
}



.comment-input-wrapper input {
  flex-grow: 1;
  background: transparent;
  border: none;          /* üëà quita borde extra */
  outline: none;
  padding: 6px 8px;      /* üëà m√°s compacto */
  font-size: 0.9rem;
  color: white;
}

.comment-input-wrapper input::placeholder {
  color: rgba(255,255,255,0.7);
}

.comment-input-wrapper button {
  background: transparent;
  border: none;
  color: white;
  font-size: 1.2rem;    /* üëà tama√±o justo */
  cursor: pointer;
  padding: 4px 6px;
}
/* Oculta el modal por defecto */
.hidden {
  display: none !important;
}

/* Fondo oscuro al abrir modal */
#search-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: flex-start; /* üëà arriba */
  justify-content: center;
  padding-top: 40px;       /* üëà separaci√≥n desde arriba */
  z-index: 9999;
}


/* Contenedor del modal */
#search-modal .modal-content {
  background: #111;
  color: #fff;
  padding: 15px;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

/* Input */
#search-input {
  width: 100%;
  padding: 6px;
  margin-bottom: 10px;
  background: #222;
  border: 1px solid #444;
  color: white;
  border-radius: 5px;
}

/* Lista de resultados */
#search-results {
  max-height: 150px;
  overflow-y: auto;
  list-style: none;
  padding: 0;
  margin: 0;
}

#search-results li {
  padding: 8px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

#search-results li:hover {
  background: #333;
}

/* Bot√≥n cerrar */
#search-close {
  background: #444;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 5px;
  cursor: pointer;
}
/* Clase para resaltar t√≠tulo al saltar desde buscador */
/* Resaltado temporal para el contenedor de t√≠tulo */
#video-title-fixed.highlight-container {
  background: rgba(77, 163, 255, 0.35); /* azul suave transl√∫cido */
  transition: background 0.5s ease;
}

.refresh-btn {
    position: fixed;
    bottom: 250px; /* üîπ Un poco m√°s arriba que la campana */
    right: 18px;
    width: 40px; /* Igual que .fab */
    height: 40px; /* Igual que .fab */
    border-radius: 50%;
    border: none;
   background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
    color: white; /* √çcono blanco */
    font-size: 24px; /* Igual que .fab */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Igual que .fab */
    z-index: 2000;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.refresh-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.5);
}

/* ‚ú® Resaltado temporal + zoom del t√≠tulo */
.highlight-title-zoom {
    background-color: rgba(0, 150, 255, 0.3);
    padding: 3px 6px;
    border-radius: 5px;
    animation: highlightZoom 0.4s ease-in-out;
    transition: background-color 1s ease;
}

/* üé• Animaci√≥n de zoom */
@keyframes highlightZoom {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
    }
}

    #savedList {
    scroll-behavior: smooth;
}



body {
  margin: 0;
  padding: 0;
  background: #111;
  font-family: Arial, sans-serif;
  color: white;
  transition: transform 0.3s ease;
}

/* Estilos para el encabezado */
#socialHeader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
 background: linear-gradient(135deg, 
              rgba(10, 10, 20, 0.98) 0%, 
              rgba(20, 10, 35, 0.92) 50%, 
              rgba(5, 15, 25, 0.95) 100%);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 10001; /* M√°s alto que el resto de los overlays */
  padding: 8px 0; /* Reducido para un look m√°s compacto */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); /* Sombra m√°s sutil */
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 12px; /* Reducido para consistencia */
}

.header-content h1 {
  color: white;
  font-size: 1.4rem; /* Ligeramente m√°s peque√±o */
  margin: 0;
  font-weight: 600; /* Menos agresivo que bold */
  letter-spacing: 1px; /* Espaciado para elegancia */
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
}

.header-buttons {
  display: flex;
  gap: 8px; /* Espaciado m√°s ajustado */
}

.header-btn {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: none; /* Sin borde para un look m√°s limpio */
  border-radius: 50%; /* Botones circulares */
  width: 36px; /* Tama√±o fijo para √≠conos */
  height: 36px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.1rem; /* Tama√±o del √≠cono */
  text-decoration: none;
  transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
}

.header-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1); /* Efecto sutil de aumento */
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); /* Brillo suave */
}

.header-btn.selected {
  background: #ffffff; /* Fondo blanco */
  color: #111111; /* √çcono oscuro */
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.5); /* Sombra para destacar */
  font-weight: bold; /* Mantenido para consistencia */
}

.header-btn.selected:hover {
  background: #e0e0e0; /* Ligeramente m√°s oscuro al pasar el rat√≥n */
  transform: scale(1); /* Evitar zoom al estar seleccionado */
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
  .header-content {
    flex-direction: row; /* Mantener en fila para ahorrar espacio */
    gap: 8px;
  }

  .header-content h1 {
    font-size: 1.2rem; /* M√°s peque√±o en m√≥viles */
  }

  .header-buttons {
    gap: 6px; /* Menos espacio entre botones */
  }

  .header-btn {
    width: 32px; /* Botones m√°s peque√±os */
    height: 32px;
    font-size: 1rem; /* √çconos m√°s peque√±os */
  }
}

          /* === BOTONES INTERACTIVOS LOGIN / REGISTRO === */
#btnLogin, #btnRegistro {
  background: linear-gradient(135deg, #007bff, #00c6ff);
  border: none;
  color: white;
  font-weight: 600;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

#btnLogin:hover, #btnRegistro:hover {
  transform: scale(1.04);
  box-shadow: 0 5px 12px rgba(0, 150, 255, 0.4);
}

#btnLogin:active, #btnRegistro:active {
  transform: scale(0.96);
  background: linear-gradient(135deg, #0062cc, #0094cc);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2) inset;
}

#btnLogin:disabled, #btnRegistro:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  box-shadow: none;
}


    /* === EFECTO RIPPLE ELEGANTE === */
.ripple {
  position: absolute;
  border-radius: 50%;
  transform: scale(0);
  animation: ripple-anim 0.6s linear;
  background: rgba(255, 255, 255, 0.5);
  pointer-events: none;
  z-index: 2;
}

#btnLogin, #btnRegistro {
  position: relative;
  overflow: hidden;
}

@keyframes ripple-anim {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

    .toggle-pin {
  transition: transform 0.2s ease, color 0.3s ease;
}
.toggle-pin:hover {
  transform: scale(1.1);
}
.toggle-pin.active {
  color: #00a2ff;
  text-shadow: 0 0 6px rgba(0,162,255,0.6);
}
     

#statusText, #progressText {
  color: #111 !important;
  font-weight: 600;
}


        body.embedded #socialHeader { display: none !important; }

  /* Ajuste: overlays que estaban calculados para header */
  body.embedded .content-overlay { top: 10px !important; }


    

/* === Animaciones para men√∫ lateral (igual que fotos) === */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideInRight { from { transform: translateX(30px); opacity: 0.7; } to { transform: translateX(0); opacity: 1; } }

/* üåë Tema oscuro global suave y moderno ‚Üí ahora Google Dark exacto */
.dark-mode {
  background-color: #121212;      /* antes #0f172a */
  color: #e8eaed;                  /* antes #e2e8f0 */
}

/* Ajustes espec√≠ficos para el men√∫ lateral en dark mode */
.dark-mode #userMenu > div {
  background: rgba(31, 31, 31, 0.98) !important;  /* #1f1f1f con opacidad */
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.08);
}

.dark-mode .menu-btn {
  background: rgba(30, 41, 59, 0.7) !important;
  color: #cbd5e1 !important;
}

.dark-mode .menu-btn:hover {
  background: rgba(51, 65, 85, 0.9) !important;
  transform: translateY(-2px);
}

.dark-mode #userName { color: #f1f5f9; }
.dark-mode #userEmail { color: #94a3b8; }

/* Bot√≥n WhatsApp mantiene su color verde incluso en dark mode */
.dark-mode .menu-btn.whatsapp {
  background: #25D366 !important;
  color: white !important;
}

/* Logout en rojo oscuro */
.dark-mode .menu-btn.logout {
  background: rgba(254, 226, 226, 0.2) !important;
  color: #fca5a5 !important;
}
.dark-mode .menu-btn.logout:hover {
  background: #ef4444 !important;
  color: white !important;
}


          /* =========================================================
     FIX UI - MODO OSCURO: textos claros en el men√∫ (VIDEOS)
     y WhatsApp sin "contenedor"
     (No afecta fotos; solo aplica cuando se activa dark mode)
  ========================================================= */

  /* Detectores comunes de dark mode (por si usas distintas clases) */
  :root :is(body.dark, body.dark-mode, body.tema-oscuro, body[data-theme="dark"]) #userMenu {
    /* Si tu panel ya cambia color, esto no lo rompe; solo asegura contraste */
    color: #fff !important;
  }

  /* Texto: nombre y correo */
  :root :is(body.dark, body.dark-mode, body.tema-oscuro, body[data-theme="dark"]) #userMenu #userName,
  :root :is(body.dark, body.dark-mode, body.tema-oscuro, body[data-theme="dark"]) #userMenu #userEmail {
    color: #fff !important;
    opacity: 0.92;
  }

  /* Texto de botones del men√∫ */
  :root :is(body.dark, body.dark-mode, body.tema-oscuro, body[data-theme="dark"]) #userMenu button.menu-btn,
  :root :is(body.dark, body.dark-mode, body.tema-oscuro, body[data-theme="dark"]) #userMenu button.menu-btn span {
    color: #fff !important;
  }

  /* Iconos en dark (suaviza un poco, pero visibles) */
  :root :is(body.dark, body.dark-mode, body.tema-oscuro, body[data-theme="dark"]) #userMenu button.menu-btn i {
    color: rgba(255,255,255,0.85) !important;
  }

/* =========================================================
   FIX WhatsApp icon: sin fondo en CLARO y OSCURO
   (no afecta otros botones)
========================================================= */

/* Normaliza el bot√≥n WhatsApp (no toca estilo del bot√≥n, solo el icono) */
#userMenu #whatsappBtn i,
#userMenu #whatsappBtn i::before,
#userMenu #whatsappBtn i::after {
  background: transparent !important;
  box-shadow: none !important;
  border: none !important;
  outline: none !important;
  border-radius: 0 !important;
}

/* Alineaci√≥n consistente del icono */
#userMenu #whatsappBtn i {
  padding: 0 !important;
  width: 20px;
  min-width: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* üëá EXTRA: algunos estilos globales meten "cuadro" con filter o backdrop */
#userMenu #whatsappBtn i {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  filter: none !important;
}

 /* ‚úÖ Ocultar header interno de videos */
  body.embedded #socialHeader{
    display: none !important;
  }

  /* ‚úÖ Evita dejar espacio por el header */
  body.embedded{
    padding-top: 0 !important;
    margin-top: 0 !important;
  }

  /* ‚úÖ En videos tienes un titulo fijo arriba (#video-title-fixed)
     que normalmente arranca en top:60px
     si se oculta el header, lo subimos para que quede bien */
  body.embedded #video-title-fixed{
    top: 10px !important;
  }

  /* ‚úÖ Tambi√©n el overlay (por si lo usas) */
  body.embedded .content-overlay{
    top: 10px !important;
  }

        
</style>
</head>
<body>

<!-- üîπ Modal de Publicar (Anuncio / Video) -->
<div id="publishModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(3px);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    border-radius:16px;
    width:90%;
    max-width:520px;
    padding:20px;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
    position:relative;
  ">
    <button id="closePublishModal" style="
      position:absolute;
      top:10px; right:15px;
      background:none;
      border:none;
      font-size:22px;
      cursor:pointer;
      color:#333;
    ">√ó</button>

    <h2 style="text-align:center;color:#0077cc;">Publicar Contenido</h2>

    <!-- üîπ Selector de tipo -->
    <div style="display:flex;gap:10px;margin-top:15px;justify-content:center;">
      <button id="tabAnuncio" style="flex:1;padding:10px;border:none;border-radius:8px;background:#0077cc;color:white;cursor:pointer;font-weight:bold;">üì∞ Anuncio</button>
      <button id="tabVideo" style="flex:1;padding:10px;border:none;border-radius:8px;background:#ccc;color:#333;cursor:pointer;font-weight:bold;">üé• Video</button>
    </div>

    <!-- üîπ Secci√≥n de Anuncio -->
    <div id="anuncioSection" style="margin-top:15px;">
      <label style="font-weight:600;display:block;margin-top:10px;">T√≠tulo</label>
      <input type="text" id="titulo" placeholder="Escribe un t√≠tulo" required style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px;margin-top:5px;" />

      <label style="font-weight:600;display:block;margin-top:10px;">Descripci√≥n</label>
      <textarea id="descripcion" rows="4" placeholder="Describe tu anuncio..." required style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px;margin-top:5px;"></textarea>

     <label style="font-weight:600;display:block;margin-top:10px;">Imagen</label>
<div style="display:flex;align-items:center;gap:10px;">
  <input type="file" id="imagen" accept="image/*" style="flex:1;margin-top:5px;" />
  <button id="abrirCamaraImg" title="Abrir c√°mara" 
    style="background:none;border:none;cursor:pointer;font-size:22px;color:#0077cc;">
    <i class="fas fa-camera"></i>
  </button>
</div>

      <div style="margin-top:10px;text-align:center;">
        <img id="previewImg" src="" style="max-width:100%;border-radius:12px;display:none;" />
      </div>

      <div id="progressContainer" style="width:100%;background:#eee;border-radius:8px;margin-top:15px;height:10px;display:none;">
        <div id="progressBar" style="width:0%;height:10px;background:#0077cc;border-radius:8px;transition:width 0.3s;"></div>
      </div>

      <button id="btnPublicar" style="background:#0077cc;color:white;padding:12px;border:none;width:100%;border-radius:8px;margin-top:20px;font-size:16px;cursor:pointer;">üì§ Publicar Anuncio</button>
      <div id="mensaje" style="margin-top:15px;text-align:center;font-weight:bold;"></div>
    </div>

    <!-- üîπ Secci√≥n de Video -->
    <div id="videoSection" style="display:none;margin-top:15px;">
      <label style="font-weight:600;display:block;margin-top:10px;">T√≠tulo del Video</label>
      <input type="text" id="videoTitle" placeholder="Escribe el t√≠tulo" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px;margin-top:5px;" />

      <label style="font-weight:600;display:block;margin-top:10px;">Descripci√≥n</label>
      <textarea id="videoDescripcion" rows="3" placeholder="Describe tu video..." style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:15px;margin-top:5px;"></textarea>

     <label style="font-weight:600;display:block;margin-top:10px;">Archivo de Video</label>
<div style="display:flex;align-items:center;gap:10px;">
  <input type="file" id="fileInput" accept="video/*" style="flex:1;margin-top:5px;" />
  <button id="abrirCamaraVideo" title="Grabar video" 
    style="background:none;border:none;cursor:pointer;font-size:22px;color:#6b46c1;">
    <i class="fas fa-video"></i>
  </button>
</div>

<!-- ‚úÖ Compresi√≥n opcional antes de subir (reduce peso para evitar cortes al reproducir) -->
<div style="margin-top:10px;max-width:100%;">
  <label style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;width:100%;font-size:13px;color:#333;line-height:1.2;">
    <input type="checkbox" id="compressBeforeUpload" checked style="margin:0;">
    <span>Comprimir antes de subir (recomendado)</span>
  </label>
  <div style="font-size:12px;color:#555;margin-top:4px;line-height:1.2;">
    Si tu celular es lento o el video es muy largo, puedes desactivar esta opci√≥n.
  </div>
</div>


      <div id="progressContainerVideo" style="width:100%;background:#eee;border-radius:8px;margin-top:15px;height:10px;display:none;">
        <div id="progressVideo" style="width:0%;height:10px;background:#6b46c1;border-radius:8px;transition:width 0.3s;"></div>
      </div>

      <div id="uploadMetricsVideo" style="margin-top:10px;text-align:center;font-size:13px;color:#555;"></div>

      <button id="btnUploadVideo" style="background:#6b46c1;color:white;padding:12px;border:none;width:100%;border-radius:8px;margin-top:20px;font-size:16px;cursor:pointer;">üì§ Subir Video</button>

      <div id="statusVideo" style="margin-top:15px;text-align:center;font-weight:bold;"></div>
    </div>
  </div>
</div>



    
<header id="socialHeader">
  <div class="header-content" style="display:flex;align-items:center;justify-content:space-between;">
    <h1>DECOM</h1>

    <div class="header-buttons" style="display:flex;align-items:center;gap:10px;">
    <a href="./fotos.html" class="header-btn" title="Im√°genes">
  <i class="fas fa-image"></i>
</a>

    <button id="videoBtn" class="header-btn selected" title="Videos" style="position: relative;">
        <i class="fas fa-video"></i>
      </button>
        


      <a href="#" class="header-btn" id="publishBtn" title="Publicar">
        <i class="fas fa-plus-circle"></i>
      </a>
<button id="btnBuscar" class="header-btn" title="Buscar anuncios">
  <i class="fas fa-search"></i>
</button>

  <!-- üîπ Bot√≥n de usuario -->
      <div id="userMenuContainer" style="position:relative;">
        <div id="userBtn" 
             style="background:#0077cc;color:white;width:40px;height:40px;border-radius:50%;
                    display:flex;align-items:center;justify-content:center;
                    font-weight:bold;cursor:pointer;">
        </div>

      <!-- Panel lateral moderno 2025 - VERSI√ìN FINAL MINIMALISTA -->
      <div id="userMenu" style="
          display:none;
          position:fixed;
          top:0; left:0; right:0; bottom:0;
          background: rgba(15, 23, 42, 0.70);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          z-index:9999;
          animation: fadeIn 0.25s ease-out;
      ">
        <div style="
          position:absolute;
          top:70px; right:0;
          width:340px; max-width:90vw;
          height:calc(100vh - 90px);
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border-radius: 20px 0 0 20px;
          box-shadow: -10px 0 40px rgba(0,0,0,0.3);
          padding:30px 24px;
          overflow-y:auto;
          animation: slideInRight 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
        ">
          <!-- Bot√≥n cerrar (X) -->
          <button onclick="document.getElementById('userMenu').style.display='none'"
                  style="position:absolute; top:16px; right:16px; background:none; border:none; font-size:24px; cursor:pointer; color:#64748b; padding:8px; border-radius:50%;">
            <i class="fas fa-xmark"></i>
          </button>

          <!-- Cerrar sesi√≥n arriba a la izquierda -->
          <button id="logoutBtn" style="position:absolute; top:16px; left:16px; background:none !important; border:none !important; color:#ef4444; font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px; cursor:pointer;">
            <i class="fas fa-arrow-right-from-bracket"></i>
            <span>Cerrar sesi√≥n</span>
          </button>

          <!-- Foto y datos -->
          <div style="text-align:center; margin:60px 0 30px;">
            <div id="userMenuPhoto" style="width:96px; height:96px; border-radius:50%; margin:0 auto 16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; font-size:36px; font-weight:bold; color:white; box-shadow:0 8px 25px rgba(102,126,234,0.4); overflow:hidden; border:4px solid rgba(255,255,255,0.3);">
              <img src="ruta-de-tu-foto.jpg" style="width:100%; height:100%; object-fit:cover;" alt="Foto">
            </div>
            <p id="userName" style="margin:0; font-weight:700; font-size:20px; color:#1e293b;"></p>
            <p id="userEmail" style="margin:6px 0 0; font-size:14px; color:#64748b;"></p>
          </div>

          <style>
            #userMenu button.menu-btn,
            #userMenu button:not(#logoutBtn):not([onclick*="display='none'"]) {
              background: transparent !important;
              border: none !important;
              padding: 10px 0 !important;
              margin-bottom: 16px !important;
              display: flex !important;
              align-items: center !important;
              gap: 14px !important;
              font-size: 15px !important;
              font-weight: 500 !important;
              color: #475569 !important;
              width: 100% !important;
            }
            #userMenu button.menu-btn i {
              width: 20px !important;
              text-align: center !important;
              font-size: 18px !important;
              color: #64748b !important;
            }
          </style>

          <!-- Botones -->
          <button class="menu-btn">
            <i class="fas fa-user-circle"></i>
            <span>Mi perfil</span>
          </button>

          <button class="menu-btn">
            <i class="fas fa-bell"></i>
            <span>Notificaciones</span>
          </button>

          <button id="themeToggle" class="menu-btn">
            <i class="fas fa-sun" id="themeIcon"></i>
            <span id="themeText">Tema claro</span>
          </button>

          <button id="whatsappBtn" class="menu-btn">
            <i class="fab fa-whatsapp"></i>
            <span>Soporte</span>
          </button>

          <div style="text-align:center; color:#94a3b8; font-size:12px; margin-top:10px; padding-top:20px; border-top:1px solid #e2e8f0;">
            v2.4.1 ‚Ä¢ ¬© 2025 DECOM
          </div>
        </div>
      </div>

      </div>
    </div>
  </div>
</header>


<div id="loginModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); z-index:999; justify-content:center; align-items:center;">
  <div style="background:white; padding:25px; border-radius:15px; width:320px; max-height:90vh; overflow-y:auto; text-align:center; font-family:Arial,sans-serif;">
    
    <!-- Pesta√±as -->
    <div style="display:flex; margin-bottom:15px; border-bottom:1px solid #ddd;">
      <button id="tabLogin" class="tab-btn active" style="flex:1; padding:10px; border:none; background:none; font-weight:bold;">Iniciar Sesi√≥n</button>
      <button id="tabRegistro" class="tab-btn" style="flex:1; padding:10px; border:none; background:none;">Registrarse</button>
    </div>

    <!-- Formulario Login -->
    <div id="formLogin">
      <h3>üîê Iniciar Sesi√≥n</h3>
      <input id="loginCorreo" type="email" placeholder="Correo electr√≥nico" style="width:100%; margin:10px 0; padding:10px; border-radius:8px; border:1px solid #ccc;">

      <div style="position:relative;">
        <input id="loginPin" type="password" placeholder="PIN (M√≠nimo 4 caracteres)" minlength="4"
               style="width:100%; margin:10px 0; padding:10px 35px 10px 10px; border-radius:8px; border:1px solid #ccc;">
        <i class="fa-solid fa-eye toggle-pin" data-target="loginPin"
           style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#0077cc;"></i>
      </div>

      <button id="btnLogin" style="width:100%; padding:12px; margin-top:15px; background:#0077cc; color:white; border:none; border-radius:8px; font-weight:bold;">Entrar</button>
      <p style="margin-top:10px; font-size:13px; color:#666;">
        ¬øNo tienes cuenta? <a href="#" id="irARegistro" style="color:#0077cc; text-decoration:underline;">Reg√≠strate aqu√≠</a>
      </p>
      <p style="margin-top:8px; font-size:13px; color:#0077cc; cursor:pointer;" id="olvidastePin">
        ¬øOlvidaste tu PIN?
      </p>
    </div>

    <!-- Formulario Registro -->
    <div id="formRegistro" style="display:none;">
      <h3>‚ú® Crear Cuenta</h3>
      <input id="regNombre" type="text" placeholder="Tu nombre completo" style="width:100%; margin:10px 0; padding:10px; border-radius:8px; border:1px solid #ccc;">
      <input id="regCorreo" type="email" placeholder="Correo electr√≥nico" style="width:100%; margin:10px 0; padding:10px; border-radius:8px; border:1px solid #ccc;">
      
      <div style="position:relative;">
        <input id="regPin" type="password" placeholder="Crea un PIN (M√≠nimo 4 caracteres)" minlength="4"
               style="width:100%; margin:10px 0; padding:10px 35px 10px 10px; border-radius:8px; border:1px solid #ccc;">
        <i class="fa-solid fa-eye toggle-pin" data-target="regPin"
           style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#0077cc;"></i>
      </div>

      <div style="position:relative;">
        <input id="regPinConfirm" type="password" placeholder="Confirma tu PIN" minlength="4"
               style="width:100%; margin:10px 0; padding:10px 35px 10px 10px; border-radius:8px; border:1px solid #ccc;">
        <i class="fa-solid fa-eye toggle-pin" data-target="regPinConfirm"
           style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#0077cc;"></i>
      </div>
      
      <div style="margin:15px 0; text-align:left; font-size:13px;">
        <label>Foto de perfil:</label>
        <input id="regFoto" type="file" accept="image/*" style="width:100%; padding:8px; border:1px dashed #ccc; border-radius:8px;">
        <div id="previewContainer" style="margin-top:10px; text-align:center; display:none;">
          <img id="fotoPreview" src="" style="width:80px; height:80px; object-fit:cover; border-radius:50%; border:3px solid #0077cc;">
        </div>
      </div>

      <button id="btnRegistro" style="width:100%; padding:12px; margin-top:10px; background:#28a745; color:white; border:none; border-radius:8px; font-weight:bold;">Crear Cuenta</button>
      <p style="margin-top:10px; font-size:13px; color:#666;">
        ¬øYa tienes cuenta? <a href="#" id="irALogin" style="color:#0077cc; text-decoration:underline;">Inicia sesi√≥n</a>
      </p>
    </div>

    <!-- Recuperar PIN -->
    <div id="formRecuperarPin" style="display:none;">
      <h3 id="tituloRecuperar">üîÅ Recuperar PIN</h3>

      <div id="pasoCorreo">
        <p style="font-size:13px; color:#555;">Ingresa tu correo y te enviaremos un PIN temporal.</p>
        <input id="recCorreo" type="email" placeholder="Correo registrado" style="width:100%; margin:10px 0; padding:10px; border-radius:8px; border:1px solid #ccc;">
        <button id="btnEnviarPinTemp" style="width:100%; padding:12px; margin-top:10px; background:#0077cc; color:white; border:none; border-radius:8px; font-weight:bold;">Enviar PIN Temporal</button>
      </div>

      <div id="pasoVerificar" style="display:none;">
        <p style="font-size:13px;">Revisa tu correo e ingresa el PIN temporal recibido:</p>
        <div style="position:relative;">
          <input id="recPinTemp" type="password" minlength="4" placeholder="PIN temporal"
                 style="width:100%; margin:10px 0; padding:10px 35px 10px 10px; border-radius:8px; border:1px solid #ccc;">
          <i class="fa-solid fa-eye toggle-pin" data-target="recPinTemp"
             style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#0077cc;"></i>
        </div>
        <button id="btnVerificarPinTemp" style="width:100%; padding:12px; background:#28a745; color:white; border:none; border-radius:8px; font-weight:bold;">Verificar PIN</button>
      </div>

      <div id="pasoNuevoPin" style="display:none;">
        <p style="font-size:13px;">Crea tu nuevo PIN de acceso:</p>
        <div style="position:relative;">
          <input id="nuevoPin" type="password" minlength="4" placeholder="Nuevo PIN"
                 style="width:100%; margin:10px 0; padding:10px 35px 10px 10px; border-radius:8px; border:1px solid #ccc;">
          <i class="fa-solid fa-eye toggle-pin" data-target="nuevoPin"
             style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#0077cc;"></i>
        </div>

        <div style="position:relative;">
          <input id="confirmarPin" type="password" minlength="4" placeholder="Confirmar nuevo PIN"
                 style="width:100%; margin:10px 0; padding:10px 35px 10px 10px; border-radius:8px; border:1px solid #ccc;">
          <i class="fa-solid fa-eye toggle-pin" data-target="confirmarPin"
             style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#0077cc;"></i>
        </div>

        <button id="btnCambiarPin" style="width:100%; padding:12px; background:#ff9800; color:white; border:none; border-radius:8px; font-weight:bold;">Guardar Nuevo PIN</button>
      </div>

      <p style="margin-top:10px; font-size:13px;">
        <a href="#" id="volverLogin" style="color:#0077cc; text-decoration:underline;">Volver al inicio</a>
      </p>
    </div>

    <button onclick="document.getElementById('loginModal').style.display='none'" 
            style="margin-top:15px; background:none; border:none; color:#999; font-size:20px;">‚úï</button>
  </div>
</div>


    <!-- MODAL PERFIL -->
<div id="modalPerfil" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(4px);
  display: none;
  align-items:center;
  justify-content:center;
  z-index: 9999;
  animation: fadeIn 0.25s ease;
">
  <div id="contenidoModalPerfil" style="
    width:85%;
    max-width:380px;
    background:white;
    border-radius:14px;
    padding:18px;
    text-align:center;
    position:relative;
    animation: zoomIn 0.25s ease;
  ">
    <!-- Bot√≥n cerrar -->
    <span onclick="cerrarModalPerfil()" style="
      position:absolute;
      right:12px;
      top:8px;
      font-size:23px;
      cursor:pointer;
      color:#333;
      font-weight:bold;
    ">‚úñ</span>

    <div style="position:relative; display:inline-block; margin-top:10px;">
      <img id="fotoPerfilModal" src="" style="
        width:100%;
        max-width:250px;
        height:250px;
        border-radius:12px;
        object-fit:cover;
        border:3px solid #0077cc;
        box-shadow:0 2px 6px rgba(0,0,0,0.3);
      ">

      <!-- ‚úèÔ∏è Icono editar -->
      <span id="editarFotoBtn" style="
        position:absolute;
        right:6px;
        bottom:6px;
        background:#0077cc;
        color:white;
        border-radius:50%;
        width:38px;
        height:38px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-size:18px;
        box-shadow:0 2px 6px rgba(0,0,0,0.3);
      ">‚úèÔ∏è</span>
    </div>

    <p id="nombrePerfil" style="
      margin-top:12px;
      font-weight:bold;
      color:#222;
      font-size:18px;
    "></p>

    <p id="correoPerfil" style="
      color:#555;
      font-size:14px;
      margin-top:4px;
    "></p>

    <input type="file" id="inputFotoPerfil" accept="image/*" style="display:none;">
  </div>
</div>
    
    
<!-- BOT√ìN GUARDAR/VER -->
<button id="saveBtn" style="
    position: fixed;
    bottom: 300px;
    right: 18px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    z-index: 2000;
">
    <i class="far fa-bookmark" style="font-size: 24px;"></i>
</button>


<!-- üìå Modal Guardados -->
<div id="savedModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(4px);
    z-index: 10000;
    align-items: center;
    justify-content: flex-start;
    flex-direction: column;
    padding: 15px;
">
    <div id="savedModalInner" style="
        background-color: #1c1c1c;
        color: white;
        width: 90%;
        max-width: 420px;
        max-height: 80%;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        margin-top: 16vh;
        transition: margin-top 0.25s ease;
    ">
        <!-- Encabezado -->
        <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: #1c1c1c;
            z-index: 20;
            padding-bottom: 8px;
        ">
            <h2 style="margin: 0; font-size: 18px; color: white;">üîñ Guardados</h2>
            <button id="closeSavedBtn" style="
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                line-height: 1;
            ">&times;</button>
        </div>

        <!-- Input de b√∫squeda -->
        <input
            id="savedSearchInput"
            type="text"
            placeholder="Buscar guardados..."
            style="
                position: sticky;
                top: 40px;
                z-index: 15;
                margin-top: 12px;
                padding: 10px;
                border: none;
                border-radius: 6px;
                background-color: #2c2c2c;
                color: white;
                font-size: 15px;
            "
        />

        <!-- Lista de guardados -->
        <ul id="savedList" style="
            list-style: none;
            padding: 0;
            margin: 15px 0 0;
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #555 #1c1c1c;
        "></ul>
    </div>
</div>




    
<!-- üîç Modal de b√∫squeda -->
<div id="search-modal" class="hidden">
  <div class="modal-content">
    <h3 style="margin:0 0 10px; font-size:18px;">Buscar video</h3>
    <input type="text" id="search-input" placeholder="Escribe el t√≠tulo...">
    <ul id="search-results"></ul>
    <div class="modal-actions" style="margin-top:10px; text-align:right;">
      <button id="search-close">Cerrar</button>
    </div>
  </div>
</div>

<!-- üîÑ Bot√≥n de actualizar -->
<button id="refreshBtn" class="refresh-btn" title="Actualizar p√°gina">
  <i class="fas fa-sync-alt"></i>
</button>

<div class="comments-overlay-container" id="commentsOverlay">
  <ul id="commentsList"></ul>
</div>

<div class="comments-counter" id="commentsCounter">
  <span class="icon">
    <i class="fa-regular fa-comment"></i>
  </span>
  <span class="count" id="commentCountValue">0</span>
</div>

<div class="likes-counter" id="likesCounter" title="Me gusta">
  <span class="icon">
    <i id="likeIcon" class="far fa-heart"></i>
  </span>
  <span class="count" id="likeCountValue">0</span>
</div>



<div class="comment-input-container">
  <div class="comment-input-wrapper">
    <input type="text" id="commentInput" placeholder="Escribe un comentario...">
    <button class="send-comment-btn"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>


    
<!-- Notificaciones -->
<div id="notification-wrapper">
  <button id="notification-btn">
    <i class="far fa-bell"></i>
    <span id="notification-count"></span>
  </button>
  <div id="notification-list" class="hidden"></div>
</div>

    
<div id="custom-alert-modal" class="modal hidden">
  <div class="modal-content">
    <h3>¬°Atenci√≥n!</h3>
    <p id="custom-alert-message"></p>
    <div class="modal-actions">
      <button id="custom-alert-ok" style="background:#007bff; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer;">Aceptar</button>
    </div>
  </div>
</div>
<!-- Modal de eliminaci√≥n -->
<div id="delete-modal" class="modal hidden">
  <div class="modal-content">
    <h3>¬øEliminar Video?</h3>
    <p id="delete-video-title">¬øSeguro que deseas eliminar este video?</p>
    <div class="modal-actions">
      <button id="delete-confirm" style="background:#dc3545; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer;">Eliminar</button>
      <button id="delete-cancel" style="background:#444; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
    </div>
  </div>
</div>

    
        <!-- BOTONES flotantes -->
 <div class="floating-buttons">
  <button id="btn-delete" class="fab danger">
    <i class="fas fa-trash-alt"></i>
  </button>

  <button id="btn-edit-video" class="fab">
    <i class="fas fa-pen"></i>
  </button>
</div>


  

<div class="swiper">
  <div class="swiper-wrapper" id="slides">
    <!-- aqu√≠ solo van los slides -->
  </div>

  <!-- üëá contenedor global del t√≠tulo, fuera de los slides -->
  <div id="video-title-fixed">
    <div class="video-title"></div>
    <div class="video-desc"></div>
  </div>
</div>



   <div id="loader">
  <i class="fas fa-spinner fa-spin"></i>
</div>


    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- ‚úÖ FFmpeg local (sin CDN) para compresi√≥n en navegador -->
    <script src="./ffmpeg.js"></script>
  
    <script>
        const SCRIPT_URL =
            "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";

  // ============================================================================
  // ‚úÖ Compresi√≥n de video en el navegador (FFmpeg WASM local)
  //    Requiere que en la ra√≠z est√©n: ffmpeg.js, ffmpeg-core.js, ffmpeg-core.wasm
  // ============================================================================
  let __ffmpegInstance = null;

  function _pickFFmpegGlobal() {
    // UMD de @ffmpeg/ffmpeg expone FFmpegWASM
    return window.FFmpegWASM || (typeof FFmpegWASM !== 'undefined' ? FFmpegWASM : null);
  }

async function getFFmpegInstance() {
  if (__ffmpegInstance) return __ffmpegInstance;

  const FF = _pickFFmpegGlobal();
  if (!FF || !FF.FFmpeg) {
    throw new Error('FFmpeg no est√° cargado. Verifica que exista ./ffmpeg.js (UMD) y que se cargue antes del script principal.');
  }

  const ffmpeg = new FF.FFmpeg();

  // ‚úÖ Hook de progreso de FFmpeg (solo UI)
  // Este listener NO cambia la l√≥gica: solo reporta progreso 0..1
  ffmpeg.on('progress', ({ progress }) => {
    if (typeof window.__onCompressProgress === "function") {
      window.__onCompressProgress(progress);
    }
  });

  const base = new URL('.', window.location.href);

  await ffmpeg.load({
    coreURL: new URL('ffmpeg-core.js', base).href,
    wasmURL: new URL('ffmpeg-core.wasm', base).href,
    workerURL: new URL('814.ffmpeg.js', base).href,
  });

  __ffmpegInstance = ffmpeg;
  return __ffmpegInstance;
}


async function compressVideoInBrowser(file, onStatus, onProgress) {
  if (!file || !String(file.type || '').startsWith('video/')) {
    throw new Error('El archivo no es un video.');
  }

  // ‚úÖ LEE EL ARCHIVO ANTES (evita NotReadableError / permisos)
  const data = new Uint8Array(await file.arrayBuffer());

  const ffmpeg = await getFFmpegInstance();

  const ext = (file.name && file.name.includes('.')) ? file.name.split('.').pop() : 'mp4';
  const inName = 'input_' + Date.now() + '.' + ext;
  const outName = 'output_' + Date.now() + '.mp4';

  onStatus && onStatus('‚è≥ Comprimiendo video...');

  // ‚úÖ Progreso real de FFmpeg (0..1) -> lo mandamos al callback (solo UI)
  window.__onCompressProgress = (p) => {
    if (typeof onProgress === 'function') onProgress(p);
  };

  // Limpieza previa (si existieran)
  try { await ffmpeg.deleteFile(inName); } catch (e) {}
  try { await ffmpeg.deleteFile(outName); } catch (e) {}

  try {
    await ffmpeg.writeFile(inName, data);

    await ffmpeg.exec([
      '-i', inName,
      '-vf', 'scale=-2:720',
      '-c:v', 'libx264',
      '-preset', 'veryfast',
      '-crf', '28',
      '-c:a', 'aac',
      '-b:a', '128k',
      outName
    ]);

    const outData = await ffmpeg.readFile(outName);

    const blob = new Blob([outData.buffer], { type: 'video/mp4' });
    const baseName = (file.name || 'video').replace(/\.[^/.]+$/, '');
    return new File([blob], baseName + '_compressed.mp4', { type: 'video/mp4' });

  } finally {
    // ‚úÖ Siempre limpiar (haya √©xito o error)
    window.__onCompressProgress = null;
    try { await ffmpeg.deleteFile(inName); } catch (e) {}
    try { await ffmpeg.deleteFile(outName); } catch (e) {}
  }
}





  document.querySelectorAll('.toggle-pin').forEach(btn => {
  btn.addEventListener('click', () => {
    const input = document.getElementById(btn.dataset.target);
    const isPassword = input.type === 'password';
    
    input.type = isPassword ? 'text' : 'password';
    
    // Alternar √≠cono FontAwesome
    btn.classList.toggle('fa-eye', !isPassword);
    btn.classList.toggle('fa-eye-slash', isPassword);
    btn.classList.toggle('active', isPassword);
  });
});


        


const publishBtn = document.getElementById("publishBtn");
const publishModal = document.getElementById("publishModal");
const closePublishModal = document.getElementById("closePublishModal");
const fileInput = document.getElementById("imagen");
const previewImg = document.getElementById("previewImg");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const btnPublicar = document.getElementById("btnPublicar");
const mensaje = document.getElementById("mensaje");

let base64Imagen = "";

// üîπ Abrir modal
publishBtn.addEventListener("click", (e) => {
  e.preventDefault();
  publishModal.style.display = "flex";

  // === MARCAR EL BOT√ìN DE PUBLICAR COMO SELECCIONADO ===
  document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
  publishBtn.classList.add('selected');
});

// üîπ Cerrar modal
closePublishModal.addEventListener("click", () => {
  publishModal.style.display = "none";
  // === VOLVER A RESALTAR EL BOT√ìN DE IM√ÅGENES ===
  const videoBtn = document.getElementById("videoBtn");
  if (videoBtn) {
    document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
    videoBtn.classList.add('selected');
  }
});

// üîπ Funci√≥n para comprimir im√°genes
function compressImage(base64, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      let width = img.width;
      let height = img.height;

      // üîπ Redimensionar si es m√°s grande que el ancho m√°ximo
      if (width > maxWidth) {
        height = (maxWidth / width) * height;
        width = maxWidth;
      }

      canvas.width = width;
      canvas.height = height;

      // üîπ Dibujar y comprimir
      ctx.drawImage(img, 0, 0, width, height);
      const compressedBase64 = canvas.toDataURL("image/jpeg", quality);
      resolve(compressedBase64);
    };
    img.src = base64;
  });
}

// üîπ Vista previa y compresi√≥n de imagen
fileInput.addEventListener("change", function () {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onloadstart = function () {
      progressContainer.style.display = "block";
      progressBar.style.width = "0%";
    };
    reader.onprogress = function (e) {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        progressBar.style.width = percent + "%";
      }
    };
    reader.onloadend = async function (e) {
      const originalBase64 = e.target.result;

      // üîπ Comprimir imagen antes de mostrarla
      const compressedBase64 = await compressImage(originalBase64, 800, 0.7);
      base64Imagen = compressedBase64.split(",")[1];

      previewImg.src = compressedBase64;
      previewImg.style.display = "block";
      previewImg.style.maxWidth = "100%";
      previewImg.style.maxHeight = "180px";
      previewImg.style.objectFit = "cover";
      previewImg.style.borderRadius = "12px";

      progressBar.style.width = "100%";
      setTimeout(() => (progressContainer.style.display = "none"), 500);
    };
    reader.readAsDataURL(file);
  }
});

// üîπ Enviar anuncio (con barra de progreso simulada durante subida)
btnPublicar.addEventListener("click", async () => {
  const titulo = document.getElementById("titulo").value.trim();
  const descripcion = document.getElementById("descripcion").value.trim();
  const autor = localStorage.getItem("autor") || window.currentAuthorName || "";
  const correo = localStorage.getItem("correo") || window.currentAuthorEmail || "";

  if (!titulo || !descripcion || !base64Imagen || !autor || !correo) {
    mensaje.textContent = "‚ö†Ô∏è Por favor completa todos los campos o inicia sesi√≥n.";
    mensaje.style.color = "red";
    return;
  }

  btnPublicar.disabled = true;
  mensaje.textContent = "‚è≥ Subiendo anuncio...";
  mensaje.style.color = "#0077cc";

  const formData = new FormData();
  formData.append("accion", "guardar");
  formData.append("tipo", "anuncio");
  formData.append("titulo", titulo);
  formData.append("descripcion", descripcion);
  formData.append("imagen", base64Imagen);
  formData.append("autor", autor);
  formData.append("correo", correo);

  // üîπ Mostrar barra de progreso
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";

  // Simular progreso mientras se sube
  let simulatedProgress = 0;
  const interval = setInterval(() => {
    if (simulatedProgress < 90) {
      simulatedProgress += Math.random() * 5; // sube entre 1% y 5%
      progressBar.style.width = simulatedProgress + "%";
    }
  }, 200);

  try {
    const response = await fetch(SCRIPT_URL, {
      method: "POST",
      body: formData
    });

    clearInterval(interval);
    progressBar.style.width = "100%";

    const result = await response.text();

    mensaje.textContent = "‚úÖ Anuncio enviado correctamente.";
    mensaje.style.color = "green";

    // üîπ Esperar un poco para que se vea el 100%
    await new Promise(res => setTimeout(res, 600));

    // Limpiar formulario
    document.getElementById("titulo").value = "";
    document.getElementById("descripcion").value = "";
    fileInput.value = "";
    previewImg.src = "";
    previewImg.style.display = "none";
    base64Imagen = "";

    // üîπ Ocultar barra y cerrar modal
    progressBar.style.width = "0%";
    progressContainer.style.display = "none";

   // üîπ Cierre autom√°tico despu√©s de subir anuncio
setTimeout(() => {
  publishModal.style.display = "none";
  mensaje.textContent = "";
  if (typeof cargarAnuncios === "function") {
    cargarAnuncios();
  }
  // === VOLVER A RESALTAR EL BOT√ìN DE IM√ÅGENES ===
  const videoBtn = document.getElementById("videoBtn");
  if (videoBtn) {
    document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
    videoBtn.classList.add('selected');
  }
}, 1000);
  } catch (err) {
    clearInterval(interval);
    console.error(err);
    mensaje.textContent = "üö´ Error al conectar con el servidor.";
    mensaje.style.color = "red";
    progressContainer.style.display = "none";
    progressBar.style.width = "0%";
  }

  btnPublicar.disabled = false;
});


// =============================
// ‚úèÔ∏è MODO EDICI√ìN DE VIDEO
// =============================
let editingVideoId = null;

// Bot√≥n editar (FAB)
const editVideoBtn = document.getElementById("btn-edit-video");

// Mostrar/ocultar botones seg√∫n due√±o
function updateVideoOwnerButtons() {
  const deleteBtn = document.getElementById("btn-delete");
  const editBtn = document.getElementById("btn-edit-video");
  if (!deleteBtn || !editBtn) return;

  const activeSlide = swiper?.slides?.[swiper.activeIndex];
  const correoDelSlide = activeSlide?.dataset?.correo || "";

  const esMio = normalizeText(correoDelSlide) === normalizeText(currentAuthorEmail);

  deleteBtn.style.display = esMio ? "flex" : "none";
  editBtn.style.display   = esMio ? "flex" : "none";
}

// Abrir modal y precargar campos para editar
function openEditVideoFromActive() {
  const activeSlide = swiper?.slides?.[swiper.activeIndex];
  if (!activeSlide) return;

  editingVideoId = activeSlide.dataset.videoid || "";

  // Abrir modal
  publishModal.style.display = "flex";

  // Forzar pesta√±a Video
  tabVideo.click();

  // Precargar campos
  document.getElementById("videoTitle").value = activeSlide.dataset.titulo || "";
  document.getElementById("videoDescripcion").value = activeSlide.dataset.descripcion || "";

  // No obligar archivo al editar
  document.getElementById("fileInput").value = "";

  // Cambiar texto del bot√≥n de subir
  const btn = document.getElementById("btnUploadVideo");
  if (btn) btn.textContent = "üíæ Guardar cambios";
}

if (editVideoBtn) {
  editVideoBtn.addEventListener("click", openEditVideoFromActive);
}



// =============================
// üé¨ CONTROL DE SECCIONES EN MODAL PUBLICAR
// =============================
const tabAnuncio = document.getElementById("tabAnuncio");
const tabVideo = document.getElementById("tabVideo");
const anuncioSection = document.getElementById("anuncioSection");
const videoSection = document.getElementById("videoSection");

tabAnuncio.addEventListener("click", () => {
  tabAnuncio.style.background = "#0077cc";
  tabAnuncio.style.color = "white";
  tabVideo.style.background = "#ccc";
  tabVideo.style.color = "#333";
  anuncioSection.style.display = "block";
  videoSection.style.display = "none";
});

tabVideo.addEventListener("click", () => {
  tabVideo.style.background = "#6b46c1";
  tabVideo.style.color = "white";
  tabAnuncio.style.background = "#ccc";
  tabAnuncio.style.color = "#333";
  anuncioSection.style.display = "none";
  videoSection.style.display = "block";
});

    



// =============================
// üé• MODAL DE SUBIDA DE VIDEOS
// =============================

// üì§ Subida del video (mantiene compatibilidad con tu sistema)
btnUploadVideo.addEventListener("click", async () => {
    // ‚úÖ Si estamos editando, NO subimos archivo: actualizamos t√≠tulo/descr
  if (editingVideoId) {
    return await guardarEdicionVideo();
  }

  const file = document.getElementById("fileInput").files[0];
  const tituloUsuario = document.getElementById("videoTitle").value.trim();
  const descripcionUsuario = document.getElementById("videoDescripcion").value.trim();
  const progressBar = document.getElementById("progressVideo");            // ‚úÖ este es el DIV que crece en %
  const progressContainer = document.getElementById("progressContainerVideo");
  const metrics = document.getElementById("uploadMetricsVideo");
  const status = document.getElementById("statusVideo");

  // ‚úÖ Asegurar que los avisos se vean (texto negro)
  if (status) {
    status.style.color = "#111";
    status.style.fontWeight = "700";
  }

  const autor = localStorage.getItem("autor") || window.currentAuthorName || "An√≥nimo";
  const correo = localStorage.getItem("correo") || window.currentAuthorEmail || "desconocido@correo.com";

  if (!file) return alert("Selecciona un video para subir.");
  if (!tituloUsuario) return alert("Escribe un t√≠tulo para el video.");

  // ‚úÖ Compresi√≥n opcional (si el checkbox est√° activado)
  const doCompress = document.getElementById('compressBeforeUpload')?.checked;
  let uploadFile = file;

  if (doCompress) {
    try {
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      status.textContent = '‚è≥ Preparando compresi√≥n...';
      metrics.textContent = 'Compresi√≥n: 0%';

      uploadFile = await compressVideoInBrowser(
        file,
        (msg) => { status.textContent = msg; },
        (progressValue) => {
          // progressValue puede ser 0..1 (FFmpeg) o 0..100 (por si cambia)
          let pct = 0;
          if (typeof progressValue === 'number') {
            pct = (progressValue <= 1) ? Math.round(progressValue * 100) : Math.round(progressValue);
          }
          pct = Math.max(0, Math.min(100, pct));

          progressBar.style.width = pct + '%';
          metrics.textContent = 'Compresi√≥n: ' + pct + '%';
        }
      );

      const origMB = (file.size / (1024 * 1024)).toFixed(2);
      const compMB = (uploadFile.size / (1024 * 1024)).toFixed(2);

      status.textContent = '‚úÖ Compresi√≥n lista. Subiendo...';
      metrics.textContent = 'Tama√±o: ' + origMB + ' MB ‚Üí ' + compMB + ' MB';

      // Reiniciar barra para la subida real
      progressBar.style.width = '0%';
    } catch (err) {
      console.warn('Compresi√≥n fall√≥, se sube el original:', err);
      const msg = (err && err.message) ? err.message : String(err);
      status.textContent = '‚ö†Ô∏è No se pudo comprimir (' + msg + '). Subiendo original...';
      console.error('Error compresi√≥n:', err);

      // Asegura que la barra quede lista para la subida
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
    }
  }

  // üîπ Deshabilitar bot√≥n mientras sube
  btnUploadVideo.disabled = true;
  const originalText = btnUploadVideo.textContent;
  btnUploadVideo.textContent = "‚è≥ Subiendo...";

  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  // No borres el status si venimos de compresi√≥n
  if (!doCompress) {
    status.textContent = "";
    metrics.textContent = "";
  }

  const identifier = "artistica_bochica_" + Date.now();
  const fileName = uploadFile.name;
  const accessKey = "KPJmAQCm1UyNJWqv";
  const secretKey = "9JkBrIGexGNOynyf";
  const url = `https://s3.us.archive.org/${identifier}/${fileName}`;
  const xhr = new XMLHttpRequest();

  let startTime = Date.now();

  xhr.upload.onprogress = (event) => {
    if (event.lengthComputable) {
      const percent = (event.loaded / event.total) * 100;
      progressBar.style.width = percent + "%";

      const loadedMB = (event.loaded / (1024 * 1024)).toFixed(2);
      const totalMB = (event.total / (1024 * 1024)).toFixed(2);
      const elapsed = (Date.now() - startTime) / 1000;
      const speedMB = (event.loaded / elapsed / (1024 * 1024)).toFixed(2);
      const timeLeft = ((event.total - event.loaded) / (event.loaded / elapsed)) || 0;
      const mins = Math.floor(timeLeft / 60);
      const secs = Math.floor(timeLeft % 60);
      metrics.textContent = `Subido: ${loadedMB}/${totalMB} MB ‚Äî Velocidad: ${speedMB} MB/s ‚Äî Restante: ${mins}m ${secs}s`;
    }
  };

  xhr.onload = async function () {
    // üîπ Rehabilitar bot√≥n al terminar
    btnUploadVideo.disabled = false;
    btnUploadVideo.textContent = originalText;

    if (xhr.status === 200) {
      const fileEncoded = encodeURIComponent(fileName);
      const directLink = `https://archive.org/download/${identifier}/${fileEncoded}`;
      status.innerHTML = `‚úÖ Video subido correctamente<br><a href="${directLink}" target="_blank">Ver video</a>`;

      // Guarda los datos en tu Apps Script
      await fetch(`https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec?accion=guardar&tipo=video`
        + `&titulo=${encodeURIComponent(tituloUsuario)}`
        + `&link=${encodeURIComponent(directLink)}`
        + `&autor=${encodeURIComponent(autor)}`
        + `&correo=${encodeURIComponent(correo)}`
        + `&descripcion=${encodeURIComponent(descripcionUsuario)}`);

      // Esperar un poco para mostrar 100%
      await new Promise(res => setTimeout(res, 600));

      // üîπ Limpiar campos del formulario
      document.getElementById("fileInput").value = "";
      document.getElementById("videoTitle").value = "";
      document.getElementById("videoDescripcion").value = "";
      progressBar.style.width = "0%";
      progressContainer.style.display = "none";
      metrics.textContent = "";
      status.textContent = "";

      // üîπ Cerrar modal autom√°ticamente
      setTimeout(() => {
        publishModal.style.display = "none";
        if (typeof cargarAnuncios === "function") {
          cargarAnuncios();
        }
        // === VOLVER A RESALTAR EL BOT√ìN DE IM√ÅGENES ===
        const videoBtn = document.getElementById("videoBtn");
        if (videoBtn) {
          document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
          videoBtn.classList.add('selected');
        }
      }, 1000);
    } else {
      status.textContent = "‚ùå Error al subir el video.";
    }
  };

  xhr.onerror = () => {
    // üîπ Rehabilitar bot√≥n si falla
    btnUploadVideo.disabled = false;
    btnUploadVideo.textContent = originalText;
    status.textContent = "‚ùå Error de conexi√≥n.";
  };

  xhr.open("PUT", url, true);
  xhr.setRequestHeader("Authorization", `LOW ${accessKey}:${secretKey}`);
  xhr.setRequestHeader("x-archive-auto-make-bucket", "1");
  xhr.setRequestHeader("x-archive-meta-title", fileName);
  xhr.setRequestHeader("x-archive-meta-mediatype", "movies");
  xhr.setRequestHeader("x-archive-meta-description", "Video subido desde la app DECOM");
  xhr.setRequestHeader("x-archive-meta-collection", "opensource_movies");
  xhr.setRequestHeader("x-archive-meta-creator", autor);
  xhr.setRequestHeader("Content-Type", uploadFile.type);
  xhr.send(uploadFile);
});


async function guardarEdicionVideo() {
  try {
    const titulo = document.getElementById("videoTitle").value.trim();
    const descripcion = document.getElementById("videoDescripcion").value.trim();

    const autor = localStorage.getItem("autor") || window.currentAuthorName || "An√≥nimo";
    const correo = localStorage.getItem("correo") || window.currentAuthorEmail || "desconocido@correo.com";

    if (!editingVideoId) return mostrarAviso("No hay video en edici√≥n.");
    if (!titulo) return mostrarAviso("Escribe un t√≠tulo.");

    const formData = new FormData();
    formData.append("accion", "editarVideo");     // üëà backend nuevo
    formData.append("tipo", "videos");           // üëà para tu hoja Videos
    formData.append("idVideo", editingVideoId);
    formData.append("titulo", titulo);
    formData.append("descripcion", descripcion);
    formData.append("autor", autor);
    formData.append("correo", correo);

    const res = await fetch(SCRIPT_URL, { method: "POST", body: formData });
    const json = await res.json();

    if (json.status && json.status.toLowerCase().includes("success")) {
      mostrarAviso("‚úÖ Video actualizado");

      // salir modo edici√≥n
      editingVideoId = null;

      // restaurar texto bot√≥n
      const btn = document.getElementById("btnUploadVideo");
      if (btn) btn.textContent = "üì§ Subir video";

      // cerrar modal
      publishModal.style.display = "none";

      // fuerza verificaci√≥n (sin esperar al siguiente intervalo)
      setTimeout(verificarActualizacionVideos, 0);
    } else {
      mostrarAviso(json.message || "No se pudo actualizar el video.");
    }
  } catch (e) {
    console.error("guardarEdicionVideo error:", e);
    mostrarAviso("‚ùå Error guardando edici√≥n.");
  }
}



    // =============================
// üì∏ BOTONES DE C√ÅMARA (imagen y video)
// =============================
document.getElementById("abrirCamaraImg")?.addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.capture = "environment";
  input.onchange = (e) => {
    document.getElementById("imagen").files = e.target.files;
    document.getElementById("imagen").dispatchEvent(new Event("change"));
  };
  input.click();
});

document.getElementById("abrirCamaraVideo")?.addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "video/*";
  input.capture = "camera";
  input.onchange = (e) => {
    document.getElementById("fileInput").files = e.target.files;
    document.getElementById("fileInput").dispatchEvent(new Event("change"));
  };
  input.click();
});






        

// ==========================
// üîñ GUARDAR Y VER VIDEOS
// ==========================
const saveBtn = document.getElementById("saveBtn");
const viewSavedBtn = document.getElementById("viewSavedBtn");
const savedModal = document.getElementById("savedModal");
const savedList = document.getElementById("savedList");
const savedSearchInput = document.getElementById("savedSearchInput");
const closeSavedBtn = document.getElementById("closeSavedBtn");
const savedModalInner = document.getElementById("savedModalInner");

// ==========================
// ‚úÖ FUNCIONES DE COOKIES (Compatibilidad WebViewer)
// ==========================
function setSavedVideos(data) {
    document.cookie = "savedVideos=" + encodeURIComponent(JSON.stringify(data)) + "; path=/; max-age=31536000";
}

function getSavedVideos() {
    const match = document.cookie.match(/(^| )savedVideos=([^;]+)/);
    return match ? JSON.parse(decodeURIComponent(match[2])) : [];
}

// üîß Normaliza texto: min√∫sculas, sin tildes, sin espacios extras
function normalizeText(text) {
    return text
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

// ==========================
// üíæ GUARDAR VIDEO ACTUAL
// ==========================
function saveCurrentVideo() {
    if (!swiper || lastVideos.length === 0) {
        showToast("‚ö†Ô∏è No hay videos para guardar");
        return;
    }

    const currentIndex = swiper.realIndex;
    const currentVideo = lastVideos[currentIndex];

    let saved = getSavedVideos();

    if (!saved.find(item => item.id === currentVideo.id)) {
        saved.push({
            id: currentVideo.id,
            // üëá Ajuste aqu√≠: usar title (si no existe, usa desc o texto gen√©rico)
            titulo: currentVideo.title || currentVideo.desc || "Video sin t√≠tulo",
            desc: currentVideo.desc || ""
        });
        setSavedVideos(saved);
        showToast("‚úÖ Video guardado");
    } else {
        showToast("‚ÑπÔ∏è Este video ya est√° guardado");
    }
}


// ==========================
// üìú RENDERIZAR VIDEOS GUARDADOS
// ==========================
function renderSavedVideos(filter = "") {
    const saved = getSavedVideos();
    savedList.innerHTML = "";

    const filtered = saved.filter(item =>
        normalizeText(item.titulo).includes(normalizeText(filter))
    );

    // üîπ Contenedor de botones (Guardar actual + Eliminar todo)
    const buttonsContainer = document.createElement("div");
    buttonsContainer.style.display = "flex";
    buttonsContainer.style.justifyContent = "space-between";
    buttonsContainer.style.gap = "10px";
    buttonsContainer.style.margin = "8px 0 10px";

    // Bot√≥n Guardar actual (siempre visible)
    const saveCurrentBtn = document.createElement("button");
    saveCurrentBtn.textContent = "üíæ Guardar actual";
    saveCurrentBtn.style.flex = "1";
    saveCurrentBtn.style.background = "#007bff";
    saveCurrentBtn.style.color = "#fff";
    saveCurrentBtn.style.border = "none";
    saveCurrentBtn.style.borderRadius = "6px";
    saveCurrentBtn.style.padding = "6px 12px";
    saveCurrentBtn.style.cursor = "pointer";
    saveCurrentBtn.style.fontSize = "13px";
    saveCurrentBtn.style.transition = "background 0.2s ease";

    saveCurrentBtn.addEventListener("mouseenter", () => {
        saveCurrentBtn.style.background = "#3399ff";
    });
    saveCurrentBtn.addEventListener("mouseleave", () => {
        saveCurrentBtn.style.background = "#007bff";
    });
    saveCurrentBtn.addEventListener("click", () => {
        saveCurrentVideo();
        renderSavedVideos(filter); // refresca la lista
    });

    buttonsContainer.appendChild(saveCurrentBtn);

    // Bot√≥n Eliminar todo (solo si hay m√°s de uno)
    if (filtered.length > 1) {
        const clearAllBtn = document.createElement("button");
        clearAllBtn.textContent = "Eliminar todo";
        clearAllBtn.style.flex = "1";
        clearAllBtn.style.background = "#2c2c2c";
        clearAllBtn.style.color = "#ccc";
        clearAllBtn.style.border = "1px solid #444";
        clearAllBtn.style.borderRadius = "6px";
        clearAllBtn.style.padding = "6px 12px";
        clearAllBtn.style.cursor = "pointer";
        clearAllBtn.style.fontSize = "13px";
        clearAllBtn.style.transition = "background 0.2s ease";

        clearAllBtn.addEventListener("mouseenter", () => {
            clearAllBtn.style.background = "#3a3a3a";
        });
        clearAllBtn.addEventListener("mouseleave", () => {
            clearAllBtn.style.background = "#2c2c2c";
        });
        clearAllBtn.addEventListener("click", () => {
            setSavedVideos([]);
            renderSavedVideos();
            showToast("‚úÖ Todos los videos fueron eliminados");
        });

        buttonsContainer.appendChild(clearAllBtn);
    }

    savedList.appendChild(buttonsContainer);

    if (filtered.length === 0) {
        // ‚¨áÔ∏è Crear mensaje vac√≠o sin borrar el bot√≥n
        const emptyMsg = document.createElement("li");
        emptyMsg.textContent = "No hay videos guardados";
        emptyMsg.style.color = "#777";
        emptyMsg.style.padding = "10px";
        savedList.appendChild(emptyMsg);

        savedModalInner.style.transform = "translateY(-60px)";
    } else {
        savedModalInner.style.transform = "translateY(0)";
    }

    // üîπ Renderizar cada item guardado
    filtered.forEach(item => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";
        li.style.padding = "10px";
        li.style.borderBottom = "1px solid #333";
        li.style.color = "#fff";
        li.style.transition = "opacity 0.3s ease, transform 0.3s ease";

        const titleSpan = document.createElement("span");
        titleSpan.textContent = item.titulo;
        titleSpan.style.cursor = "pointer";
        titleSpan.style.flex = "1";

        // Click ‚Üí ir al video
        titleSpan.addEventListener("click", () => {
            const videoIndex = lastVideos.findIndex(v => v.id === item.id);

            if (videoIndex !== -1) {
                swiper.slideToLoop(videoIndex, 0, false);
                savedModal.style.display = "none";

                setTimeout(() => {
                    const tituloActual = document.querySelector("#video-title-fixed .video-title");
                    if (tituloActual) {
                        tituloActual.classList.add("highlight-title-zoom");
                        tituloActual.scrollIntoView({ behavior: "smooth", block: "center" });
                        setTimeout(() => {
                            tituloActual.classList.remove("highlight-title-zoom");
                        }, 2000);
                    }
                }, 400);
            } else {
                showToast("‚ö†Ô∏è Este video ya no est√° disponible");
            }
        });

        // Bot√≥n eliminar ‚ùå
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "‚úï";
        deleteBtn.style.background = "transparent";
        deleteBtn.style.border = "none";
        deleteBtn.style.color = "#aaa";
        deleteBtn.style.fontSize = "14px";
        deleteBtn.style.cursor = "pointer";
        deleteBtn.style.marginLeft = "10px";
        deleteBtn.style.transition = "color 0.2s ease";

        deleteBtn.addEventListener("mouseenter", () => {
            deleteBtn.style.color = "#fff";
        });
        deleteBtn.addEventListener("mouseleave", () => {
            deleteBtn.style.color = "#aaa";
        });

        deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            li.style.opacity = "0";
            li.style.transform = "translateX(30px)";

            setTimeout(() => {
                const updated = saved.filter(s => s.id !== item.id);
                setSavedVideos(updated);
                renderSavedVideos(filter);
                showToast("üóëÔ∏è Eliminado de guardados");
            }, 300);
        });

        li.appendChild(titleSpan);
        li.appendChild(deleteBtn);
        savedList.appendChild(li);
    });
}







// ==========================
// üìå EVENTOS DE LOS BOTONES
// ==========================
saveBtn.addEventListener("click", () => {
    savedSearchInput.value = "";
    renderSavedVideos();
    setTimeout(() => {
        savedModal.style.display = "flex";
        savedList.scrollTop = 0;
    }, 50);
});

savedSearchInput.addEventListener("input", (e) => {
    renderSavedVideos(e.target.value);
});

closeSavedBtn.addEventListener("click", () => {
    savedModal.style.display = "none";
});

savedModal.addEventListener("click", (e) => {
    if (e.target === savedModal) {
        savedModal.style.display = "none";
    }
});

// ==========================
// üçû TOASTS PERSONALIZADOS
// ==========================
function showToast(msg) {
    const toast = document.createElement("div");
    toast.textContent = msg;
    toast.style.position = "fixed";
    toast.style.bottom = "80px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.background = "rgba(0,0,0,0.85)";
    toast.style.color = "white";
    toast.style.padding = "10px 16px";
    toast.style.borderRadius = "6px";
    toast.style.fontSize = "14px";
    toast.style.zIndex = "100000";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}





        

// === Comentarios m√≥viles ===
const commentsOverlay = document.getElementById('commentsOverlay');
const commentsCounter = document.getElementById('commentsCounter');
const commentCountValue = document.getElementById('commentCountValue');
const likesCounter = document.getElementById('likesCounter');
const likeCountValue = document.getElementById('likeCountValue');
const likeIcon = document.getElementById('likeIcon');
const commentsList = document.getElementById('commentsList');
const commentInputContainer = document.querySelector('.comment-input-container');
const commentInput = document.getElementById('commentInput');
const sendCommentBtn = document.querySelector('.send-comment-btn');
const notificationWrapper = document.getElementById('notification-wrapper');
const notificationList = document.getElementById('notification-list');

let comentariosPorVideo = {}; // videoId: [ {autor, correo, fecha, comentario} ]
let likesPorVideo = {};      // { videoId: count }
let likedPorVideo = {};      // { videoId: true/false } para el usuario actual

// Evita doble click mientras responde el servidor
const likePendingPorVideo = {};

let lastTapTime = 0;
let activeComment = null;
let startX = 0;
let isSwiping = false;

const refreshBtn = document.getElementById("refreshBtn");

if (refreshBtn) {
  refreshBtn.addEventListener("click", () => {
    location.reload(); // üîÑ Recarga la p√°gina completamente
  });
}


// === üí¨ Aviso elegante, centrado y adaptable a m√≥viles ===
function mostrarAviso(mensaje, tipo = "info") {
  let alertBox = document.getElementById("alertBox");

  if (!alertBox) {
    alertBox = document.createElement("div");
    alertBox.id = "alertBox";
    document.body.appendChild(alertBox);

    Object.assign(alertBox.style, {
      display: "none",
      position: "fixed",
      top: "50%",
      left: "50%",
      transform: "translate(-50%, -50%) scale(0.9)",
      background: "rgba(30, 30, 30, 0.9)",
      color: "#fff",
      padding: "14px 24px",
      borderRadius: "14px",
      boxShadow: "0 8px 25px rgba(0,0,0,0.4)",
      fontWeight: "500",
      fontSize: "15px",
      fontFamily: "Poppins, sans-serif",
      zIndex: "100000",
      opacity: "0",
      transition: "all 0.4s ease",
      textAlign: "center",
      whiteSpace: "nowrap", // ‚úÖ evita salto de l√≠nea
      overflow: "hidden",
      textOverflow: "ellipsis",
      maxWidth: "90vw", // ‚úÖ limita al ancho de pantalla
      letterSpacing: "0.3px",
      backdropFilter: "blur(10px)",
      border: "1px solid rgba(255,255,255,0.1)",
    });
  }

  // üé® Colores neutros seg√∫n tipo
  let bgColor = "rgba(30, 30, 30, 0.9)";
  if (tipo === "error") bgColor = "rgba(50, 50, 50, 0.95)";
  if (tipo === "success") bgColor = "rgba(45, 45, 45, 0.95)";
  if (tipo === "warning") bgColor = "rgba(70, 70, 70, 0.95)";
  if (tipo === "info") bgColor = "rgba(35, 35, 35, 0.9)";

  alertBox.style.background = bgColor;
  alertBox.textContent = mensaje;
  alertBox.style.display = "block";

  // ‚ú® Animaci√≥n elegante
  setTimeout(() => {
    alertBox.style.opacity = "1";
    alertBox.style.transform = "translate(-50%, -50%) scale(1)";
  }, 50);

  // ‚è≥ Desaparici√≥n autom√°tica
  setTimeout(() => {
    alertBox.style.opacity = "0";
    alertBox.style.transform = "translate(-50%, -50%) scale(0.95)";
    setTimeout(() => {
      alertBox.style.display = "none";
    }, 400);
  }, 3000);
}

        
        
document.addEventListener("DOMContentLoaded", () => {

    
  // ======================================================================================
  // BLOQUEO Y MOSTRAR MODAL SI NO HAY SESI√ìN ACTIVA
  // ======================================================================================
  const usuarioGuardado = JSON.parse(localStorage.getItem("usuario"));
  const modal = document.getElementById("loginModal");

  if (!usuarioGuardado) {
    const overlay = document.createElement("div");
    Object.assign(overlay.style, {
      position: "fixed",
      top: "0",
      left: "0",
      width: "100%",
      height: "100%",
      background: "linear-gradient(180deg, #000, #222)",
      color: "white",
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      justifyContent: "center",
      zIndex: "99998",
      fontFamily: "Poppins, sans-serif",
      textAlign: "center",
      opacity: "0",
      transition: "opacity 0.4s ease",
    });
    overlay.innerHTML = `
      <h2 style="margin-bottom:12px; font-size:22px;">üîí Acceso restringido</h2>
      <p style="color:#ccc; max-width:80%; line-height:1.5;">
        Debes iniciar sesi√≥n para acceder al contenido.
      </p>
    `;
    document.body.appendChild(overlay);

    overlay.id = "decomAuthOverlay";


    if (modal) {
      modal.style.display = "flex";
      modal.style.zIndex = "99999";
    }
    setTimeout(() => (overlay.style.opacity = "1"), 50);

    // ‚ö†Ô∏è ELIMINA el "return"
    // No interrumpas la ejecuci√≥n del resto del c√≥digo
  }




  // ======================================================================================
  // MARCAR BOT√ìN ACTIVO SEG√öN P√ÅGINA
  // ======================================================================================
  

  // ======================================================================================
  // CREAR PREVIEW DE FOTO REGISTRO + COMPRESI√ìN (~900 KB)
  // ======================================================================================
  let previewContainer = document.getElementById("previewContainer");
  let fotoPreview = document.getElementById("fotoPreview");

  if (!previewContainer) {
    previewContainer = document.createElement("div");
    previewContainer.id = "previewContainer";
    previewContainer.style.display = "none";
    previewContainer.style.marginTop = "10px";
    previewContainer.style.textAlign = "center";

    fotoPreview = document.createElement("img");
    fotoPreview.id = "fotoPreview";
    fotoPreview.style.width = "80px";
    fotoPreview.style.height = "80px";
    fotoPreview.style.borderRadius = "50%";
    fotoPreview.style.objectFit = "cover";
    fotoPreview.style.border = "2px solid #0077cc";

    previewContainer.appendChild(fotoPreview);
    const regFoto = document.getElementById("regFoto");
    if (regFoto && regFoto.parentNode) regFoto.parentNode.insertBefore(previewContainer, regFoto.nextSibling);
  }

  const regFoto = document.getElementById("regFoto");
  regFoto?.addEventListener("change", async () => {
    const file = regFoto.files[0];
    if (!file) return;

    previewContainer.style.display = "block";
    previewContainer.innerHTML = "";
    fotoPreview.src = "";
    fotoPreview.alt = "Procesando...";

    const spinner = document.createElement("div");
    spinner.innerHTML = `<div class="spinner" style="
      width:40px;height:40px;border:4px solid #ccc;
      border-top-color:#3498db;border-radius:50%;
      animation:spin 1s linear infinite;margin:auto;"></div>`;
    previewContainer.appendChild(spinner);

    const compressTo900KB = (file, targetKB = 900) => {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            let width = img.width, height = img.height;
            const maxDimension = 1600;
            if (width > maxDimension || height > maxDimension) {
              const scale = maxDimension / Math.max(width, height);
              width *= scale; height *= scale;
            }
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = width; canvas.height = height;
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = "high";
            ctx.drawImage(img, 0, 0, width, height);
            let quality = 0.9;
            let base64 = canvas.toDataURL("image/jpeg", quality);
            while (base64.length / 1024 > targetKB && quality > 0.55) {
              quality -= 0.05;
              base64 = canvas.toDataURL("image/jpeg", quality);
            }
            resolve(base64);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    };

    try {
      const base64 = await compressTo900KB(file);
      window.fotoComprimida = base64;
      previewContainer.innerHTML = "";
      fotoPreview.src = base64;
      fotoPreview.alt = "Foto seleccionada";
      previewContainer.appendChild(fotoPreview);
    } catch {
      mostrarAviso("Error al procesar imagen", "error");
      regFoto.value = "";
      previewContainer.style.display = "none";
    }
  });

  const spinStyle = document.createElement("style");
  spinStyle.textContent = `
    @keyframes spin { to { transform: rotate(360deg); } }
  `;
  document.head.appendChild(spinStyle);

  // ======================================================================================
  // FUNCIONES GLOBALES
  // ======================================================================================
  function mostrarAviso(mensaje, tipo = "info") {
    const aviso = document.createElement("div");
    aviso.textContent = mensaje;
    Object.assign(aviso.style, {
      position: "fixed",
      top: "20px",
      left: "50%",
      transform: "translateX(-50%)",
      background: tipo === "error" ? "#e74c3c" : tipo === "success" ? "#27ae60" : "#3498db",
      color: "white",
      padding: "12px 24px",
      borderRadius: "8px",
      zIndex: "100000",
      fontFamily: "Arial",
      fontSize: "14px",
      boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
      animation: "fadeInOut 3s forwards"
    });
    document.body.appendChild(aviso);
    setTimeout(() => aviso.remove(), 3000);
  }

  function mostrarLoader(texto = "Procesando...") {
    const overlay = document.createElement("div");
    Object.assign(overlay.style, {
      position: "fixed",
      inset: "0",
      background: "rgba(0,0,0,0.65)",
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      justifyContent: "center",
      zIndex: "10000",
      color: "#fff",
      fontFamily: "system-ui, sans-serif",
      fontSize: "1.1em",
      textAlign: "center",
      backdropFilter: "blur(3px)",
      animation: "fadeIn 0.25s ease"
    });
    overlay.innerHTML = `
      <div style="
        width:60px;height:60px;
        border:6px solid rgba(255,255,255,0.3);
        border-top-color:#00aaff;
        border-radius:50%;
        animation:spin 1s linear infinite;
        margin-bottom:15px;
      "></div>
      <span>${texto}</span>
    `;
    document.body.appendChild(overlay);
    return overlay;
  }

  function cerrarLoader(loader) {
    if (loader && loader.parentNode) {
      loader.style.animation = "fadeOut 0.25s ease";
      setTimeout(() => loader.remove(), 200);
    }
  }

  const styleGlobal = document.createElement("style");
  styleGlobal.textContent = `
    @keyframes fadeInOut {0%{opacity:0;transform:translate(-50%,-20px);}10%{opacity:1;transform:translateX(-50%);}90%{opacity:1;}100%{opacity:0;transform:translate(-50%,-20px);}}
    @keyframes fadeIn {from{opacity:0;}to{opacity:1;}}
    @keyframes fadeOut {from{opacity:1;}to{opacity:0;}}
    .tab-btn.active{border-bottom:3px solid #0077cc;color:#0077cc;}
  `;
  document.head.appendChild(styleGlobal);

  // ======================================================================================
  // TAB LOGIN/REGISTRO
  // ======================================================================================
  const tabLogin = document.getElementById("tabLogin");
  const tabRegistro = document.getElementById("tabRegistro");
  const formLogin = document.getElementById("formLogin");
  const formRegistro = document.getElementById("formRegistro");
  const irARegistro = document.getElementById("irARegistro");
  const irALogin = document.getElementById("irALogin");

  function mostrarForm(tipo) {
    tabLogin && tabLogin.classList.toggle("active", tipo === "login");
    tabRegistro && tabRegistro.classList.toggle("active", tipo === "registro");
    if (formLogin) formLogin.style.display = tipo === "login" ? "block" : "none";
    if (formRegistro) formRegistro.style.display = tipo === "registro" ? "block" : "none";
  }

  tabLogin?.addEventListener("click", () => mostrarForm("login"));
  tabRegistro?.addEventListener("click", () => mostrarForm("registro"));
  irARegistro?.addEventListener("click", e => { e.preventDefault(); mostrarForm("registro"); });
  irALogin?.addEventListener("click", e => { e.preventDefault(); mostrarForm("login"); });
  // ======================================================================================
  // LOGIN, REGISTRO Y RECUPERACI√ìN PIN (mantengo todo igual que tu DOM2)
  // ======================================================================================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";

  // ... Aqu√≠ copiar todo el c√≥digo de botones btnLogin, btnRegistro y flujo de recuperaci√≥n PIN de tu DOM2 ...
// ====================================================================================== 
// LOGIN (spinner instant√°neo al presionar bot√≥n)
// ======================================================================================
document.getElementById("btnLogin")?.addEventListener("click", async (e) => {
  e.preventDefault(); // evita dobles env√≠os
  const btnLogin = e.target;
  btnLogin.disabled = true; // üîí evita m√∫ltiples clics
  btnLogin.classList.add("btn-loading"); // animaci√≥n visual

  const correo = document.getElementById("loginCorreo").value.trim();
  const pin = document.getElementById("loginPin").value.trim();

  if (!correo || !pin) {
    btnLogin.disabled = false;
    btnLogin.classList.remove("btn-loading");
    return mostrarAviso("Completa todos los campos", "error");
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo)) {
    btnLogin.disabled = false;
    btnLogin.classList.remove("btn-loading");
    return mostrarAviso("Correo inv√°lido", "error");
  }
  // ‚úÖ Nueva validaci√≥n: m√≠nimo 4 caracteres, sin l√≠mite ni restricci√≥n de tipo
  if (pin.length < 4) {
    btnLogin.disabled = false;
    btnLogin.classList.remove("btn-loading");
    return mostrarAviso("El PIN o contrase√±a debe tener al menos 4 caracteres", "error");
  }

  // Mostrar spinner inmediatamente
  const loader = mostrarLoader("Iniciando sesi√≥n...");
  await new Promise(requestAnimationFrame); // ‚ö° fuerza a renderizar el loader antes del fetch

  const formData = new URLSearchParams();
  formData.append("accion", "login");
  formData.append("correo", correo);
  formData.append("pin", pin);

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData
    });

    const texto = await res.text();
    console.log("Login:", texto);

    try {
      const data = JSON.parse(texto);
      if (data.status && data.status.includes("success")) {
        const fotoPerfil = data.fotoPerfil || (Array.isArray(data.foto) ? data.foto[0] : "");

        const usuario = { 
          nombre: data.nombre, 
          correo: data.correo, 
          fotoPerfil: fotoPerfil 
        };

        localStorage.setItem("usuario", JSON.stringify(usuario));
        localStorage.setItem("autor", data.nombre);
        localStorage.setItem("correo", data.correo);

        currentAuthorName = data.nombre;
        currentAuthorEmail = data.correo;

        cerrarLoader(loader);
        btnLogin.disabled = false;
        btnLogin.classList.remove("btn-loading");
        cerrarModalYContinuar();

if (window.DEComAuthApply) window.DEComAuthApply();
if (window.DEComAuthPing)  window.DEComAuthPing();


        mostrarAviso("Bienvenido, " + data.nombre, "success");
      } else {
        cerrarLoader(loader);
        btnLogin.disabled = false;
        btnLogin.classList.remove("btn-loading");
        mostrarAviso(data.message || "Correo o PIN incorrecto", "error");
      }
    } catch {
      cerrarLoader(loader);
      btnLogin.disabled = false;
      btnLogin.classList.remove("btn-loading");
      mostrarAviso("Error del servidor", "error");
    }
  } catch {
    cerrarLoader(loader);
    btnLogin.disabled = false;
    btnLogin.classList.remove("btn-loading");
    mostrarAviso("Error de conexi√≥n", "error");
  }
});

// ======================================================================================
// REGISTRO (spinner instant√°neo al presionar bot√≥n, PIN libre de m√≠nimo 4 caracteres)
// ======================================================================================
document.getElementById("btnRegistro")?.addEventListener("click", async (e) => {
  e.preventDefault();

  const btnRegistro = e.target;
  btnRegistro.disabled = true; // üîí evita m√∫ltiples clics
  btnRegistro.classList.add("btn-loading"); // animaci√≥n visual

  const nombre = document.getElementById("regNombre").value.trim();
  const correo = document.getElementById("regCorreo").value.trim().toLowerCase();
  const pin = document.getElementById("regPin").value;
  const pinConfirm = document.getElementById("regPinConfirm").value;
  const preview = document.getElementById("previewFoto");

  if (!nombre || !correo || !pin || !pinConfirm) {
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");
    return mostrarAviso("Todos los campos son obligatorios", "error");
  }

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo)) {
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");
    return mostrarAviso("Correo inv√°lido", "error");
  }

  if (pin !== pinConfirm) {
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");
    return mostrarAviso("Los PIN no coinciden", "error");
  }

  // ‚úÖ Ahora acepta cualquier car√°cter, pero m√≠nimo 4
  if (pin.length < 4) {
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");
    return mostrarAviso("El PIN debe tener al menos 4 caracteres", "error");
  }

  if (!window.fotoComprimida) {
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");
    return mostrarAviso("Selecciona una foto antes de registrarte", "error");
  }

  // Mostrar spinner de inmediato
  const loader = mostrarLoader("Registrando usuario...");
  await new Promise(requestAnimationFrame);

  try {
    if (preview) {
      preview.innerHTML = `<img src="${window.fotoComprimida}" alt="Previsualizaci√≥n" 
        style="max-width:120px;border-radius:10px;display:block;margin:auto;">`;
    }

    const formData = new URLSearchParams();
    formData.append("accion", "registro");
    formData.append("nombre", nombre);
    formData.append("correo", correo);
    formData.append("pin", pin);
    formData.append("foto", window.fotoComprimida.split(",")[1]);

    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData
    });

    const texto = await res.text();
    console.log("Registro:", texto);
    cerrarLoader(loader);
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");

    if (texto.includes("registrado con foto") || texto.includes("Usuario registrado")) {
      mostrarAviso("Cuenta creada! Inicia sesi√≥n", "success");
      mostrarForm("login");
      document.getElementById("loginCorreo").value = correo;
    } else if (texto.includes("ya registrado")) {
      mostrarAviso("Ya existe un usuario con ese correo", "error");
    } else {
      mostrarAviso(texto || "Error al registrarse", "error");
    }
  } catch {
    cerrarLoader(loader);
    btnRegistro.disabled = false;
    btnRegistro.classList.remove("btn-loading");
    mostrarAviso("Error de conexi√≥n o al procesar imagen", "error");
  }
});


// ======================================================================================
// FUNCIONES DE SPINNER GLOBAL
// ======================================================================================
function mostrarLoader(texto = "Procesando...") {
  const overlay = document.createElement("div");
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.65)",
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "10000",
    color: "#fff",
    fontFamily: "system-ui, sans-serif",
    fontSize: "1.1em",
    textAlign: "center",
    backdropFilter: "blur(3px)",
    animation: "fadeIn 0.25s ease"
  });
  overlay.innerHTML = `
    <div style="
      width:60px;height:60px;
      border:6px solid rgba(255,255,255,0.3);
      border-top-color:#00aaff;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:15px;
    "></div>
    <span>${texto}</span>
  `;
  document.body.appendChild(overlay);
  return overlay;
}

function cerrarLoader(loader) {
  if (loader && loader.parentNode) {
    loader.style.animation = "fadeOut 0.25s ease";
    setTimeout(() => loader.remove(), 200);
  }
}

const styleSpinGlobal = document.createElement("style");
styleSpinGlobal.textContent = `
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
`;
document.head.appendChild(styleSpinGlobal);




// ============================
// üîÅ Recuperar PIN olvidado (con verificaci√≥n y cambio definitivo)
// ============================
let pinTemporalGenerado = "";
let correoRecuperacion = "";

// === Abrir flujo de recuperaci√≥n ===
document.getElementById("olvidastePin").addEventListener("click", () => {
  ocultarTodo();
  document.getElementById("formRecuperarPin").style.display = "block";
  document.getElementById("pasoCorreo").style.display = "block";
});

// === Volver al login ===
document.getElementById("volverLogin").addEventListener("click", () => {
  ocultarTodo();
  document.getElementById("formLogin").style.display = "block";
});

// === Enviar PIN temporal ===
document.getElementById("btnEnviarPinTemp").addEventListener("click", async () => {
  const correo = document.getElementById("recCorreo").value.trim();
  if (!correo) return mostrarAviso("Por favor ingresa tu correo.");

  correoRecuperacion = correo;
  pinTemporalGenerado = Math.floor(1000 + Math.random() * 9000).toString();

  const formData = new FormData();
  formData.append("accion", "cambiarPin");
  formData.append("correo", correo);
  formData.append("nuevoPin", pinTemporalGenerado);
  formData.append("modo", "temporal"); // para diferenciar si lo usas en el Apps Script

  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec", {
      method: "POST",
      body: formData
    });
    const data = await resp.json();

    if (data.status === "sipin") {
      mostrarAviso(`‚úÖ Se envi√≥ un PIN temporal a ${correo}.`);
      document.getElementById("pasoCorreo").style.display = "none";
      document.getElementById("pasoVerificar").style.display = "block";
      document.getElementById("tituloRecuperar").innerText = "üì© Ingresa el PIN que recibiste";
    } else {
      mostrarAviso("‚ö†Ô∏è Este correo no est√° registrado en DECOM.");
    }
  } catch {
    mostrarAviso("Error al enviar el PIN temporal.");
  }
});

// === Verificar PIN temporal ===
document.getElementById("btnVerificarPinTemp").addEventListener("click", () => {
  const pinIngresado = document.getElementById("recPinTemp").value.trim();
  if (pinIngresado === pinTemporalGenerado) {
    mostrarAviso("‚úÖ PIN temporal verificado.");
    document.getElementById("pasoVerificar").style.display = "none";
    document.getElementById("pasoNuevoPin").style.display = "block";
    document.getElementById("tituloRecuperar").innerText = "üîí Crear nuevo PIN o contrase√±a";
  } else {
    mostrarAviso("‚ùå El PIN temporal no coincide.");
  }
});

// === Cambiar PIN definitivo ===
document.getElementById("btnCambiarPin").addEventListener("click", async () => {
  const nuevoPin = document.getElementById("nuevoPin").value.trim();
  const confirmarPin = document.getElementById("confirmarPin").value.trim();

  // ‚úÖ Nuevo: acepta cualquier valor, m√≠nimo 4 caracteres
  if (!nuevoPin || nuevoPin.length < 4)
    return mostrarAviso("El PIN o contrase√±a debe tener al menos 4 caracteres.");

  if (nuevoPin !== confirmarPin)
    return mostrarAviso("Los PIN no coinciden.");

  const formData = new FormData();
  formData.append("accion", "cambiarPin");
  formData.append("correo", correoRecuperacion);
  formData.append("nuevoPin", nuevoPin);

  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec", {
      method: "POST",
      body: formData
    });
    const data = await resp.json();

    if (data.status === "sipin") {
      mostrarAviso("‚úÖ PIN cambiado exitosamente. Revisa tu correo de confirmaci√≥n.");
      ocultarTodo();
      document.getElementById("formLogin").style.display = "block";
    } else {
      mostrarAviso("Error al cambiar el PIN.");
    }
  } catch {
    mostrarAviso("Error de conexi√≥n.");
  }
});

// === Funci√≥n auxiliar ===
function ocultarTodo() {
  ["formLogin","formRegistro","formRecuperarPin"].forEach(id => document.getElementById(id).style.display = "none");
  ["pasoCorreo","pasoVerificar","pasoNuevoPin"].forEach(id => document.getElementById(id).style.display = "none");
}

// ======================================================================================
// CERRAR MODAL Y CONTINUAR
// ======================================================================================
function cerrarModalYContinuar() {
  modal.style.display = "none";
  document.querySelectorAll("div[style*='z-index: 99998'], .loading").forEach(el => el.remove());
  setTimeout(() => location.reload(), 500);
}



    
  // ======================================================================================
  // MANEJO DE USUARIO
  // ======================================================================================
  const userBtn = document.getElementById("userBtn");
  const userMenu = document.getElementById("userMenu");
  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");



  // =========================================================
//  Conectar botones del men√∫ lateral (Mi perfil, Notificaciones)
//  SIN cambiar el HTML ni afectar otras funciones
// =========================================================
function initUserMenuSideButtons() {
  const userMenu = document.getElementById("userMenu");
  if (!userMenu) return;

  // Cierra men√∫ al tocar el fondo oscuro (overlay)
  userMenu.addEventListener("click", (e) => {
    if (e.target === userMenu) userMenu.style.display = "none";
  });

  // Buscar bot√≥n por texto (para no modificar tu HTML)
  const menuButtons = Array.from(userMenu.querySelectorAll("button.menu-btn"));

  const profileBtn = menuButtons.find(btn =>
    btn.textContent.toLowerCase().includes("mi perfil")
  );

  const notifBtn = menuButtons.find(btn =>
    btn.textContent.toLowerCase().includes("notificaciones")
  );

  // ---- MI PERFIL ----
  if (profileBtn) {
    profileBtn.addEventListener("click", (e) => {
      e.preventDefault();
      userMenu.style.display = "none";

      if (typeof abrirPerfil === "function") {
        abrirPerfil(); // ‚úÖ esta funci√≥n ya existe en tu archivo
      } else {
        console.warn("No existe la funci√≥n abrirPerfil() en este archivo.");
      }
    });
  }

  // ---- NOTIFICACIONES (solo si tienes funci√≥n) ----
  if (notifBtn) {
    notifBtn.addEventListener("click", (e) => {
      e.preventDefault();
      userMenu.style.display = "none";

      // Si tienes alguna funci√≥n existente para notificaciones, ponla aqu√≠:
      if (typeof abrirNotificaciones === "function") {
        abrirNotificaciones();
      } else if (typeof mostrarNotificaciones === "function") {
        mostrarNotificaciones();
      } else {
        console.warn("No hay funci√≥n de notificaciones definida (abrirNotificaciones/mostrarNotificaciones).");
      }
    });
  }
}


// üü¢ Bot√≥n de contacto por WhatsApp
const whatsappBtn = document.getElementById("whatsappBtn");

if (whatsappBtn) {
  whatsappBtn.addEventListener("click", () => {
    // Reemplaz√° con tu n√∫mero en formato internacional sin "+" ni espacios
    const phone = "+573202897214"; // üá¶üá∑ Ejemplo: +54 9 11 2233-4455 ‚Üí "5491122334455"

    // Mensaje opcional personalizado
    const message = encodeURIComponent("¬°Hola! Quisiera hacer una consulta desde la app.");

    // Enlace oficial de WhatsApp
    const url = `https://wa.me/${phone}?text=${message}`;

    // Abrir en nueva pesta√±a
    window.open(url, "_blank");
  });
}

 
// ================================
//  Tema (claro/oscuro) - igual que fotos
// ================================
(function initThemeToggle(){
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  const body = document.body;
  if (!themeToggle || !themeIcon || !themeText) return;

  // MODO CLARO por defecto
  if (localStorage.getItem('theme') === 'dark') {
    enableDarkMode();
  } else {
    enableLightMode();
  }

  themeToggle.addEventListener('click', () => {
    if (body.classList.contains('dark-mode')) {
      enableLightMode();
      localStorage.setItem('theme', 'light');
    } else {
      enableDarkMode();
      localStorage.setItem('theme', 'dark');
    }
  });

  function enableDarkMode() {
    body.classList.add('dark-mode');
    themeIcon.className = 'fas fa-moon';
    themeText.textContent = 'Tema oscuro';
  }

  function enableLightMode() {
    body.classList.remove('dark-mode');
    themeIcon.className = 'fas fa-sun';
    themeText.textContent = 'Tema claro';
  }
})();
   

 function mostrarUsuario(u) {
  if (!userBtn) return;
  console.log("mostrarUsuario - objeto recibido:", u);

  // ‚úÖ Detectar si ya hay imagen en el bot√≥n (pero NO salir de la funci√≥n)
  let yaTieneImagen = !!userBtn.querySelector("img");

  // ‚úÖ Limpiar cualquier nodo previo si no tiene imagen aun
  if (!yaTieneImagen) {
    while (userBtn.firstChild) {
      userBtn.removeChild(userBtn.firstChild);
    }
  }

  u = u || {};
  u.nombre = u.nombre || u.name || localStorage.getItem("autor") || "Usuario";
  u.correo = u.correo || u.email || localStorage.getItem("correo") || "";

  let foto = u.fotoPerfil || u.foto || u.fotoUrl || u.avatar || "";
  if (Array.isArray(foto) && foto.length) foto = foto[0];

  const isDataUrl = typeof foto === "string" && foto.startsWith("data:");

  function buildDriveCandidates(src) {
    const s = String(src || "").trim();
    const candidates = [];
    if (!s) return candidates;

    candidates.push(s);

    const idOnlyMatch = s.match(/^[A-Za-z0-9_-]{20,80}$/);
    if (idOnlyMatch) {
      const id = idOnlyMatch[0];
      candidates.push(`https://drive.google.com/uc?export=view&id=${id}`);
      candidates.push(`https://drive.google.com/uc?export=download&id=${id}`);
      candidates.push(`https://drive.google.com/thumbnail?authuser=0&sz=w320&id=${id}`);
      candidates.push(`https://docs.google.com/uc?export=download&id=${id}`);
      return candidates;
    }

    const m = s.match(/(?:id=|\/d\/)([A-Za-z0-9_-]{20,80})/);
    if (m && m[1]) {
      const id = m[1];
      candidates.push(`https://drive.google.com/uc?export=view&id=${id}`);
      candidates.push(`https://drive.google.com/uc?export=download&id=${id}`);
      candidates.push(`https://drive.google.com/thumbnail?authuser=0&sz=w320&id=${id}`);
      candidates.push(`https://docs.google.com/uc?export=download&id=${id}`);
    }

    return Array.from(new Set(candidates));
  }

  function fallback() {
    mostrarIniciales(u);
  }

  if (!foto) {
    console.warn("mostrarUsuario - no hay foto para mostrar, usando iniciales");
    fallback();
  } else if (isDataUrl) {
    const img = document.createElement("img");
    img.src = foto;
    img.alt = u.nombre || "avatar";

    Object.assign(img.style, {
      width: "36px",
      height: "36px",
      borderRadius: "50%",
      objectFit: "cover",
      border: "2px solid #0077cc",
      boxShadow: "0 1px 3px rgba(0,0,0,0.2)"
    });

    img.onerror = () => {
      console.error("Imagen base64 fall√≥ al cargar");
      fallback();
    };

    if (!yaTieneImagen) userBtn.appendChild(img);

  } else {
    const candidates = buildDriveCandidates(foto);
    console.log("mostrarUsuario - candidatos de imagen:", candidates);

    let idx = 0;
    let finished = false;

    const tryNext = () => {
      if (finished) return;
      if (idx >= candidates.length) {
        console.warn("mostrarUsuario - ning√∫n candidato funcion√≥, fallback");
        finished = true;
        fallback();
        return;
      }

      const url = candidates[idx++];
      if (!url) return tryNext();

      const testImg = new Image();
      testImg.referrerPolicy = "no-referrer";

      let loaded = false;

      const cleanupAndAppend = (finalUrl) => {
        if (finished) return;
        finished = true;
        const img = document.createElement("img");
        img.src = finalUrl;
        img.alt = u.nombre || "avatar";

        Object.assign(img.style, {
          width: "36px",
          height: "36px",
          borderRadius: "50%",
          objectFit: "cover",
          border: "2px solid #0077cc",
          boxShadow: "0 1px 3px rgba(0,0,0,0.2)"
        });

        if (!yaTieneImagen) userBtn.appendChild(img);
      };

      testImg.onload = () => {
        loaded = true;
        console.log("mostrarUsuario - carga OK:", url);
        cleanupAndAppend(url);
      };

      testImg.onerror = (e) => {
        console.warn("mostrarUsuario - fallo carga candidato:", url, e);
        setTimeout(() => tryNext(), 150);
      };

      const to = setTimeout(() => {
        if (!loaded && !finished) {
          console.warn("mostrarUsuario - timeout candidato:", url);
          tryNext();
        }
      }, 3500);

      try {
        testImg.src = url;
      } catch (err) {
        console.warn("mostrarUsuario - error al asignar src:", err);
        clearTimeout(to);
        tryNext();
      }
    };

    tryNext();
  }

  if (userName) userName.textContent = u.nombre;
  if (userEmail) userEmail.textContent = u.correo;
  if (userName) userName.style.color = "#333";
  if (userEmail) userEmail.style.color = "#555";

  currentAuthorName = u.nombre;
  currentAuthorEmail = u.correo;

  // === Sincronizar tambi√©n la foto en el men√∫ desplegable ===
const menuPhoto = document.getElementById("userMenuPhoto");
if (menuPhoto) {
  menuPhoto.innerHTML = ""; // limpiar

  const imgBtn = userBtn.querySelector("img");
  
  if (imgBtn && imgBtn.src) {
    // ‚úÖ Mostrar exactamente la misma foto
    menuPhoto.innerHTML = `
      <img src="${imgBtn.src}" style="
        width:80px;
        height:80px;
        border-radius:50%;
        object-fit:cover;
        border:2px solid #0077cc;
      ">
    `;
  } else {
    // ‚úÖ Iniciales elegantes
    const iniciales = (u.nombre || "US")
      .trim()
      .split(" ")
      .map(p => p.charAt(0).toUpperCase())
      .join("")
      .substring(0,2);

    menuPhoto.innerHTML = `
      <div style="
        width:80px;
        height:80px;
        border-radius:50%;
        background:#0077cc;
        color:white;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:28px;
        font-weight:bold;
      ">
        ${iniciales}
      </div>
    `;
  }

  // üîó Abrir modal perfil al tocar la foto grande
  menuPhoto.style.cursor = "pointer";
  menuPhoto.onclick = abrirPerfil;
}

}

  // Inicializar usuario al cargar p√°gina
  if (usuarioGuardado) mostrarUsuario(usuarioGuardado);

  // Conectar acciones del men√∫ lateral (Mi perfil / Notificaciones)
initUserMenuSideButtons();


  if (userBtn && userMenu) {
    userBtn.addEventListener("click", () => {
      userMenu.style.display = userMenu.style.display === "block" ? "none" : "block";
    });
}

/* =========================================================
   FIX: cuando videosSesion2.html est√° embebido (feed en iframe),
   el header puede ocultarse y con √©l el men√∫.
   Movemos #userMenu al <body> para que se pueda ver.
========================================================= */
(function ensureUserMenuOutsideHeader(){
  try {
    const embedded = (window.self !== window.top);
    if (!embedded) return;

    document.body.classList.add("embedded");

    const menu = document.getElementById("userMenu");
    if (menu && menu.parentElement !== document.body) {
      document.body.appendChild(menu);
    }
  } catch (e) {
    console.warn("ensureUserMenuOutsideHeader error:", e);
  }
})();

  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
   localStorage.removeItem("usuario");
localStorage.removeItem("autor");
localStorage.removeItem("correo");

if (window.DEComAuthApply) window.DEComAuthApply();
if (window.DEComAuthPing)  window.DEComAuthPing();

// si quieres mantener tu reload, d√©jalo:
location.reload();

    });
  }
});

function abrirPerfil() {
  // Cerrar userMenu si est√° abierto
  const userMenu = document.getElementById("userMenu");
  if (userMenu) userMenu.style.display = "none";

  // Mostrar modal
  const modal = document.getElementById("modalPerfil");
  modal.style.display = "flex";

  // Elementos relevantes
  const userBtn = document.getElementById("userBtn");
  const userBtnImg = userBtn ? userBtn.querySelector("img") : null;
  const fotoModal = document.getElementById("fotoPerfilModal");
  const menuPhoto = document.getElementById("userMenuPhoto");

  // Determinar la fuente de la foto (prioridad)
  let fotoSrc = "";

  // 1) imagen en el bot√≥n
  if (userBtnImg && userBtnImg.src) fotoSrc = userBtnImg.src;

  // 2) si no, la que ya tenga el modal
  if (!fotoSrc && fotoModal && fotoModal.src && fotoModal.src.trim() !== "") {
    fotoSrc = fotoModal.src;
  }

  // 3) si no, la que tenga userMenuPhoto
  const menuImg = menuPhoto ? menuPhoto.querySelector("img") : null;
  if (!fotoSrc && menuImg && menuImg.src) fotoSrc = menuImg.src;

  // 4) si no, intentar desde localStorage (si guardaste la foto)
  if (!fotoSrc && localStorage.getItem("fotoPerfil")) {
    fotoSrc = localStorage.getItem("fotoPerfil");
  }

  // Aplicar la foto donde corresponda
  if (fotoSrc) {
    // al modal
    if (fotoModal) fotoModal.src = fotoSrc;

    // al men√∫ desplegable (foto grande)
    if (menuPhoto) {
      menuPhoto.innerHTML = `
        <img src="${fotoSrc}" style="
          width:80px;
          height:80px;
          border-radius:50%;
          object-fit:cover;
          border:2px solid #0077cc;
        ">
      `;
      menuPhoto.style.cursor = "pointer";
      menuPhoto.onclick = abrirPerfil;
    }

    // al bot√≥n peque√±o (si por alguna raz√≥n no tiene imagen)
    if (userBtn && !userBtnImg) {
      userBtn.innerHTML = `<img src="${fotoSrc}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`;
    }
  }

  // Nombre y correo
  const uiName = document.getElementById("userName");
  const uiEmail = document.getElementById("userEmail");

  if (uiName) document.getElementById("nombrePerfil").innerText = uiName.innerText;
  if (uiEmail) document.getElementById("correoPerfil").innerText = uiEmail.innerText;
}



function cerrarModalPerfil() {
  document.getElementById("modalPerfil").style.display = "none";
}

// ==============================
// CERRAR AL HACER CLICK AFUERA
// ==============================
window.addEventListener("click", function (e) {
  const modal = document.getElementById("modalPerfil");
  const contenido = document.getElementById("contenidoModalPerfil");

  if (e.target === modal) {
    cerrarModalPerfil();
  }
});

// ==============================
// CERRAR CON TECLA ESC
// ==============================
document.addEventListener("keydown", function (e) {
  if (e.key === "Escape") {
    cerrarModalPerfil();
  }
});

// ==============================
// ABRIR SELECTOR CON ‚úèÔ∏è
// ==============================
document.getElementById("editarFotoBtn").addEventListener("click", () => {
  document.getElementById("inputFotoPerfil").click();
});

// ==============================
// CUANDO SE SELECCIONA UNA FOTO
// ==============================
document.getElementById("inputFotoPerfil").addEventListener("change", async (e) => {
  const archivo = e.target.files[0];
  if (!archivo) return;

  const lector = new FileReader();
  lector.onload = async () => {
    const base64 = lector.result;

    const fotoModal = document.getElementById("fotoPerfilModal");
    const userBtn = document.getElementById("userBtn");
    const menuPhoto = document.getElementById("userMenuPhoto");

    // Mostrar inmediatamente previsualizaci√≥n local
    if (fotoModal) fotoModal.src = base64;
    if (userBtn) userBtn.innerHTML = `<img src="${base64}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`;
    if (menuPhoto) menuPhoto.innerHTML = `<img src="${base64}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #0077cc;">`;

    // Guardar previsualizaci√≥n temporal local
    try {
      localStorage.setItem("fotoPerfil", base64);
      const u = JSON.parse(localStorage.getItem("usuario")) || {};
      u.fotoPerfil = base64;
      localStorage.setItem("usuario", JSON.stringify(u));
    } catch (err) {}

    try {
      const formData = new FormData();
      formData.append("accion", "actualizarFoto");
      formData.append("usuario", document.getElementById("userEmail").innerText);
      formData.append("foto", base64);

      const resp = await fetch("https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec", {
        method: "POST",
        body: formData
      });

      const text = await resp.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        console.error("Respuesta no v√°lida:", text);
         mostrarAviso("Respuesta no v√°lida del servidor: " + text);
        return;
      }

      // --- Eliminamos el  mostrarAviso anterior ---
      //  mostrarAviso("Respuesta del servidor:\n" + text);

      if (data.status === "success" && data.foto) {
        // üöÄ Nuevo enlace Drive con par√°metro √∫nico para evitar cach√©
        const fotoNoCache = `${data.foto}?v=${Date.now()}`;

        // --- Precarga para evitar √≠cono roto ---
        const preload = new Image();
        preload.onload = () => {
          // === Fade suave ===
          const fadeIn = (el, newSrc) => {
            if (!el) return;
            el.style.transition = "opacity 0.4s ease";
            el.style.opacity = "0";
            setTimeout(() => {
              el.src = newSrc;
              el.onerror = () => console.warn("‚ö†Ô∏è Error cargando imagen nueva, se mantiene la anterior.");
              el.onload = () => { el.style.opacity = "1"; };
            }, 200);
          };

          // === Actualizar interfaz completa ===
          fadeIn(fotoModal, fotoNoCache);

          if (userBtn) {
            const imgBtn = userBtn.querySelector("img");
            if (imgBtn) fadeIn(imgBtn, fotoNoCache);
            else userBtn.innerHTML = `<img src="${fotoNoCache}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`;

            // ‚ú® Efecto de brillo temporal
            userBtn.style.position = "relative";
            userBtn.style.boxShadow = "0 0 12px 4px rgba(0, 180, 255, 0.7)";
            userBtn.style.transition = "box-shadow 0.6s ease";
            setTimeout(() => {
              userBtn.style.boxShadow = "0 0 0 0 rgba(0, 180, 255, 0)";
            }, 1200);
          }

          if (menuPhoto) {
            const imgMenu = menuPhoto.querySelector("img");
            if (imgMenu) fadeIn(imgMenu, fotoNoCache);
            else menuPhoto.innerHTML = `<img src="${fotoNoCache}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #0077cc;">`;

            // üí´ Brillo tambi√©n en el recuadro del men√∫
            menuPhoto.style.boxShadow = "0 0 16px 5px rgba(0, 180, 255, 0.6)";
            menuPhoto.style.transition = "box-shadow 0.6s ease";
            setTimeout(() => {
              menuPhoto.style.boxShadow = "0 0 0 0 rgba(0, 180, 255, 0)";
            }, 1200);
          }

          // === Guardar correctamente en localStorage ===
          try {
            localStorage.setItem("fotoPerfil", fotoNoCache);
            const usuarioGuardado = JSON.parse(localStorage.getItem("usuario")) || {};
            usuarioGuardado.fotoPerfil = fotoNoCache;
            localStorage.setItem("usuario", JSON.stringify(usuarioGuardado));
          } catch (err) {
            console.warn("No se pudo guardar la foto nueva localmente:", err);
          }

          // === Actualizar objeto usuario en ejecuci√≥n ===
          if (typeof mostrarUsuario === "function") {
            const u = {
              nombre: document.getElementById("userName")?.textContent || "",
              correo: document.getElementById("userEmail")?.textContent || "",
              fotoPerfil: fotoNoCache
            };
            mostrarUsuario(u);
          }
        };

        preload.onerror = () => {
          console.warn("‚ö†Ô∏è No se pudo precargar la imagen nueva, se conserva la actual.");
        };

        preload.src = fotoNoCache; // inicia precarga
      } else {
        console.error("Error al actualizar foto:", data.message || data);
         mostrarAviso("No se pudo actualizar la foto en Drive.");
      }

    } catch (err) {
      console.error("Error al comunicarse con backend:", err);
       mostrarAviso("Error al actualizar foto de perfil. Revisa la conexi√≥n o el script.");
    }
  };

  lector.readAsDataURL(archivo);
});








// --------------------------
// Sincronizar foto del men√∫
// --------------------------
function syncUserMenuPhoto() {
  const userBtn = document.getElementById("userBtn");
  const menuPhoto = document.getElementById("userMenuPhoto");
  const fotoModal = document.getElementById("fotoPerfilModal");

  if (!menuPhoto) return;

  // buscar img en userBtn
  const imgBtn = userBtn ? userBtn.querySelector("img") : null;
  let src = "";

  if (imgBtn && imgBtn.src) src = imgBtn.src;
  // si no, usar la del modal (si ya tiene)
  if (!src && fotoModal && fotoModal.src && fotoModal.src.trim() !== "") src = fotoModal.src;
  // si no, intentar localStorage
  if (!src && localStorage.getItem("fotoPerfil")) src = localStorage.getItem("fotoPerfil");

  // aplicar al menu
  if (src) {
    menuPhoto.innerHTML = `
      <img src="${src}" style="
        width:80px;
        height:80px;
        border-radius:50%;
        object-fit:cover;
        border:2px solid #0077cc;
      ">
    `;
  } else {
    // fallback a iniciales (mantenemos tu estilo)
    const uNombre = (document.getElementById("userName")?.textContent || "Usuario").trim();
    const iniciales = uNombre.split(" ").map(p => p.charAt(0).toUpperCase()).join("").substring(0,2) || "US";
    menuPhoto.innerHTML = `
      <div style="
        width:80px;height:80px;border-radius:50%;
        background:#0077cc;color:white;display:flex;
        align-items:center;justify-content:center;font-size:28px;font-weight:bold;
      ">${iniciales}</div>
    `;
  }

  // comportamiento extra
  menuPhoto.style.cursor = "pointer";
  menuPhoto.onclick = abrirPerfil;
}

// --------------------------
// Toggle / abrir men√∫ usuario
// --------------------------
function toggleUserMenu() {
  const menu = document.getElementById("userMenu");
  if (!menu) return;

  const isHidden = window.getComputedStyle(menu).display === "none";
  if (isHidden) {
    // sincronizar justo antes de mostrar
    syncUserMenuPhoto();
    menu.style.display = "block";
  } else {
    menu.style.display = "none";
  }
}

// --------------------------
// Observador: si cambia userBtn (ej: se inserta img), actualizar men√∫
// --------------------------
(function observeUserBtnImg() {
  const userBtn = document.getElementById("userBtn");
  if (!userBtn) return;

  const mo = new MutationObserver((mutations) => {
    for (const m of mutations) {
      // si se agreg√≥/quit√≥ nodo o cambi√≥ atributo src en un <img>, sincronizar
      if (m.type === "childList" && (m.addedNodes.length || m.removedNodes.length)) {
        syncUserMenuPhoto();
        return;
      }
      if (m.type === "attributes" && m.target && m.target.tagName === "IMG" && m.attributeName === "src") {
        syncUserMenuPhoto();
        return;
      }
    }
  });

  mo.observe(userBtn, { childList: true, subtree: true, attributes: true, attributeFilter: ["src"] });
})();



    // ======================================================================================
// EFECTO RIPPLE EN BOTONES LOGIN Y REGISTRO
// ======================================================================================
function agregarEfectoRipple(boton) {
  boton.addEventListener("click", function (e) {
    const ripple = document.createElement("span");
    ripple.classList.add("ripple");
    this.appendChild(ripple);

    const rect = this.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size / 2;
    const y = e.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;

    setTimeout(() => ripple.remove(), 600); // elimina el efecto despu√©s de animar
  });
}

["btnLogin", "btnRegistro"].forEach(id => {
  const btn = document.getElementById(id);
  if (btn) agregarEfectoRipple(btn);
});









// Mostrar/ocultar overlays al tocar el slider
document.querySelector('.swiper').addEventListener('click', (e) => {
  // üëâ Evitar que se cierre si se hace click en el t√≠tulo o descripci√≥n
  if (e.target.closest('#video-title-fixed')) {
    return; // no hacer nada
  }

  const currentTime = new Date().getTime();
  if (currentTime - lastTapTime > 300) {
    commentsOverlay.classList.toggle('hidden-overlay');
    commentsCounter.classList.toggle('hidden-overlay');
    commentInputContainer.classList.toggle('hidden-overlay');

    // üîî Ocultar bot√≥n y lista de notificaciones
    notificationWrapper.classList.toggle('hidden-overlay');
    notificationList.classList.add('hidden'); // Cierra la lista si estaba abierta

    // üëá Tambi√©n alternar el t√≠tulo
    document.getElementById("video-title-fixed").classList.toggle("hidden-overlay");

    // üÜï Tambi√©n ocultar/mostrar el bot√≥n de actualizar
    const refreshBtn = document.getElementById("refreshBtn");
    if (refreshBtn) {
      refreshBtn.classList.toggle("hidden-overlay");
    }

    // üÜï Ocultar/mostrar guardar y ver guardados
    const saveBtn = document.getElementById("saveBtn");
    const viewSavedBtn = document.getElementById("viewSavedBtn");
    if (saveBtn) saveBtn.classList.toggle("hidden-overlay");
    if (viewSavedBtn) viewSavedBtn.classList.toggle("hidden-overlay");

    // üÜï Ocultar/mostrar contenedor de botones flotantes
    const floatingButtons = document.querySelector(".floating-buttons");
    if (floatingButtons) {
      floatingButtons.classList.toggle("hidden-overlay");
    }

// ‚ù§Ô∏è Ocultar/mostrar bot√≥n de Like
if (likesCounter) {
  likesCounter.classList.toggle('hidden-overlay');
}



    // üÜï Alternar el encabezado DECOM y botones
    const socialHeader = document.getElementById("socialHeader");
    if (socialHeader) {
      socialHeader.classList.toggle("hidden-overlay");
    }

    // üÜï NUEVO: cerrar el men√∫ de usuario si est√° abierto
    const userMenu = document.getElementById("userMenu");
    if (userMenu && window.getComputedStyle(userMenu).display !== "none") {
      userMenu.style.display = "none";
      document.removeEventListener("click", cerrarMenuSiClickFuera);
    }
  }

  lastTapTime = currentTime;
});








// === Expandir / Colapsar comentarios ===
commentsOverlay.addEventListener('click', (e) => {
  if (!isSwiping) {
    commentsOverlay.classList.toggle('expanded');
  }
  isSwiping = false;
});

// ‚ù§Ô∏è Click en bot√≥n de like
if (likesCounter) {
  likesCounter.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleLikeVideoActual();
  });
}


// === Obtener el ID del video activo ===
function getActiveVideoId() {
  if (!swiper) return null;
  const activeSlide = swiper.slides[swiper.activeIndex];
  if (!activeSlide) return null;
  return activeSlide.dataset.videoid || null;
}

// üöÄ Apenas carga la p√°gina, enviamos "success" a App Inventor
window.addEventListener("load", () => {
  try {
    if (typeof AppInventor !== "undefined" && AppInventor.setWebViewString) {
      AppInventor.setWebViewString("success");
      console.log("‚úÖ Se envi√≥ 'success' a App Inventor");
    }
  } catch (err) {
    console.warn("No se pudo enviar 'success' a App Inventor:", err);
  }
});


        
// üóÇÔ∏è Cach√© de comentarios
const comentariosCache = {}; // { videoId: [comentarios] }

// ‚úÖ Actualizaci√≥n instant√°nea del contador (sin esperar fetch)
function actualizarContadorComentariosUI(videoId, opts = {}) {
  const { loading = false } = opts;
  const el = document.getElementById('commentCountValue');
  if (!el) return;

  // Siempre mostrar el badge (incluye 0) para evitar ‚Äúparpadeo‚Äù/demoras
  el.style.display = 'flex';

  // Si ya hay cach√©/memoria, mostramos el n√∫mero al instante
  const lista = (comentariosPorVideo && comentariosPorVideo[videoId]) || (comentariosCache && comentariosCache[videoId]) || null;
  if (Array.isArray(lista)) {
    el.textContent = String(lista.length);
    return;
  }

  // Si a√∫n no hay datos, mostramos 0 (instant√°neo) y opcionalmente un estado ‚Äúloading‚Äù
  el.textContent = '0';
  if (loading) {
    // Marca ligera para depuraci√≥n; no afecta UI visible
    el.dataset.loading = '1';
  } else {
    delete el.dataset.loading;
  }
}



// ‚úÖ Polling: detectar cambios por edici√≥n de videos (timestamp global)
let ultimaActualizacionVideosAnterior = "";

// Inicializa (evita falso positivo)
async function initSyncVideos() {
  try {
    const resp = await fetch(`${SCRIPT_URL}?accion=ultimaActualizacionVideos&_=${Date.now()}`);
    const json = await resp.json();
    ultimaActualizacionVideosAnterior = (json.timestamp || "").toString();
  } catch (e) {
    console.warn("No se pudo inicializar sync videos:", e);
  }
}
document.addEventListener("DOMContentLoaded", initSyncVideos);

// Verifica cambios y refresca en segundo plano
async function verificarActualizacionVideos() {
  try {
    const resp = await fetch(`${SCRIPT_URL}?accion=ultimaActualizacionVideos&_=${Date.now()}`);
    const json = await resp.json();
    const ts = (json.timestamp || "").toString();

    if (!ultimaActualizacionVideosAnterior) {
      ultimaActualizacionVideosAnterior = ts;
      return;
    }

    if (ts && ts !== ultimaActualizacionVideosAnterior) {
      console.log("üé¨ Cambio detectado en videos, refrescando en segundo plano...");
      ultimaActualizacionVideosAnterior = ts;

      // refresca sin destruir todo
      await cargarVideos(true);
    }
  } catch (e) {
    console.error("Error verificando ultimaActualizacionVideos:", e);
  }
}




function precargarComentarios(videoId) {
  if (!videoId) return;
  // No bloquear UI: si est√° en cach√©, cargarComentarios retorna inmediato.
  // Si no, hace fetch en background para que el swipe siguiente sea instant√°neo.
  Promise.resolve(cargarComentarios(videoId, false)).catch(() => {});
}

// üóÇÔ∏è Cach√© de likes
const likesCache = {}; // { videoId: { count, liked } }

function actualizarLikeUI(videoId) {
  if (!videoId) return;
  // ‚úÖ Si hay una operaci√≥n pendiente, no repintar desde otros flujos (evita parpadeo)
  if (likePendingPorVideo && likePendingPorVideo[videoId]) return;

  const count = Number(likesPorVideo[videoId] || 0);
  if (likeCountValue) {
    likeCountValue.textContent = count;
    likeCountValue.style.display = (count > 0) ? 'flex' : 'none';
  }

  const liked = !!likedPorVideo[videoId];
  if (likeIcon) {
    // FontAwesome 6 (ya est√° cargado en el HTML)
    likeIcon.className = liked ? 'fas fa-heart' : 'far fa-heart';
  }
}

// === Cargar likes desde Google Sheets con cach√© ===
async function cargarLikes(videoId, options = {}) {
  if (!videoId) return;
  const force = options.force || false;

  if (!force && likesCache[videoId]) {
    likesPorVideo[videoId] = likesCache[videoId].count || 0;
    likedPorVideo[videoId] = !!likesCache[videoId].liked;
    actualizarLikeUI(videoId);
    return;
  }

  try {
    const correo = (typeof currentAuthorEmail !== 'undefined' ? currentAuthorEmail : (localStorage.getItem('userEmail') || '')) || '';
    const res = await fetch(
      `${SCRIPT_URL}?accion=obtenerContadorLikesVideo&videoId=${encodeURIComponent(videoId)}&correo=${encodeURIComponent(correo)}&_=${Date.now()}`
    );
    const data = await res.json();

    const count = Number(data.likes || 0);
    const liked = !!data.liked;

    likesPorVideo[videoId] = count;
    likedPorVideo[videoId] = liked;
    likesCache[videoId] = { count, liked };

    actualizarLikeUI(videoId);
  } catch (e) {
    console.error('Error cargando likes:', e);
  }
}

async function toggleLikeVideoActual() {
  const videoId = getActiveVideoId();
  if (!videoId) return;

  if (likePendingPorVideo[videoId]) return;

  const prevLiked = !!likedPorVideo[videoId];
  const prevCount = Number(likesPorVideo[videoId] || 0);

  // ‚úÖ UI optimista
  const nextLiked = !prevLiked;
  const nextCount = Math.max(0, prevCount + (nextLiked ? 1 : -1));
  likedPorVideo[videoId] = nextLiked;
  likesPorVideo[videoId] = nextCount;
  if (likesCache[videoId]) {
    likesCache[videoId].count = nextCount;
    likesCache[videoId].liked = nextLiked;
  } else {
    likesCache[videoId] = { count: nextCount, liked: nextLiked };
  }
  if (likeCountValue) {
    likeCountValue.textContent = nextCount;
    likeCountValue.style.display = (nextCount > 0) ? 'flex' : 'none';
  }
  if (likeIcon) {
    likeIcon.className = nextLiked ? 'fas fa-heart' : 'far fa-heart';
  }

  likePendingPorVideo[videoId] = true;

  try {
    const correo = (typeof currentAuthorEmail !== 'undefined' ? currentAuthorEmail : (localStorage.getItem('userEmail') || '')) || '';
    const autor = (typeof currentAuthorName !== 'undefined' ? currentAuthorName : (localStorage.getItem('userName') || '')) || '';

    const params = new URLSearchParams({
      accion: 'toggleLikeVideo',
      videoId,
      correo,
      autor
    });

    const resp = await fetch(`${SCRIPT_URL}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    const data = await resp.json();

    if (data && data.status === 'success') {
      const serverLiked = !!data.liked;
      const serverLikes = Number(data.likes || 0);

      likedPorVideo[videoId] = serverLiked;
      likesPorVideo[videoId] = serverLikes;
      likesCache[videoId] = { count: serverLikes, liked: serverLiked };
      actualizarLikeUI(videoId);
      notificarCambioLikesVideos();

    } else {
      // rollback si error
      likedPorVideo[videoId] = prevLiked;
      likesPorVideo[videoId] = prevCount;
      likesCache[videoId] = { count: prevCount, liked: prevLiked };
      actualizarLikeUI(videoId);
    }
  } catch (e) {
    console.error('Error toggle like:', e);
    // rollback
    likedPorVideo[videoId] = prevLiked;
    likesPorVideo[videoId] = prevCount;
    likesCache[videoId] = { count: prevCount, liked: prevLiked };
    actualizarLikeUI(videoId);
  } finally {
    likePendingPorVideo[videoId] = false;
  }
}

// Click en el bot√≥n de likes
if (likesCounter) {
  likesCounter.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleLikeVideoActual();
  });
}

// === Cargar comentarios desde Google Sheets con cach√© ===
// === Cargar comentarios desde Google Sheets con cach√© ===
// üöÄ Optimizaci√≥n: evitar fetch innecesarios y permitir forzar recarga
async function cargarComentarios(videoId, render = true, options = {}) {
  if (!videoId) return;

  const force = options.force || false;

  // ‚úÖ Si ya tenemos en cach√© y no forzamos ‚Üí render instant√°neo
  if (!force && comentariosCache[videoId]) {
    comentariosPorVideo[videoId] = comentariosCache[videoId];
    if (render) renderComentarios(videoId);
    return;
  }

  // ‚úÖ Si ya tenemos en memoria y no forzamos ‚Üí usar eso
  if (!force && comentariosPorVideo[videoId]) {
    comentariosCache[videoId] = comentariosPorVideo[videoId];
    if (render) renderComentarios(videoId);
    return;
  }

  // ‚ö° Si no hay datos o se forz√≥ ‚Üí fetch directo al servidor (con cache-buster)
  try {
    const res = await fetch(
      `${SCRIPT_URL}?accion=listarComentarios&videoId=${encodeURIComponent(videoId)}&_=${Date.now()}`
    );
    const data = await res.json();

    comentariosPorVideo[videoId] = Array.isArray(data.data)
      ? data.data.map(c => ({
          autor: c[2] || "An√≥nimo",
          comentario: c[1] || "",
          // üîπ Formatear fecha siempre a local string
          fecha: c[4] ? new Date(c[4]).toLocaleString() : "",
          correo: c[3] || ""
        }))
      : [];

    comentariosCache[videoId] = comentariosPorVideo[videoId];

    if (render) renderComentarios(videoId);
  } catch (e) {
    console.error("Error cargando comentarios:", e);
    comentariosPorVideo[videoId] = [];
    comentariosCache[videoId] = [];
    if (render) renderComentarios(videoId);
  }
}



function renderComentarios(videoId) {
  if (!videoId) return;

  const lista = comentariosPorVideo[videoId] || [];
  const commentsList = document.getElementById('commentsList');
  const commentCountValue = document.getElementById('commentCountValue');

  if (!commentsList || !commentCountValue) {
    console.error("‚ùå Error: Contenedor de comentarios o contador no encontrado en el DOM");
    return;
  }

  // ‚úÖ Asegurar que el badge sea visible y limpiar estado de carga
  commentCountValue.style.display = 'flex';
  delete commentCountValue.dataset.loading;

  // --- Guardar el texto y correo del comentario swiped actual ---
  let swipedData = null;
  const swipedComment = document.querySelector('li.swiped');
  if (swipedComment) {
    swipedData = {
      texto: swipedComment.dataset.texto,
      correo: swipedComment.dataset.correo
    };
  }

  commentsList.innerHTML = '';

  // üî• FIX2: Reforzado para siempre mostrar mensaje si length === 0 exacto
  if (lista.length === 0) {
    commentsList.innerHTML = '<li>S√© el primero en comentar...</li>';
    commentCountValue.textContent = "0";
  } else {
    // üî• FIX13: Invertir el orden de los comentarios para que el m√°s reciente est√© arriba
    const comentariosInvertidos = [...lista].reverse();
    comentariosInvertidos.forEach(c => {
      const li = document.createElement('li');
      li.classList.add('deletable');

      const commentContent = document.createElement('div');
      commentContent.className = 'comment-content';
      commentContent.textContent = `${c.autor} (${c.fecha}) - ${c.comentario}`;
      li.appendChild(commentContent);

      li.dataset.correo = c.correo;
      li.dataset.texto = c.comentario;

      if (normalizeText(c.correo) === normalizeText(currentAuthorEmail)) {
        const deleteBtnContainer = document.createElement('div');
        deleteBtnContainer.className = 'delete-btn-container';
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Borrar';
        deleteBtnContainer.appendChild(deleteBtn);
        li.appendChild(deleteBtnContainer);

        deleteBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          await eliminarComentario(videoId, c.comentario, c.correo);
          renderComentarios(videoId);
        });
      }

      // --- Si este es el comentario swiped, restaura el swipe ---
      if (
        swipedData &&
        normalizeText(c.correo) === normalizeText(swipedData.correo) &&
        c.comentario === swipedData.texto
      ) {
        li.classList.add('swiped');
        commentContent.classList.add('swiped');
        commentContent.style.transform = `translateX(100px)`;
        const deleteBtnContainer = li.querySelector('.delete-btn-container');
        if (deleteBtnContainer) {
          deleteBtnContainer.classList.add('visible');
          deleteBtnContainer.style.transform = `translateX(0)`;
        }
      }

      commentsList.appendChild(li);
    });

    commentCountValue.textContent = lista.length;
  }

  console.log(`‚úÖ Renderizados ${lista.length} comentarios para video ${videoId} en orden inverso`);
    if (window.restoreSwipeAfterRender) window.restoreSwipeAfterRender();
}

// === Enviar un nuevo comentario ===
async function enviarComentario() {
  const texto = commentInput.value.trim();
  const videoId = getActiveVideoId();
  if (!texto || !videoId) return;

  sendCommentBtn.disabled = true;

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams({
        accion: "agregarComentarioVideo",
        videoId,
        comentario: texto,
        autor: currentAuthorName ,
        correo: currentAuthorEmail,
      })
    });
    const data = await res.json();

    if (data.status === "success") {
      commentInput.value = "";
      // üîÑ Forzar recarga real desde servidor
      await cargarComentarios(videoId, true, { force: true });

      // ‚úÖ Actualizar timestamp local y notificar a otros dispositivos
      ultimaActualizacionComentarios = String(Date.now());
      // üöÄ Notificar a otros dispositivos
      notificarCambioComentarios();
    } else {
      console.error("‚ùå No se pudo guardar:", data.message);
    }
  } catch (e) {
    console.error("Error al enviar comentario:", e);
  } finally {
    sendCommentBtn.disabled = false;
  }
}


// === Listeners del input ===
sendCommentBtn.addEventListener('click', enviarComentario);

commentInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') enviarComentario();
});

// ‚úÖ Detectar iOS (incluye iPadOS)
const isIOS = (() => {
  const ua = navigator.userAgent || "";
  const iOSUA = /iPad|iPhone|iPod/.test(ua);
  const iPadOS = navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1;
  return iOSUA || iPadOS;
})();

let iosScrollYBeforeFocus = 0;

// L√≥gica teclado/comentarios
commentInput.addEventListener("focus", () => {
  if (isIOS) {
    // ‚úÖ iOS: dejamos que Safari haga el scroll natural
    iosScrollYBeforeFocus = window.scrollY || 0;
    return;
  }

});

commentInput.addEventListener("blur", () => {
  

  if (isIOS) {
    // ‚úÖ iOS: fuerza volver al scroll anterior (Safari a veces no ‚Äúbaja‚Äù solo)
    setTimeout(() => {
      window.scrollTo(0, iosScrollYBeforeFocus);
    }, 50);
  }
});



// === Precargar todos los comentarios al inicio ===
async function precargarComentariosTodos(videos) {
  for (const v of videos) {
    // ‚ö° Carga los comentarios pero NO renderiza si no es el video activo
    await cargarComentarios(v.id, false);
  }
  console.log("‚úÖ Todos los comentarios precargados en cach√©");
}

// === Eliminar comentario ===
async function eliminarComentario(videoId, comentario, correo) {
  if (!videoId || !comentario || !correo) return;

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams({
        accion: "eliminarComentario",
        videoId,
        comentario,
        correo
      })
    });
    const data = await res.json();

    if (data.status === "success") {
      // üîÑ Forzar recarga real desde servidor
      await cargarComentarios(videoId, true, { force: true });

      // ‚úÖ Actualizar timestamp local y notificar a otros dispositivos
      ultimaActualizacionComentarios = String(Date.now());
      // üöÄ Notificar a otros dispositivos
      notificarCambioComentarios();
    } else {
      console.error("‚ùå No se elimin√≥:", data.message);
    }
  } catch (e) {
    console.error("Error al eliminar comentario:", e);
  }
}


// === üîÑ Sincronizaci√≥n de comentarios en tiempo casi real ===
let ultimaActualizacionComentarios = "";

// Inicializa el timestamp al cargar (evita primer ‚Äúfalse positive‚Äù)
async function initSyncComentarios() {
  try {
    const res = await fetch(`${SCRIPT_URL}?accion=ultimaActualizacionComentarios&_=${Date.now()}`);
    const data = await res.json();
    ultimaActualizacionComentarios = data.timestamp || "";
  } catch (e) {
    console.warn("No se pudo inicializar sync de comentarios:", e);
  }
}
document.addEventListener('DOMContentLoaded', initSyncComentarios);

// Verifica en el servidor si hubo cambios (con cache-buster)
async function verificarComentariosVideos() {
  try {
    const res = await fetch(`${SCRIPT_URL}?accion=ultimaActualizacionComentarios&_=${Date.now()}`);
    const data = await res.json();

    if (data.timestamp && data.timestamp !== ultimaActualizacionComentarios) {
      ultimaActualizacionComentarios = data.timestamp;

      // üî• FIX2: Usar lastVideos para obtener TODOS los videoIds conocidos y recargarlos (sin render, background)
      const videoIds = lastVideos.map(v => v.id);
      for (const videoId of videoIds) {
        await cargarComentarios(videoId, false, { force: true }); // No render, solo cach√© fresco
      }

      // Luego, render solo para el activo (con datos frescos)
      const videoIdActivo = getActiveVideoId();
      if (videoIdActivo) {
        renderComentarios(videoIdActivo);
      }
    }
  } catch (err) {
    console.warn("No se pudo verificar comentarios:", err);
  }
}




// Cada 5 segundos verificamos si hubo cambios
setInterval(verificarComentariosVideos, 5000);


// === ‚ù§Ô∏è Sincronizaci√≥n de likes en tiempo casi real ===
let ultimaActualizacionLikesVideos = "";

// Inicializa el timestamp al cargar (evita primer ‚Äúfalse positive‚Äù)
async function initSyncLikesVideos() {
  try {
    const res = await fetch(`${SCRIPT_URL}?accion=ultimaActualizacionLikesVideos&_=${Date.now()}`);
    const data = await res.json();
    ultimaActualizacionLikesVideos = data.timestamp || "";
  } catch (e) {
    console.warn("No se pudo inicializar sync de likes:", e);
  }
}
document.addEventListener('DOMContentLoaded', initSyncLikesVideos);

// Verifica en el servidor si hubo cambios (con cache-buster)
async function verificarLikesVideos() {
  try {
    const res = await fetch(`${SCRIPT_URL}?accion=ultimaActualizacionLikesVideos&_=${Date.now()}`);
    const data = await res.json();

    if (data.timestamp && data.timestamp !== ultimaActualizacionLikesVideos) {
      ultimaActualizacionLikesVideos = data.timestamp;

      // üî• Recargar likes del video activo (FORZADO, saltando cach√©)
      const videoIdActivo = getActiveVideoId();
      if (videoIdActivo) {
        await cargarLikes(videoIdActivo, { force: true });
      }
    }
  } catch (err) {
    console.warn("No se pudo verificar likes:", err);
  }
}

// Cada 2 segundos verificamos si hubo cambios (ajusta a tu gusto)
setInterval(verificarLikesVideos, 2000);

// Hook: disparar verificaci√≥n inmediata tras dar like/unlike en ESTE dispositivo
function notificarCambioLikesVideos() {
  setTimeout(verificarLikesVideos, 0);
}


// --- HOOK para disparar verificaci√≥n inmediata tras alta/baja ---
function notificarCambioComentarios() {
  // üî• FIX2: Peque√±o delay para asegurar que el servidor actualice el timestamp antes del chequeo
  setTimeout(verificarComentariosVideos, 0);
}






// === Cargar comentarios en tiempo real ===
function iniciarComentariosTiempoReal() {
  if (comentariosInterval) clearInterval(comentariosInterval);

  const videoId = getActiveVideoId();
  if (!videoId) return;

  cargarComentarios(videoId);

  comentariosInterval = setInterval(() => {
    const idActual = getActiveVideoId();
    if (idActual) cargarComentarios(idActual);
  }, 3000);
}

// === Utilidad para normalizar texto/correos ===
function normalizeText(text) {
  return (text || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
}



        
// === NOTIFICACIONES ===
let notifications = [];
let lastVideos = [];

function renderNotifications() {
  const list = document.getElementById("notification-list");
  const count = document.getElementById("notification-count");
  const notificationBtn = document.getElementById("notification-btn");
  const bellIcon = notificationBtn.querySelector("i"); // Seleccionar el elemento <i> de la campana

  if (!list || !count || !notificationBtn || !bellIcon) {
    console.error("‚ùå Error: Elementos de notificaciones no encontrados en el DOM");
    return;
  }

  list.innerHTML = "";

  if (notifications.length === 0) {
    list.innerHTML = "<div>Sin notificaciones</div>";
    count.textContent = "";
    count.style.display = "none";
    bellIcon.className = "far fa-bell"; // Campana vac√≠a cuando no hay notificaciones

    try {
      if (typeof AppInventor !== "undefined" && AppInventor.setWebViewString) {
        AppInventor.setWebViewString("0");
      }
    } catch (e) {
      console.warn("No se pudo enviar a App Inventor:", e);
    }
    return;
  }

  count.textContent = notifications.length;
  count.style.display = "block";
  bellIcon.className = "fas fa-bell"; // Campana rellena cuando hay notificaciones

  notifications.forEach((notif, i) => {
    if (!notif || !notif.link || !notif.title || !notif.id) {
      console.warn("‚ö†Ô∏è Notificaci√≥n inv√°lida detectada:", notif);
      return;
    }

    const item = document.createElement("div");
    item.textContent = notif.title;
    item.style.cursor = "pointer";
    item.style.padding = "10px";
    item.style.userSelect = "none";

    item.onclick = () => {
      console.log("üîπ Click en notificaci√≥n detectado:", notif.title, "ID:", notif.id);

      // Marcar como le√≠da y cerrar panel INMEDIATAMENTE
      notifications.splice(i, 1);
      renderNotifications();
      document.getElementById("notification-list").classList.add("hidden");
      console.log("‚úÖ Notificaci√≥n marcada como le√≠da y panel cerrado");

      const wrapper = document.getElementById("slides");
      if (!wrapper || !swiper) {
        console.error("‚ùå Error: Contenedor de slides o Swiper no encontrado");
        return;
      }

      // Guardar y precargar comentarios del video actual
      const currentVideoId = getActiveVideoId();
      if (currentVideoId && !comentariosPorVideo[currentVideoId]) {
        cargarComentarios(currentVideoId, false, { force: true }).catch(e => console.warn("Error precargando comentarios actuales:", e));
        console.log(`‚úÖ Precargando comentarios para video actual ${currentVideoId}`);
      }

      // Buscar si ya existe el slide usando videoId
      let slide = Array.from(wrapper.children).find(s => s.dataset.videoid === notif.id);
      let isNewSlide = !slide;
      let targetIndex = -1;

      if (isNewSlide) {
        // Desactivar loop temporalmente si hay pocos slides para evitar bugs
        const originalLoop = swiper.params.loop;
        if (swiper.slides.length < 3) {
          swiper.params.loop = false;
          swiper.update();
          console.log("üîπ Loop desactivado temporalmente (pocos slides)");
        }

      const nuevoSlide = createSlide(
  notif.title,
  notif.link,
  notif.desc,
  notif.id,
  notif.autor || "",
  notif.correo || ""
);

swiper.appendSlide(nuevoSlide);
swiper.update(); // Actualizar estructura
swiper.loopFix(); // Reparar clones y loop mode
console.log("‚úÖ Nuevo slide a√±adido, loopFix aplicado, ID:", notif.id);


        // Reactivar loop si se desactiv√≥
        if (swiper.slides.length < 3 && originalLoop) {
          swiper.params.loop = true;
          swiper.update();
          swiper.loopFix();
          console.log("üîπ Loop reactivado");
        }

        targetIndex = swiper.slides.length - 1;
        lastVideos.push({ title: notif.title, link: notif.link, desc: notif.desc, id: notif.id });
        cargarComentarios(notif.id, false, { force: true }).catch(e => console.warn("Error precargando comentarios del nuevo video:", e));
      } else {
        // Para slide existente, usar m√©todo de Swiper para √≠ndice real en loop
        targetIndex = swiper.getSlideIndexByData('videoid', notif.id);
        if (targetIndex === undefined) {
          // Fallback manual
          swiper.slides.forEach((s, idx) => {
            if (s.dataset.videoid === notif.id) targetIndex = idx;
          });
        }
        console.log(`‚úÖ Slide existente encontrado en √≠ndice: ${targetIndex}, ID: ${notif.id}`);
      }

      if (targetIndex !== -1) {
        console.log(`üîπ Iniciando navegaci√≥n a √≠ndice ${targetIndex} con slideToLoop`);
        setTimeout(() => {
          cleanupIframesExceptActiveAndAdjacent(); // Limpiar despu√©s de adici√≥n
          swiper.slideToLoop(targetIndex, 500); // Transici√≥n m√°s lenta para WebView
          updateFixedTitle(swiper);

          // Montaje del video con delay adicional
          setTimeout(() => {
            const activeCard = swiper.slides[swiper.activeIndex]?.querySelector('.player-card');
            if (activeCard) {
              const src = activeCard.dataset.embed;
              if (!activeCard.querySelector("iframe") && !activeCard.querySelector("video")) {
                mountIframe(activeCard, true);
                console.log("‚úÖ Video montado y reproducido");
              } else {
                const player = players[src];
                if (player) {
                  if (typeof player.playVideo === 'function') {
                    player.playVideo();
                  } else if (typeof player.play === 'function') {
                    player.play().catch(e => console.warn("Error al reproducir:", e));
                  }
                  console.log("üîπ Video existente reproducido");
                }
              }
            }

            const videoId = getActiveVideoId();
            if (videoId) {
              if (!comentariosPorVideo[videoId] || comentariosPorVideo[videoId].length === 0) {
                cargarComentarios(videoId, true, { force: true }).catch(e => console.warn("Error cargando comentarios:", e));
              } else {
                renderComentarios(videoId);
              }
              console.log(`‚úÖ Comentarios manejados para video ${videoId}`);
            }
          }, 300);
        }, 500); // Retraso inicial mayor para WebView

        // Listener para fin de transici√≥n
        swiper.once('slideChangeTransitionEnd', () => {
          console.log("‚úÖ Transici√≥n completada, √≠ndice activo:", swiper.activeIndex);
          swiper.loopFix(); // Reparar loop nuevamente si es necesario
          cleanupIframesExceptActiveAndAdjacent();
          const activeCard = document.querySelector('.swiper-slide-active .player-card');
          if (activeCard && !activeCard.querySelector("iframe") && !activeCard.querySelector("video")) {
            mountIframe(activeCard, true);
            console.log("‚úÖ Video montado tras transici√≥n");
          }
          const videoIdFinal = getActiveVideoId();
          if (videoIdFinal) {
            if (!comentariosPorVideo[videoIdFinal] || comentariosPorVideo[videoIdFinal].length === 0) {
              cargarComentarios(videoIdFinal, true, { force: true }).catch(e => console.warn("Error en comentarios finales:", e));
            } else {
              renderComentarios(videoIdFinal);
            }
          }
          if (currentVideoId && comentariosPorVideo[currentVideoId]) {
            console.log(`‚úÖ Restaurando comentarios para video original ${currentVideoId}`);
            renderComentarios(currentVideoId);
          }
        });
      } else {
        console.error("‚ùå Error: √çndice no v√°lido para video, ID:", notif.id);
      }
    };

    list.appendChild(item);
  });

  try {
    if (typeof AppInventor !== "undefined" && AppInventor.setWebViewString) {
      AppInventor.setWebViewString(String(notifications.length));
    }
  } catch (e) {
    console.warn("No se pudo enviar a App Inventor:", e);
  }
}
// --- BOT√ìN NOTIFICACIONES UNIVERSAL ---
const notifBtn = document.getElementById("notification-btn");
const notifList = document.getElementById("notification-list");

// Mostrar/ocultar la lista al tocar el bot√≥n (desktop y m√≥vil)
notifBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  notifList.classList.toggle("hidden");
});

        
// Ocultar la lista al hacer clic fuera
document.addEventListener("click", (e) => {
  if (!notifList.classList.contains("hidden")) {
    if (!notifList.contains(e.target) && e.target !== notifBtn) {
      notifList.classList.add("hidden");
    }
  }
});

// --- MANEJO DE ELIMINACI√ìN ---

// Variables para almacenar los datos del usuario
let currentAuthorName  = "";
let currentAuthorEmail = "";

// Funci√≥n para obtener los datos de usuario de la URL o localStorage
function getUsuarioDataFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const nameFromUrl = params.get("name");
    const emailFromUrl = params.get("email");

    if (nameFromUrl && emailFromUrl) {
        currentAuthorName  = nameFromUrl;
        currentAuthorEmail = emailFromUrl;
    } else {
        // Intentar obtener del localStorage
        const usuario = JSON.parse(localStorage.getItem("usuario"));
        if (usuario) {
            currentAuthorName  = usuario.nombre || "";
            currentAuthorEmail = usuario.correo || "";
        }
    }
}

// Llamar a la funci√≥n al cargar la p√°gina
document.addEventListener("DOMContentLoaded", getUsuarioDataFromUrl);


// NUEVO: Variables para el modal de alerta personalizada
const customAlertModal = document.getElementById("custom-alert-modal");
const customAlertMessage = document.getElementById("custom-alert-message");
const customAlertOk = document.getElementById("custom-alert-ok");

// NUEVO: Funci√≥n para mostrar el modal de alerta personalizado
function showAlert(message, title = "¬°Atenci√≥n!") {
    customAlertMessage.textContent = message;
    customAlertModal.querySelector('h3').textContent = title;
    customAlertModal.classList.remove("hidden");
}

// NUEVO: Ocultar el modal de alerta cuando se hace clic en "Aceptar"
customAlertOk.onclick = () => {
    customAlertModal.classList.add("hidden");
};

const btnDelete = document.getElementById("btn-delete");
const deleteModal = document.getElementById("delete-modal");
const deleteTitle = document.getElementById("delete-video-title");
const deleteConfirm = document.getElementById("delete-confirm");
const deleteCancel = document.getElementById("delete-cancel");

let pendingDelete = null;

btnDelete.onclick = () => { 
    if (!swiper) return;
    const activeSlide = document.querySelector(".swiper-slide-active");
    if (!activeSlide) return;

    const title = activeSlide.dataset.title;
    const link = activeSlide.querySelector(".player-card")?.dataset.embed;

    // Si no hay datos de usuario, notificar y salir
    if (!currentAuthorName || !currentAuthorEmail) {
        showAlert("No se pudo obtener la informaci√≥n de tu cuenta. Intenta recargar la p√°gina.");
        return;
    }

    pendingDelete = { title, link };
    deleteTitle.textContent = `¬øEliminar "${title}"?`;
    deleteModal.classList.remove("hidden");
};

deleteCancel.onclick = () => {
    deleteModal.classList.add("hidden");
    pendingDelete = null;
};

deleteConfirm.onclick = async () => {
    if (!pendingDelete) return;
    const { title, link } = pendingDelete;

    deleteModal.classList.add("hidden");
    pendingDelete = null;

    let identifier = "";
    let fileName = "";
    const archiveMatch = link.match(/archive\.org\/download\/([^/]+)\/(.+)$/);
    if (archiveMatch) {
        identifier = archiveMatch[1];
        fileName = decodeURIComponent(archiveMatch[2]);
    }

    const deleteUrl = `${SCRIPT_URL}?accion=eliminar&link=${encodeURIComponent(link)}&id=${encodeURIComponent(identifier)}&file=${encodeURIComponent(fileName)}&autor=${encodeURIComponent(currentAuthorName)}&correo=${encodeURIComponent(currentAuthorEmail)}`;

    try {
        const response = await fetch(deleteUrl);
        const data = await response.json();

        if (data.status === "success") {
  // ‚úÖ 1) Guardar el "realIndex" antes de tocar nada
const prevRealIndex = swiper.realIndex;

// ‚úÖ 1.1) Pausar y limpiar el player del video que vas a borrar (evita estados raros)
try {
  const p = players?.[link];
  if (p) {
    if (typeof p.pauseVideo === "function") p.pauseVideo();
    else if (typeof p.pause === "function") p.pause();
    delete players[link];
  }
} catch(e) {}

// ‚úÖ 2) En loop, primero quitar clones para no borrar un clon por error
const wasLoop = !!swiper.params.loop;
if (wasLoop) {
  swiper.loopDestroy(); // quita clones y deja solo slides reales
  swiper.update();
}

// ‚úÖ 3) Eliminar el slide REAL usando API (NO remove() manual)
swiper.removeSlide(prevRealIndex);

// ‚úÖ 4) Re-crear loop y recalcular todo
swiper.update();
if (wasLoop) {
  swiper.loopCreate();
  swiper.update();
  swiper.loopFix(); // repara offsets del loop
}

// ‚úÖ 5) Mantener posici√≥n estable
if (swiper.slides.length > 0) {
  const safeReal = Math.min(prevRealIndex, swiper.slides.length - 1);
  swiper.slideToLoop(safeReal, 0);
}



            // ‚úÖ 6) Limpiar buscador (evita resultados viejos/√≠ndices viejos)
            if (typeof searchResults !== "undefined" && searchResults) searchResults.innerHTML = "";
            if (typeof searchInput !== "undefined" && searchInput) searchInput.value = "";

            showAlert("‚úÖ Video eliminado con √©xito.", "¬°Listo!");
        } else {
            showAlert("‚ùå Error al eliminar: " + (data.message || ""), "Error");
        }
    } catch (err) {
        showAlert("‚ö†Ô∏è Error de conexi√≥n al intentar eliminar.", "Error");
    }
};





        
        let swiper = null;
        let players = {};

        function getEmbedInfo(link) {
            const url = new URL(link, location.href);
            if (url.hostname.includes("youtube.com") || url.hostname.includes("youtu.be")) {
                let videoId = "";
                if (url.hostname.includes("youtube.com")) {
                    videoId = url.searchParams.get("v") || "";
                } else if (url.hostname.includes("youtu.be")) {
                    videoId = url.pathname.replace("/", "");
                }
                if (videoId) {
                    const embedSrc = `https://www.youtube.com/embed/${videoId}?rel=0&playsinline=1&controls=0&modestbranding=1`;
                    const poster = "https://img.youtube.com/vi/" + videoId + "/hqdefault.jpg";
                    return { type: "youtube", embedSrc, poster, videoId };
                }
            }
            if (url.hostname.includes("archive.org")) {
                let identifier = "";
                const m = link.match(/archive\.org\/(?:embed|details|download)\/([^?&#/]+)/i);
                if (m && m[1]) {
                    identifier = m[1];
                }
                const poster = identifier ? `https://archive.org/services/img/${identifier}` : "";
                return { type: "mp4", embedSrc: link, poster: poster };
            }
            if (url.pathname.endsWith(".mp4")) {
                 return { type: "mp4", embedSrc: link, poster: "" };
            }
            return { type: "other", embedSrc: link, poster: "" };
        }

function createSlide(titulo, link, descripcion, id, autor = "", correo = "") {  
    const { embedSrc, poster } = getEmbedInfo(link);
    const slide = document.createElement("div");
    slide.className = "swiper-slide";

    // ‚úÖ Guardar en ambos nombres (compatibilidad con funciones viejas)
    slide.dataset.title = titulo || "Video";
    slide.dataset.titulo = titulo || "Video";              // ‚úÖ NUEVO (ES)
    
    slide.dataset.descripcion = descripcion || "";
    slide.dataset.desc = descripcion || "";                // ‚úÖ NUEVO (por si lees "desc")

    slide.dataset.videoid = id || "";                      // ID √∫nico
    slide.dataset.autor = autor || "";
    slide.dataset.correo = correo || "";

    const card = document.createElement("div");
    card.className = "player-card";
    card.dataset.embed = embedSrc;

    const posterEl = document.createElement("div");
    posterEl.className = "poster";
    if (poster) posterEl.style.backgroundImage = `url("${poster}")`;

    const playBtn = document.createElement("div");
    playBtn.className = "play-btn";
    playBtn.innerHTML = '<i class="fas fa-play"></i>';
    posterEl.appendChild(playBtn);

    posterEl.addEventListener("click", () => {
        mountIframe(card, true);
    });

    card.appendChild(posterEl);
    slide.appendChild(card);

    return slide;
}




  function mountIframe(cardEl, autoplay = true) {
  // üî• Antes de montar, desmonta todo lo dem√°s
  cleanupIframesExceptActiveAndAdjacent();

  if (cardEl.querySelector("iframe") || cardEl.querySelector("video")) return;

  const src = cardEl.dataset.embed;
  const info = getEmbedInfo(src);

  const poster = cardEl.querySelector(".poster");
  if (poster) poster.remove();
  
  const controls = createControls();
  cardEl.appendChild(controls);

  const centerPlayPauseBtn = document.createElement("div");
  centerPlayPauseBtn.className = "center-play-pause-btn";

  // ‚úÖ Si NO hay autoplay, mostrar PLAY al inicio (no PAUSE)
  centerPlayPauseBtn.innerHTML = autoplay
    ? '<i class="fas fa-pause"></i>'
    : '<i class="fas fa-play"></i>';
  centerPlayPauseBtn.style.opacity = 1;

  cardEl.appendChild(centerPlayPauseBtn);
  
  let player;

  if (info.type === "youtube") {
    const container = document.createElement("div");
    container.className = "player-iframe";
    cardEl.appendChild(container);

    player = new YT.Player(container, {
      videoId: info.videoId,
      playerVars: { autoplay: autoplay ? 1 : 0, rel: 0, playsinline: 1, controls: 0, modestbranding: 1 },
      events: {
        onReady: (event) => {
          if (autoplay) event.target.playVideo();
          setupControls(event.target, 'youtube', controls, centerPlayPauseBtn, cardEl);

          // ‚úÖ Forzar √≠cono correcto cuando arranca pausado
          if (!autoplay) {
            centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            centerPlayPauseBtn.style.opacity = 1;
          }
        },
        onStateChange: (event) => {
          const state = event.data;
          if (state === YT.PlayerState.PLAYING) {
            centerPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            centerPlayPauseBtn.style.opacity = 0;
          } else if (state === YT.PlayerState.PAUSED) {
            centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            centerPlayPauseBtn.style.opacity = 1;
          } else {
            centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            centerPlayPauseBtn.style.opacity = 1;
          }
        }
      }
    });

    players[src] = player;

  } else if (info.type === "mp4") {
    const video = document.createElement("video");
    video.className = "player-iframe";
    if (autoplay) video.setAttribute("autoplay", "true");
    video.setAttribute("playsinline", "true");
    video.style.width = "100%";
    video.style.height = "100%";
    video.style.background = "#000";

    const source = document.createElement("source");
    source.src = src;
    source.type = "video/mp4";
    video.appendChild(source);
    cardEl.appendChild(video);

    player = video;
    players[src] = player;

    video.addEventListener('loadedmetadata', () => {
      setupControls(video, 'mp4', controls, centerPlayPauseBtn, cardEl);

      // ‚úÖ Si se pidi√≥ sin autoplay, asegurar pausa real
      if (!autoplay) {
        try { video.pause(); } catch (e) {}
        centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        centerPlayPauseBtn.style.opacity = 1;
      }
    });

    video.addEventListener('play', () => {
      centerPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      centerPlayPauseBtn.style.opacity = 0;
    });
    video.addEventListener('pause', () => {
      centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      centerPlayPauseBtn.style.opacity = 1;
    });
    video.addEventListener('ended', () => {
      centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      centerPlayPauseBtn.style.opacity = 1;
    });

  } else {
    const iframe = document.createElement("iframe");
    iframe.className = "player-iframe";
    iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share");
    iframe.setAttribute("allowfullscreen", "true");
    iframe.src = src + (src.includes("?") ? "&" : "?") + (autoplay ? "autoplay=1" : "");
    cardEl.appendChild(iframe);

    // ‚úÖ Si es iframe gen√©rico y no autoplay, mantener icono en play
    if (!autoplay) {
      centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      centerPlayPauseBtn.style.opacity = 1;
    }
  }
}


        
        function createControls() {
            const controlsBar = document.createElement("div");
            controlsBar.className = "controls-bar";

            const playPauseBtn = document.createElement("button");
            playPauseBtn.className = "play-pause-btn";
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';

            const progressBarContainer = document.createElement("div");
            progressBarContainer.className = "progress-bar";
            const progress = document.createElement("div");
            progress.className = "progress";
            progressBarContainer.appendChild(progress);

            const timeDisplay = document.createElement("div");
            timeDisplay.className = "time";
            timeDisplay.textContent = "00:00 / 00:00";

            const volumeControl = document.createElement("div");
            volumeControl.className = "volume-control";
            const volumeIcon = document.createElement("span");
            volumeIcon.className = "volume-icon";
            volumeIcon.innerHTML = '<i class="fas fa-volume-up"></i>';
            const volumeSlider = document.createElement("input");
            volumeSlider.type = "range";
            volumeSlider.min = "0";
            volumeSlider.max = "1";
            volumeSlider.step = "0.01";
            volumeSlider.value = "1";
            volumeControl.appendChild(volumeIcon);
            volumeControl.appendChild(volumeSlider);

            controlsBar.appendChild(playPauseBtn);
            controlsBar.appendChild(progressBarContainer);
            controlsBar.appendChild(timeDisplay);
            controlsBar.appendChild(volumeControl);

            return controlsBar;
        }

function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s]
                .filter(v => v > 0 || v === 0)
                .map(v => v.toString().padStart(2, '0'))
                .join(':')
                .replace(/^00:/, '');
        }

        function setupControls(player, type, controls, centerPlayPauseBtn, cardEl) {
            const playPauseBtn = controls.querySelector('.play-pause-btn');
            const progressBarContainer = controls.querySelector('.progress-bar');
            const progress = controls.querySelector('.progress');
            const volumeSlider = controls.querySelector('.volume-control input');
            const timeDisplay = controls.querySelector('.time');
            let totalTime = 0;
            let timeoutId;
            
            const hideControls = () => {
                controls.style.opacity = 0;
                if (type === 'youtube' && player.getPlayerState() === YT.PlayerState.PLAYING) {
                    centerPlayPauseBtn.style.opacity = 0;
                } else if (type === 'mp4' && !player.paused) {
                    centerPlayPauseBtn.style.opacity = 0;
                }
            };
            
            const showControls = () => {
                clearTimeout(timeoutId);
                controls.style.opacity = 1;
                centerPlayPauseBtn.style.opacity = 1;
                timeoutId = setTimeout(hideControls, 1000);
            };

            const updateTime = () => {
                let currentTime = 0;
                if (type === 'youtube') {
                    currentTime = player.getCurrentTime();
                } else {
                    currentTime = player.currentTime;
                }
                const progressPercentage = (currentTime / totalTime) * 100;
                progress.style.width = `${progressPercentage}%`;
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(totalTime)}`;
            };

            const interval = setInterval(updateTime, 1000);

            cardEl.addEventListener('mouseenter', showControls);
            cardEl.addEventListener('mouseleave', hideControls);
            cardEl.addEventListener('mousemove', showControls);
            
            if (type === 'youtube') {
                totalTime = player.getDuration();
                updateTime();
                playPauseBtn.onclick = () => {
                    const state = player.getPlayerState();
                    if (state === YT.PlayerState.PLAYING) {
                        player.pauseVideo();
                    } else {
                        player.playVideo();
                    }
                };
                centerPlayPauseBtn.onclick = playPauseBtn.onclick;

                progressBarContainer.onclick = (e) => {
                    const clickX = e.offsetX;
                    const totalWidth = progressBarContainer.clientWidth;
                    const newTime = (clickX / totalWidth) * totalTime;
                    player.seekTo(newTime, true);
                };
                volumeSlider.oninput = (e) => player.setVolume(e.target.value * 100);
            } else if (type === 'mp4') {
                totalTime = player.duration;
                updateTime();
                playPauseBtn.onclick = () => {
                    if (player.paused) {
                        player.play();
                    } else {
                        player.pause();
                    }
                };
                centerPlayPauseBtn.onclick = playPauseBtn.onclick;
                progressBarContainer.onclick = (e) => {
                    const clickX = e.offsetX;
                    const totalWidth = progressBarContainer.clientWidth;
                    const newTime = (clickX / totalWidth) * totalTime;
                    player.currentTime = newTime;
                };
                volumeSlider.oninput = (e) => player.volume = e.target.value;
                player.addEventListener('timeupdate', updateTime);
            }
        }

        function restorePoster(card) {
            const src = card.dataset.embed;
            const player = players[src];
            if (player) {
                if (typeof player.pauseVideo === 'function') {
                    player.pauseVideo();
                } else if (typeof player.pause === 'function') {
                    player.pause();
                }
            }

            const playerContainer = card.querySelector(".player-iframe");
            if (playerContainer) playerContainer.remove();

            const controlsBar = card.querySelector(".controls-bar");
            if (controlsBar) controlsBar.remove();
            
            const centerBtn = card.querySelector(".center-play-pause-btn");
            if (centerBtn) centerBtn.remove();

            if (!card.querySelector(".poster")) {
                const info = getEmbedInfo(src);
                const posterEl = document.createElement("div");
                posterEl.className = "poster";
                if (info.poster) {
                    posterEl.style.backgroundImage = `url("${info.poster}")`;
                }
                const playBtn = document.createElement("div");
                playBtn.className = "play-btn";
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                posterEl.appendChild(playBtn);
                posterEl.addEventListener("click", () => mountIframe(card, true));
                card.appendChild(posterEl);
            }
        }

        // --- INICIO DE LA CORRECCI√ìN ---
function cleanupIframesExceptActiveAndAdjacent() {
    if (!swiper) return;

    const activeIndex = swiper.activeIndex;
    const prevIndex = (activeIndex - 1 + swiper.slides.length) % swiper.slides.length;
    const nextIndex = (activeIndex + 1) % swiper.slides.length;

    swiper.slides.forEach((slide, index) => {
        if (index !== activeIndex && index !== prevIndex && index !== nextIndex) {
            const card = slide.querySelector(".player-card");
            if (card) {
                const src = card.dataset.embed;
                const player = players[src];
                if (player) {
                    if (typeof player.pauseVideo === 'function') player.pauseVideo();
                    else if (typeof player.pause === 'function') player.pause();
                    delete players[src]; // Limpiar el reproductor de la memoria
                }
                restorePoster(card); // Restaurar el p√≥ster solo para slides no adyacentes
            }
        } else if (index !== activeIndex) {
            // Para prev y next, pausar si est√° reproduciendo, pero mantener el iframe/video
            const card = slide.querySelector(".player-card");
            if (card) {
                const src = card.dataset.embed;
                const player = players[src];
                if (player) {
                    if (typeof player.pauseVideo === 'function') player.pauseVideo();
                    else if (typeof player.pause === 'function') player.pause();
                    // Actualizar bot√≥n central para slides adyacentes
                    const centerPlayPauseBtn = card.querySelector('.center-play-pause-btn');
                    if (centerPlayPauseBtn) {
                        centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        centerPlayPauseBtn.style.opacity = 1;
                    }
                }
            }
        }
    });
}

        // --- FIN DE LA CORRECCI√ìN ---

   function updateFixedTitle(swiperInstance) {
    const fixedBox = document.getElementById("video-title-fixed");
    if (!fixedBox || !swiperInstance) return;

    const activeSlide = swiperInstance.slides[swiperInstance.activeIndex] || document.querySelector('.swiper-slide-active');
    if (!activeSlide) return;

    const newTitle = activeSlide.dataset.title || "Video";
    const newDesc = activeSlide.dataset.descripcion || "";

    const titleEl = fixedBox.querySelector(".video-title");
    const descEl = fixedBox.querySelector(".video-desc");

    const currentTitle = titleEl.querySelector('.text-container')?.textContent;
    const currentDesc = descEl.querySelector('.text-container')?.textContent;
    
    if (currentTitle === newTitle && currentDesc === newDesc) {
        return;
    }

    fixedBox.style.opacity = 0;

    setTimeout(() => {
        const setupExpandableText = (element, text, allowExpand = true) => {
            // ‚úÖ limpiar cualquier rastro previo (importante en la primera carga)
            element.innerHTML = "";
            
            const container = document.createElement("span");
            container.className = "text-container";
            container.textContent = text;
            element.appendChild(container);

            setTimeout(() => {
                if (!allowExpand) return; // üëà el t√≠tulo no se expande

                // crear copia para medir sin clamp
                const temp = container.cloneNode(true);
                temp.style.display = "inline-block";
                temp.style.webkitLineClamp = "unset";
                temp.style.maxHeight = "none";
                temp.style.visibility = "hidden";
                element.appendChild(temp);

                const needsClamp = temp.scrollHeight > container.clientHeight;
                temp.remove();

                if (needsClamp) {
                    // ‚úÖ asegurar que no se dupliquen botones
                    element.querySelectorAll(".toggle-text").forEach(btn => btn.remove());

                    const toggleButton = document.createElement("span");
                    toggleButton.className = "toggle-text";
                    toggleButton.textContent = "...m√°s";
                    element.appendChild(toggleButton);

                    const toggleExpand = () => {
                        const isExpanded = container.classList.contains("expanded");
                        if (isExpanded) {
                            container.classList.remove("expanded");
                            toggleButton.textContent = "...m√°s";
                        } else {
                            container.classList.add("expanded");
                            toggleButton.textContent = "mostrar menos";
                        }
                    };

                    // clic en el bot√≥n o en el contenedor
                    toggleButton.addEventListener("click", (e) => {
                        e.stopPropagation();
                        toggleExpand();
                    });
                    container.addEventListener("click", (e) => {
                        e.stopPropagation();
                        toggleExpand();
                    });
                }
            }, 50);
        };

        setupExpandableText(titleEl, newTitle, false); // üëà t√≠tulo siempre completo
        setupExpandableText(descEl, newDesc, true);   // üëà descripci√≥n expandible

        fixedBox.style.opacity = 1;
    }, 120);
}



        


async function cargarVideos(checkNew = false) {
  const loader = document.getElementById("loader");
  if (!loader) {
    console.error("‚ùå Error: Elemento loader no encontrado en el DOM");
    return;
  }
  if (!checkNew) loader.style.display = "flex";

  try {
    const res = await fetch(`${SCRIPT_URL}?accion=listar&tipo=videos`);
    const data = await res.json();

    const wrapper = document.getElementById("slides");
    if (!wrapper) {
      console.error("‚ùå Error: Contenedor de slides no encontrado");
      loader.style.display = "none";
      return;
    }
    if (!checkNew) wrapper.innerHTML = "";

let newVideos = [];
if (Array.isArray(data.data)) {
  data.data.forEach((row) => {
    const titulo = row[0];
    const link = row[1];
    const autor = row[2] || "";     // ‚úÖ NUEVO
    const correo = row[3] || "";    // ‚úÖ NUEVO
    const descripcion = row[4] || "";
    const id = row[5];

    if (titulo && link && id) { // üî• FIX8: Validar datos para evitar videos inv√°lidos
      newVideos.push({ title: titulo, link, desc: descripcion, id, autor, correo });
    }
  });
} else {
  console.warn("‚ö†Ô∏è Advertencia: No se recibieron datos v√°lidos de videos");
}


    // ‚ö° Precargamos primero los comentarios del PRIMER video
    if (!checkNew && newVideos.length > 0) {
      const primerVideoId = newVideos[0].id;
      await cargarComentarios(primerVideoId, true);
      console.log("‚úÖ Comentarios del primer video cargados");

      const videosRestantes = newVideos.slice(1);
      if (videosRestantes.length > 0) {
        Promise.all(videosRestantes.map(v => cargarComentarios(v.id, false)))
          .catch(e => console.warn("Error precargando comentarios:", e));
      }
    }

    // ‚ö° Mostramos los videos
    if (!checkNew) {
      newVideos.forEach(v => {
        wrapper.appendChild(createSlide(v.title, v.link, v.desc, v.id));
      });
    }

    // üî• FIX8: Eliminaci√≥n silenciosa sin afectar slide activo
if (checkNew) {
  const linksActivos = newVideos.map(v => v.link);
  const activeSlide = document.querySelector('.swiper-slide-active');

  Array.from(wrapper.children).forEach(slide => {
    const card = slide.querySelector(".player-card");
    if (card && !linksActivos.includes(card.dataset.embed)) {
      if (slide === activeSlide) {
        // üî• FIX8: Si el slide eliminado es el activo, pasar al siguiente slide
        if (swiper) {
          swiper.removeSlide(swiper.activeIndex);
          console.log("‚úÖ Slide activo eliminado, pasando al siguiente");
          swiper.slideNext(0); // Transici√≥n inmediata al siguiente slide
        }
      } else {
        // üî• FIX8: Eliminar solo slides no activos, sin actualizar Swiper inmediatamente
        wrapper.removeChild(slide);
        console.log("‚úÖ Slide no activo eliminado silenciosamente");
      }
    }
  });

  // ‚úÖ NUEVO: refrescar info de slides existentes (EDICIONES) sin reconstruir slides
  // Mapa por ID (m√°s estable que link)
  const mapById = new Map(newVideos.map(v => [String(v.id), v]));

  Array.from(wrapper.children).forEach(slide => {
    const id = String(slide.dataset.videoid || "");
    const v = mapById.get(id);
    if (!v) return;

    // Actualiza dataset (para overlay, permisos, bot√≥n editar, etc.)
    slide.dataset.title = v.title || "Video";
    slide.dataset.descripcion = v.desc || "";
    slide.dataset.autor = v.autor || "";
    slide.dataset.correo = v.correo || "";

    // Si tu UI usa updateFixedTitle() para el t√≠tulo superior, la llamamos despu√©s
  });

  // üî• FIX8: Actualizar Swiper solo despu√©s de todas las eliminaciones
if (swiper) {
  const prevReal = swiper.realIndex;

  swiper.update();

  // üî• CLAVE: reparar loop/clones para evitar "zoom/distorsi√≥n"
  if (swiper.params.loop) {
    swiper.loopFix();
  }

  // (opcional pero recomendado en m√≥viles/webview)
  swiper.updateSize();
  swiper.updateSlides();

  if (swiper.slides.length > 0) {
    swiper.slideToLoop(Math.min(prevReal, swiper.slides.length - 1), 0);
  }

  console.log("‚úÖ Swiper actualizado, loopFix aplicado y re-sincronizado");
}



  // ‚úÖ Si hay t√≠tulo fijo/overlay, refrescarlo (no rompe nada si existe)
  if (typeof updateFixedTitle === "function") updateFixedTitle();

  // ‚úÖ Si tienes l√≥gica de mostrar/ocultar botones por due√±o, refresca aqu√≠ si existe
  if (typeof updateVideoOwnerButtons === "function") updateVideoOwnerButtons();
}


    // üõéÔ∏è Notificaciones de nuevos videos
    if (checkNew && lastVideos.length > 0) { 
      const nuevos = newVideos.filter(v => !lastVideos.find(old => old.link === v.link));
      if (nuevos.length > 0) {
        // üî• FIX8: Filtrar notificaciones vac√≠as/inv√°lidas antes de a√±adir
        const validNuevos = nuevos.filter(v => v.title && v.link && v.id);
        if (validNuevos.length > 0) {
// opci√≥n 2
notifications = validNuevos.concat(notifications);
          renderNotifications();
          console.log(`‚úÖ ${validNuevos.length} nuevas notificaciones v√°lidas a√±adidas`);
        } else {
          console.warn("‚ö†Ô∏è No se a√±adieron notificaciones: datos inv√°lidos");
        }
      }
    }

    lastVideos = newVideos;

    // ‚úÖ Inicializamos Swiper
  // Dentro de cargarVideos, reemplaza el bloque de inicializaci√≥n de Swiper con este:
// Reemplaza solo el bloque de inicializaci√≥n de Swiper dentro de cargarVideos
// Reemplaza solo el bloque de inicializaci√≥n de Swiper dentro de cargarVideos
if (!checkNew) {
    if (swiper) swiper.destroy(true, true);
    swiper = new Swiper(".swiper", {
        loop: true,
        direction: "vertical",
        slidesPerView: 1,
        spaceBetween: 10,
        pagination: false,
        on: {
      init() {
  updateFixedTitle(this);
  activarSwipeParaBorrar();
  const videoId = getActiveVideoId();
  if (videoId) {
    actualizarContadorComentariosUI(videoId, { loading: !comentariosPorVideo[videoId] && !comentariosCache[videoId] });
    renderComentarios(videoId);
  }
  if (videoId) cargarLikes(videoId);
  console.log("‚úÖ Swiper inicializado");

  // ‚úÖ Inicializar el primer video cargado pero PAUSADO (sin autoplay)
  const activeCard = this.slides[this.activeIndex].querySelector('.player-card');
  if (activeCard && !activeCard.querySelector("iframe") && !activeCard.querySelector("video")) {
    mountIframe(activeCard, false); // <-- antes true
  }
},

            slideChange() {
                cleanupIframesExceptActiveAndAdjacent();
                updateFixedTitle(this);
                activarSwipeParaBorrar();
                const videoId = getActiveVideoId();
                if (videoId) {
                    // ‚úÖ Contador instant√°neo (usa cach√© si existe)
                    actualizarContadorComentariosUI(videoId, { loading: !comentariosPorVideo[videoId] && !comentariosCache[videoId] });

                    cargarLikes(videoId);

                    // ‚úÖ Render r√°pido si ya hay datos, y en paralelo precarga/actualiza si falta
                    if (comentariosPorVideo[videoId] || comentariosCache[videoId]) {
                        // Asegura que memoria y cach√© est√©n alineadas
                        if (!comentariosPorVideo[videoId] && comentariosCache[videoId]) {
                          comentariosPorVideo[videoId] = comentariosCache[videoId];
                        }
                        renderComentarios(videoId);
                        // Opcional: refresco silencioso si deseas, pero SIN forzar.
                        // precargarComentarios(videoId);
                    } else {
                        // Cargar y renderizar cuando llegue, pero ya dejamos el contador en 0
                        cargarComentarios(videoId, true);
                    }
                }
            },
            slideChangeTransitionEnd() {
                updateFixedTitle(this);
                const activeIndex = this.activeIndex;
                const prevIndex = (activeIndex - 1 + this.slides.length) % this.slides.length;
                const nextIndex = (activeIndex + 1) % this.slides.length;

                // Manejar active
                const activeCard = this.slides[activeIndex].querySelector('.player-card');
                if (activeCard) {
                    const src = activeCard.dataset.embed;
                    if (!activeCard.querySelector("iframe") && !activeCard.querySelector("video")) {
                        mountIframe(activeCard, true); // Montar con reproducci√≥n autom√°tica
                    } else {
                        const player = players[src];
                        if (player) {
                            // Asegurar que el video activo se reproduzca
                            if (typeof player.playVideo === 'function') {
                                player.playVideo();
                            } else if (typeof player.play === 'function') {
                                player.play().catch(e => console.warn("Error al reproducir:", e));
                            }
                            // Actualizar estado del bot√≥n central
                            const centerPlayPauseBtn = activeCard.querySelector('.center-play-pause-btn');
                            if (centerPlayPauseBtn) {
                                centerPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                                centerPlayPauseBtn.style.opacity = 0;
                            }
                        }
                    }
                }

                // Precargar prev
                const prevCard = this.slides[prevIndex].querySelector('.player-card');
                if (prevCard && !prevCard.querySelector("iframe") && !prevCard.querySelector("video")) {
                    mountIframe(prevCard, false); // Precargar sin reproducir
                } else if (prevCard) {
                    const centerPlayPauseBtn = prevCard.querySelector('.center-play-pause-btn');
                    if (centerPlayPauseBtn) {
                        centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        centerPlayPauseBtn.style.opacity = 1;
                    }
                }

                // Precargar next
                const nextCard = this.slides[nextIndex].querySelector('.player-card');
                if (nextCard && !nextCard.querySelector("iframe") && !nextCard.querySelector("video")) {
                    mountIframe(nextCard, false); // Precargar sin reproducir
                } else if (nextCard) {
                    const centerPlayPauseBtn = nextCard.querySelector('.center-play-pause-btn');
                    if (centerPlayPauseBtn) {
                        centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        centerPlayPauseBtn.style.opacity = 1;
                    }
                }

                // ‚úÖ Precargar comentarios del prev/next para que el contador sea instant√°neo al deslizar
                const prevVideoId = this.slides[prevIndex]?.dataset?.videoid || null;
                const nextVideoId = this.slides[nextIndex]?.dataset?.videoid || null;
                precargarComentarios(prevVideoId);
                precargarComentarios(nextVideoId);

                const videoId = getActiveVideoId();
                if (videoId && comentariosPorVideo[videoId]) {
                    renderComentarios(videoId);
                }
            }
        },
    });

    cleanupIframesExceptActiveAndAdjacent();
    updateFixedTitle(swiper);
    activarSwipeParaBorrar();
    const videoId = getActiveVideoId();
    if (videoId) renderComentarios(videoId);
}
  } catch (e) {
    console.error("‚ùå Error cargando videos:", e);
  } finally {
    loader.style.display = "none";
  }
}



        const btnBuscar = document.getElementById("btnBuscar");
const searchModal = document.getElementById("search-modal");
const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");
const searchClose = document.getElementById("search-close");

// Abrir modal
btnBuscar.addEventListener("click", () => {
    searchModal.classList.remove("hidden");
    searchInput.value = "";
    searchResults.innerHTML = "";
    setTimeout(() => searchInput.focus(), 100);

      // RESALTAR BOT√ìN DE B√öSQUEDA AL ABRIR
  document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
  const btnBuscar = document.getElementById("btnBuscar");
  if (btnBuscar) btnBuscar.classList.add('selected');
});

// Cerrar modal
searchClose.addEventListener("click", () => {
    searchModal.classList.add("hidden");

       // === VOLVER A RESALTAR EL BOT√ìN DE IM√ÅGENES ===
        const videoBtn = document.getElementById("videoBtn");
        if (videoBtn) {
          document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
          videoBtn.classList.add('selected');
        }
});


function getVideosForSearch() {
  const wrapper = document.getElementById("slides");
  if (!wrapper) return [];

  const slides = Array.from(wrapper.children);

  // Si todav√≠a no hay slides renderizados, intenta con lastVideos
  if (slides.length === 0 && Array.isArray(lastVideos)) {
    return lastVideos.map((v, index) => ({
      title: (v?.title || v?.titulo || "").toString(),
      id: String(v?.id || ""),
      index
    }));
  }

  // Preferencia: DOM (es lo m√°s fiel a lo que el usuario ve)
return slides.map((slide, index) => ({
  title: (slide.dataset.title || slide.dataset.titulo || "").toString(),
  id: String(slide.dataset.videoid || ""),
  embed: String(slide.querySelector(".player-card")?.dataset.embed || ""),
  index
}));


}




// Cerrar al hacer clic fuera del contenido
searchModal.addEventListener("click", (e) => {
    if (e.target === searchModal) {
        searchModal.classList.add("hidden");
    }

       // === VOLVER A RESALTAR EL BOT√ìN DE IM√ÅGENES ===
        const videoBtn = document.getElementById("videoBtn");
        if (videoBtn) {
          document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('selected'));
          videoBtn.classList.add('selected');
        }
});

// B√∫squeda en tiempo real
searchInput.addEventListener("input", () => {
  const query = normalizeText(searchInput.value);
  searchResults.innerHTML = "";
  if (!query) return;

  const matches = getVideosForSearch()
    .filter(v => normalizeText(String(v.title || "")).includes(query));

  if (matches.length === 0) {
    const li = document.createElement("li");
    li.textContent = "No se encontraron resultados";
    li.style.color = "#aaa";
    li.style.fontStyle = "italic";
    searchResults.appendChild(li);
    return;
  }

  matches.forEach(({ title, id, embed }) => {
    const li = document.createElement("li");
    li.textContent = title;
    li.style.cursor = "pointer";
    li.style.padding = "10px 12px";
    li.style.borderBottom = "1px solid #333";

    li.addEventListener("mouseenter", () => (li.style.background = "#333"));
    li.addEventListener("mouseleave", () => (li.style.background = ""));

    li.addEventListener("click", () => {
      searchModal.classList.add("hidden");

      // ‚úÖ Navegar por ID (estable aunque se borren slides)
      const slides = Array.from(document.querySelectorAll("#slides .swiper-slide"));
      let target = slides.findIndex(s => String(s.dataset.videoid || "") === String(id));

      // fallback por embed si no encontr√≥ por ID
      if (target < 0 && embed) {
        target = slides.findIndex(s => (s.querySelector(".player-card")?.dataset.embed || "") === embed);
      }

      if (swiper && target >= 0) {
        swiper.slideTo(target, 600); // üëà IMPORTANTE: slideTo (no slideToLoop)
      }

      // Resaltar t√≠tulo al llegar
      setTimeout(() => {
        const titleEl = document.querySelector("#video-title-fixed .video-title");
        if (titleEl) {
          titleEl.classList.add("highlight-title-zoom");
          setTimeout(() => titleEl.classList.remove("highlight-title-zoom"), 1000);
        }
      }, 700);
    });

    searchResults.appendChild(li);
  });
});


        
     function activarSwipeParaBorrar() {
  let swipeInfo = null;

  commentsList.addEventListener('touchstart', (e) => {
    const commentElement = e.target.closest('li');
    if (!commentElement) return;
    const commentData = commentElement.dataset;

    if (normalizeText(commentData.correo) === normalizeText(currentAuthorEmail)) {
      startX = e.touches[0].clientX;
      activeComment = commentElement;
      activeComment.querySelector('.comment-content').style.transition = 'none';
      isSwiping = false;
    }
  });

  commentsList.addEventListener('touchmove', (e) => {
    if (!activeComment) return;
    const currentX = e.touches[0].clientX;
    const diffX = currentX - startX;

    if (Math.abs(diffX) > 10) isSwiping = true;

    const commentContent = activeComment.querySelector('.comment-content');
    const deleteBtnContainer = activeComment.querySelector('.delete-btn-container');

    if (diffX > 0) {
      commentContent.style.transform = `translateX(${diffX}px)`;
      if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(0)`;
    } else {
      commentContent.style.transform = `translateX(0)`;
      if (deleteBtnContainer) deleteBtnContainer.style.transform = `translateX(-100%)`;
    }
  });

  commentsList.addEventListener('touchend', (e) => {
    if (!activeComment) return;
    const swipeThreshold = 50;
    const diffX = e.changedTouches[0].clientX - startX;

    const commentContent = activeComment.querySelector('.comment-content');
    let deleteBtnContainer = activeComment.querySelector('.delete-btn-container');
    commentContent.style.transition = 'transform 0.3s ease';

    if (diffX > swipeThreshold) {
      // Mant√©n el bot√≥n visible y marca como swiped
      commentContent.classList.add('swiped');
      activeComment.classList.add('swiped');
      commentContent.style.transform = `translateX(100px)`;

      swipeInfo = {
        texto: activeComment.dataset.texto,
        correo: activeComment.dataset.correo
      };

      if (!deleteBtnContainer) {
        deleteBtnContainer = document.createElement('div');
        deleteBtnContainer.className = 'delete-btn-container visible';
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Borrar';
        deleteBtnContainer.appendChild(deleteBtn);
        activeComment.insertBefore(deleteBtnContainer, commentContent);

        deleteBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          eliminarComentario(getActiveVideoId(), activeComment.dataset.texto, activeComment.dataset.correo);
          // Quita el swipe tras borrar
          commentContent.classList.remove('swiped');
          activeComment.classList.remove('swiped');
          commentContent.style.transform = `translateX(0)`;
          deleteBtnContainer.classList.remove('visible');
          deleteBtnContainer.style.transform = `translateX(-100%)`;
          swipeInfo = null;
          activeComment = null;
        });
      } else {
        deleteBtnContainer.classList.add('visible');
        deleteBtnContainer.style.transform = `translateX(0)`;
      }
    } else {
      // Solo regresa si no fue swipe suficiente
      commentContent.classList.remove('swiped');
      activeComment.classList.remove('swiped');
      commentContent.style.transform = `translateX(0)`;
      if (deleteBtnContainer) {
        deleteBtnContainer.classList.remove('visible');
        deleteBtnContainer.style.transform = `translateX(-100%)`;
      }
      swipeInfo = null;
      activeComment = null;
    }
    startX = 0;
  });

  // === Oculta el bot√≥n Borrar al tocar fuera del comentario swiped ===
  document.addEventListener('touchstart', (e) => {
    // Si el target NO est√° dentro de un comentario swiped, quita el swipe
    const swiped = document.querySelector('li.swiped');
    const isDeleteBtn = e.target.classList.contains('delete-btn');
    if (swiped && !swiped.contains(e.target) && !isDeleteBtn) {
      const commentContent = swiped.querySelector('.comment-content');
      const deleteBtnContainer = swiped.querySelector('.delete-btn-container');
      if (commentContent) {
        commentContent.classList.remove('swiped');
        commentContent.style.transform = `translateX(0)`;
      }
      if (deleteBtnContainer) {
        deleteBtnContainer.classList.remove('visible');
        deleteBtnContainer.style.transform = `translateX(-100%)`;
      }
      swiped.classList.remove('swiped');
      swipeInfo = null;
      activeComment = null;
    }
  });

  // === Restaurar swipe tras renderComentarios ===
  // Debes modificar renderComentarios para incluir este fragmento al final:
  window.restoreSwipeAfterRender = function() {
    if (!swipeInfo) return;
    const commentsList = document.getElementById('commentsList');
    if (!commentsList) return;
    const lis = commentsList.querySelectorAll('li');
    lis.forEach(li => {
      if (
        normalizeText(li.dataset.correo) === normalizeText(swipeInfo.correo) &&
        li.dataset.texto === swipeInfo.texto
      ) {
        li.classList.add('swiped');
        const commentContent = li.querySelector('.comment-content');
        if (commentContent) {
          commentContent.classList.add('swiped');
          commentContent.style.transform = `translateX(100px)`;
        }
        const deleteBtnContainer = li.querySelector('.delete-btn-container');
        if (deleteBtnContainer) {
          deleteBtnContainer.classList.add('visible');
          deleteBtnContainer.style.transform = `translateX(0)`;
        }
      }
    });
  };
}

// === AUTO REFRESCO EN SEGUNDO PLANO ===
// === AUTO REFRESCO EN SEGUNDO PLANO (GARANTIZADO) ===
setInterval(() => cargarVideos(true), 3000);   // <- esto asegura sincronizaci√≥n en todos
cargarVideos(); // primera carga



         (function () {
    const params = new URLSearchParams(location.search);
    const isEmbedded = params.get("embed") === "1" || (window.self !== window.top);
    if (isEmbedded) document.body.classList.add("embedded");
  })();




// Guarda cu√°les estaban reproduci√©ndose para reanudarlos
let decomWasPlaying = [];        // keys de players YT que estaban PLAYING
let decomWasPlayingHtml5 = [];   // mezcla: keys de players HTML5 o elementos <video> del DOM

// Pausa TODO: YouTube + videos MP4
function decomPauseAllPlayers() {
  try {
    decomWasPlaying = [];
    decomWasPlayingHtml5 = [];

    // 1) Pausar lo que est√© registrado en "players"
    if (typeof players === "object" && players) {
      for (const key of Object.keys(players)) {
        const p = players[key];
        if (!p) continue;

        // YouTube Player
        if (typeof p.getPlayerState === "function") {
          let st;
          try { st = p.getPlayerState(); } catch (e) { st = null; }

          if (typeof YT !== "undefined" && YT.PlayerState && st === YT.PlayerState.PLAYING) {
            decomWasPlaying.push(key);
          }
          try { if (typeof p.pauseVideo === "function") p.pauseVideo(); } catch(e) {}
          continue;
        }

        // HTML5 <video> guardado en players
        if (typeof p.pause === "function") {
          const isPlaying = (typeof p.paused !== "undefined") ? !p.paused : false;
          if (isPlaying) decomWasPlayingHtml5.push(key);
          try { p.pause(); } catch(e) {}
        }
      }
    }

    // 2) Fallback: pausar cualquier <video> del DOM (por si no qued√≥ en players)
    document.querySelectorAll("video").forEach((v) => {
      try {
        const isPlaying = !v.paused;
        if (isPlaying) decomWasPlayingHtml5.push(v); // guardamos el elemento real
        v.pause();
      } catch(e) {}
    });

  } catch (e) {}
}

// Reanuda solo lo que estaba sonando
function decomResumePlayers() {
  try {
    // YouTube: reanudar solo los que estaban sonando
    if (decomWasPlaying && decomWasPlaying.length) {
      for (const key of decomWasPlaying) {
        const p = players?.[key];
        if (p && typeof p.playVideo === "function") {
          try { p.playVideo(); } catch(e) {}
        }
      }
    }

    // HTML5: reanudar solo los que estaban sonando (keys o <video>)
    if (decomWasPlayingHtml5 && decomWasPlayingHtml5.length) {
      for (const item of decomWasPlayingHtml5) {
        // Si es key en players
        if (typeof item === "string") {
          const p = players?.[item];
          if (p && typeof p.play === "function") {
            p.play().catch(()=>{});
          }
        }
        // Si es un <video> del DOM
        else if (item && typeof item.play === "function") {
          item.play().catch(()=>{});
        }
      }
    }

  } catch (e) {}
}

// ‚ñ∂Ô∏è Forzar reproducci√≥n del video ACTIVO (sin afectar prev/next)
function decomPlayActiveNow() {
  try {
    if (!swiper) return;

    const activeSlide = swiper.slides?.[swiper.activeIndex];
    const activeCard = activeSlide?.querySelector?.('.player-card');
    if (!activeCard) return;

    const src = activeCard.dataset?.embed;
    if (!src) return;

    // Si a√∫n no est√° montado, montarlo con autoplay=true
    if (!activeCard.querySelector("iframe") && !activeCard.querySelector("video")) {
      mountIframe(activeCard, true);
      return;
    }

    // Si ya est√° montado, reproducirlo
    const player = players?.[src];
    if (player) {
      if (typeof player.playVideo === "function") {
        try { player.playVideo(); } catch (e) {}
      } else if (typeof player.play === "function") {
        player.play().catch(()=>{});
      }
    }

    // Actualizar bot√≥n central a "pause" y ocultarlo
    const centerBtn = activeCard.querySelector('.center-play-pause-btn');
    if (centerBtn) {
      centerBtn.innerHTML = '<i class="fas fa-pause"></i>';
      centerBtn.style.opacity = 0;
    }
  } catch (e) {}
}

window.addEventListener("message", (e) => {
  const t = e?.data?.type;

  // Perfil (lo que ya ten√≠as)
  if (t === "DECOM_OPEN_PROFILE_MODAL") {
    if (typeof abrirPerfil === "function") abrirPerfil();
    else {
      const modal = document.getElementById("modalPerfil");
      if (modal) modal.style.display = "flex";
    }
    return;
  }

  // cuando el feed oculta Videos
  if (t === "DECOM_HIDE_VIDEOS") {
    decomPauseAllPlayers();
    return;
  }

  // cuando el feed vuelve a mostrar Videos
  if (t === "DECOM_SHOW_VIDEOS") {
    // desmutear al volver a ver videos
    try {
      document.querySelectorAll("video").forEach(v => { v.muted = false; v.volume = 1; });
    } catch(e){}
    try {
      if (typeof players === "object" && players) {
        for (const k of Object.keys(players)) {
          const p = players[k];
          if (p && typeof p.unMute === "function") p.unMute();
        }
      }
    } catch(e){}

    // ‚úÖ Mantiene tu l√≥gica: reanudar solo lo que estaba sonando
    decomResumePlayers();

    // ‚úÖ NUEVO: al entrar a "Videos", asegurar que el ACTIVO se reproduzca
    setTimeout(() => {
      decomPlayActiveNow();
    }, 80);

    return;
  }
});


// ‚úÖ ARRANQUE EN SILENCIO cuando est√° embebido en feed (embed=1)
// Evita que cualquier autoplay suene antes de que existan players/videos.
(function(){
  const params = new URLSearchParams(location.search);
  const isEmbedded = params.get("embed") === "1" || (window.self !== window.top);
  if (!isEmbedded) return;

  // 1) Mutear todo inmediatamente (aunque todav√≠a no haya players)
  function hardMuteNow(){
    try {
      // Mutea videos HTML5 existentes
      document.querySelectorAll("video").forEach(v => { v.muted = true; v.volume = 0; });
    } catch(e){}
    try {
      // Si ya existen players (YT), los mutea
      if (typeof players === "object" && players) {
        for (const k of Object.keys(players)) {
          const p = players[k];
          if (p && typeof p.mute === "function") p.mute();
        }
      }
    } catch(e){}
  }

  // 2) Pausar cuando ya est√©n montados (reintentos cortos)
  let tries = 0;
  const timer = setInterval(() => {
    tries++;
    hardMuteNow();
    decomPauseAllPlayers();

    // despu√©s de ~2.5s dejamos de insistir (ya deber√≠an estar montados)
    if (tries >= 10) clearInterval(timer);
  }, 250);

  // 3) Al terminar de cargar DOM, hacemos un pause extra
  window.addEventListener("load", () => {
    hardMuteNow();
    setTimeout(() => {
      hardMuteNow();
      decomPauseAllPlayers();
    }, 300);
  });
})();

// =========================================================
// Recibe √≥rdenes desde el FEED (iframe) - sin afectar nada m√°s
// =========================================================
window.addEventListener("message", (event) => {
  const data = event.data || {};
  if (!data.type) return;

  // Abrir men√∫ lateral de usuario (el nuevo dise√±o)
  if (data.type === "DECOM_OPEN_USER_MENU") {
    const userMenu = document.getElementById("userMenu");
    if (userMenu) userMenu.style.display = "block";
    return;
  }

  // (Opcional) si a√∫n quieres soportar el mensaje antiguo de abrir perfil
  if (data.type === "DECOM_OPEN_PROFILE_MODAL") {
    if (typeof abrirPerfil === "function") abrirPerfil();
    return;
  }

  // Pausar/reanudar (si ya lo tienes, no pasa nada; esto no rompe)
  if (data.type === "DECOM_HIDE_VIDEOS") {
    try {
      document.querySelectorAll("video").forEach(v => { v.pause(); v.currentTime = v.currentTime; });
    } catch(e){}
    return;
  }
  if (data.type === "DECOM_SHOW_VIDEOS") {
    // no forzamos play (solo dejas que el usuario reproduzca)
    return;
  }
});


/* =========================================================
   üîÑ SYNC INSTANT√ÅNEO DE SESI√ìN ENTRE FOTOS ‚Üî VIDEOS (IFRAMES)
   - Sin recargar
   - No afecta nada m√°s
========================================================= */
(function initDecomAuthSync() {
  const OVERLAY_ID = "decomAuthOverlay";
  const AUTH_KEYS = new Set(["usuario", "autor", "correo", "fotoPerfil"]);

  // Fallback extra (por si alg√∫n navegador no dispara storage bien en iframes)
  const bc = ("BroadcastChannel" in window) ? new BroadcastChannel("decom-auth") : null;

  function safeUser() {
    try { return JSON.parse(localStorage.getItem("usuario") || "null"); }
    catch { return null; }
  }

  function getInitials(name) {
    const n = (name || "Usuario").trim();
    const ini = n.split(" ").filter(Boolean).map(w => w[0]).join("").slice(0, 2).toUpperCase();
    return ini || "U";
  }

  function removeOverlay() {
    const old = document.getElementById(OVERLAY_ID);
    if (old) old.remove();
  }

  function ensureOverlay(modal) {
    let overlay = document.getElementById(OVERLAY_ID);
    if (overlay) return overlay;

    overlay = document.createElement("div");
    overlay.id = OVERLAY_ID;

    Object.assign(overlay.style, {
      position: "fixed",
      top: "0",
      left: "0",
      width: "100%",
      height: "100%",
      background: "linear-gradient(180deg, #000, #222)",
      color: "white",
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      justifyContent: "center",
      zIndex: "99998",
      fontFamily: "Poppins, sans-serif",
      textAlign: "center",
      opacity: "0",
      transition: "opacity 0.4s ease",
    });

    overlay.innerHTML = `
      <h2 style="margin-bottom:12px; font-size:22px;">üîí Acceso restringido</h2>
      <p style="color:#ccc; max-width:80%; line-height:1.5;">
        Debes iniciar sesi√≥n para acceder al contenido.
      </p>
    `;

    document.body.appendChild(overlay);
    if (modal) {
      modal.style.display = "flex";
      modal.style.zIndex = "99999";
    }
    setTimeout(() => (overlay.style.opacity = "1"), 50);

    return overlay;
  }

  function updateUserUI(u) {
    // Si tu archivo ya tiene mostrarUsuario(), lo usamos (NO rompe nada)
    if (typeof window.mostrarUsuario === "function") {
      try { window.mostrarUsuario(u); } catch (e) {}
      return;
    }

    // Fallback m√≠nimo (por si un archivo no tiene mostrarUsuario)
    const userBtn = document.getElementById("userBtn");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const userMenuPhoto = document.getElementById("userMenuPhoto");

    const fotoSrc = (localStorage.getItem("fotoPerfil") || u?.fotoPerfil || "").trim();
    const initials = getInitials(u?.nombre);

    if (userBtn) {
      if (fotoSrc) {
        userBtn.innerHTML = `<img src="${fotoSrc}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0077cc;">`;
      } else {
        userBtn.textContent = initials;
      }
    }

    if (userName) userName.textContent = u?.nombre || "Usuario";
    if (userEmail) userEmail.textContent = u?.correo || "";

    if (userMenuPhoto) {
      if (fotoSrc) {
        userMenuPhoto.innerHTML = `<img src="${fotoSrc}" style="width:100%;height:100%;object-fit:cover;">`;
      } else {
        userMenuPhoto.innerHTML = "";
        userMenuPhoto.textContent = initials;
      }
    }
  }

  function applyAuthUI() {
    const u = safeUser();
    const modal = document.getElementById("loginModal");

    if (!u) {
      ensureOverlay(modal);
      // si hab√≠a men√∫ abierto, lo cerramos (seguro)
      const menu = document.getElementById("userMenu");
      if (menu) menu.style.display = "none";
      return;
    }

    // ‚úÖ hay sesi√≥n
    removeOverlay();
    if (modal) modal.style.display = "none";
    updateUserUI(u);
  }

  function pingOthers() {
    // BroadcastChannel
    try { if (bc) bc.postMessage({ type: "AUTH_CHANGED", ts: Date.now() }); } catch(e){}
    // storage (touch) ‚Äî opcional, pero ayuda en algunos casos raros
    try { localStorage.setItem("__decom_auth_ping__", String(Date.now())); } catch(e){}
  }

  // üîî Escucha cambios de storage (cuando el otro iframe hace setItem/removeItem)
  window.addEventListener("storage", (e) => {
    if (!e.key || AUTH_KEYS.has(e.key) || e.key === "__decom_auth_ping__") {
      applyAuthUI();
    }
  });

  // üîî Escucha broadcast directo (fallback)
  if (bc) {
    bc.onmessage = () => applyAuthUI();
  }

  // ‚úÖ correr al inicio
  applyAuthUI();

  // ‚úÖ expone helpers (para llamar desde login/logout SIN romper flujo)
  window.DEComAuthApply = applyAuthUI;
  window.DEComAuthPing = pingOthers;
})();


(function () {
  const isEmbed = new URLSearchParams(location.search).get("embed") === "1";
  if (!isEmbed) return;

  // Mant√©n lo que ya hac√≠as
  document.documentElement.classList.add("embed");

  // ‚úÖ Esto es lo que faltaba para que funcione con tu CSS actual
  // (y para que nunca aparezca el header dentro del iframe)
  if (document.body) document.body.classList.add("embedded");
  else window.addEventListener("DOMContentLoaded", () => document.body.classList.add("embedded"), { once: true });
})();


        
    </script>
</body>
</html>












